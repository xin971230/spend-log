<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æ”¶æ”¯å¿«è¨˜ï½œè¡Œå‹•ç‰ˆ</title>
<style>
  /* ===== Reset & Theme ===== */
  *, *::before, *::after { box-sizing: border-box; }
  :root{
    --bg:#0a0f1e; --panel:#12182b; --panel-2:#0e1528;
    --text:#eef3fb; --muted:#9fb0c9; --line:#253354; --brand:#3b82f6;
    --ok:#86efac; --bad:#fca5a5; --warn:#f59e0b;
    --radius:16px; --radius-sm:12px; --shadow:0 10px 30px rgba(0,0,0,.35);
    --safe-bottom: env(safe-area-inset-bottom, 12px);
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f4f7fb; --panel:#ffffff; --panel-2:#f8fafc; --text:#0b1324; --muted:#63708a; --line:#e5e9f2; --shadow:0 8px 24px rgba(0,10,40,.08); }
    .tab.active{ color:#fff }
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 50% -200px, rgba(59,130,246,.18), transparent 60%),
      linear-gradient(180deg,var(--bg) 0%, #0b1226 80%);
  }
  .container{max-width:900px;margin:auto;padding:16px 14px 96px}

  /* ===== Top bar (title) ===== */
  .topbar{
    position:sticky; top:0; z-index:40;
    background:linear-gradient(180deg, rgba(10,15,30,.85), rgba(10,15,30,.55));
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
    padding:10px 14px;
  }
  .topbar h1{margin:0;font-size:18px;letter-spacing:.5px;opacity:.95}

  /* ===== Bottom Tabs (mobile thumb reach) ===== */
  .tabs{
    position:fixed; left:0; right:0; bottom:0; z-index:50;
    background:rgba(12,16,30,.88); backdrop-filter: blur(8px);
    border-top:1px solid var(--line);
    padding:8px 10px calc(6px + var(--safe-bottom));
  }
  .tabbar{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; max-width:900px; margin:auto}
  .tab{
    display:flex; flex-direction:column; gap:2px; align-items:center; justify-content:center;
    padding:10px 8px; border-radius:12px; text-decoration:none; border:1px solid transparent;
    color:var(--muted); font-weight:600; font-size:12px; line-height:1.2; transition:.2s;
  }
  .tab .ico{font-size:18px}
  .tab:active{transform:scale(.98)}
  .tab.active{
    color:#fff; background:linear-gradient(180deg,rgba(59,130,246,.28),rgba(59,130,246,.18));
    border-color:#2b4ea3;
    box-shadow: inset 0 0 0 1px rgba(59,130,246,.35);
  }

  /* ===== Cards / Sections ===== */
  section[hidden]{display:none}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); padding:16px; margin:14px 0; box-shadow:var(--shadow)}
  .card h1{font-size:18px;margin:0 0 10px}
  .muted{color:var(--muted);font-size:12px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}

  /* ===== Forms ===== */
  label{font-size:13px;display:block;margin:8px 0 6px}
  input,select{
    width:100%; padding:13px 12px; border-radius:12px; border:1px solid var(--line);
    background:var(--panel-2); color:var(--text); font-size:16px;
  }
  .row{display:grid; grid-template-columns:1fr; gap:10px}
  @media (min-width: 640px){ .row{ grid-template-columns:1fr 1fr } }
  .inline{display:flex; gap:10px; align-items:center}
  .inline > *{flex:1}
  .rowbtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .btn{
    flex:1 1 auto; display:inline-flex; justify-content:center; align-items:center; gap:8px;
    padding:13px 16px; border:none; border-radius:14px; background:var(--brand); color:#fff;
    font-weight:800; font-size:16px; letter-spacing:.3px; cursor:pointer; box-shadow:var(--shadow);
  }
  .btn.secondary{ background:linear-gradient(180deg,#41506f,#31415f) }
  .btn:active{ transform: translateY(1px) }

  /* Nice switch for transfer */
  .switch{display:flex; align-items:center; gap:10px; margin:8px 0 4px}
  .toggle{
    appearance:none; width:48px; height:28px; border-radius:28px; position:relative; outline:none;
    background:#2a3552; border:1px solid var(--line); transition:.2s;
  }
  .toggle::after{
    content:""; position:absolute; width:22px; height:22px; top:2px; left:2px; border-radius:50%;
    background:#fff; transition:.2s; box-shadow:0 2px 6px rgba(0,0,0,.3);
  }
  .toggle:checked{ background:#3066d3; }
  .toggle:checked::after{ transform:translateX(20px); }

  /* ===== Local Log ===== */
  .log{max-height:360px; overflow:auto; border:1px solid var(--line); border-radius:14px; background:var(--panel-2)}
  .log table{width:100%; border-collapse:collapse; font-size:14px}
  .log th,.log td{padding:10px; border-bottom:1px solid var(--line); text-align:left}
  .neg{color:var(--bad)} .pos{color:var(--ok)}

  /* ===== Recent list ===== */
  .list{display:grid; gap:10px; margin-top:8px}
  .list-item{
    background:linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid var(--line); border-radius:14px; padding:12px;
  }
  .list-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px}
  .list-amt{font-weight:900; font-size:20px}
  .list-amt.neg{color:var(--bad)} .list-amt.pos{color:var(--ok)}
  .chip{display:inline-block; padding:4px 8px; font-size:11px; border-radius:999px; border:1px solid var(--line); color:var(--muted); margin-right:6px}
  .list-meta{color:var(--muted); font-size:12px}
  .list-body{margin-top:6px; font-size:15px}
  .clamp2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

  /* ===== Table (Balance) ===== */
  .table{width:100%; border-collapse:collapse; margin-top:8px; background:var(--panel-2); border-radius:12px; overflow:hidden}
  .table th,.table td{padding:12px; border-bottom:1px solid var(--line); text-align:left}
  .right{text-align:right}

  /* ===== Toast ===== */
  .toast{
    position:fixed; bottom:calc(64px + var(--safe-bottom)); left:50%; transform:translateX(-50%);
    background:var(--panel-2); color:var(--text); border:1px solid var(--line);
    padding:10px 12px; border-radius:12px; display:none; box-shadow:var(--shadow); z-index:60
  }
  .toast.show{display:block}

  /* ===== Helpers ===== */
  .spacer{height:10px}
</style>
</head>
<body>

<!-- Sticky top title (small, not occupying space) -->
<div class="topbar"><h1>æ”¶æ”¯å¿«è¨˜</h1></div>

<div class="container">
  <!-- è¨˜å¸³ -->
  <section data-view="home">
    <div class="card">
      <h1>æ–°å¢è¨˜å¸³</h1>
      <form id="form" autocomplete="off" style="margin-top:6px">
        <div class="row">
          <div>
            <label>æ—¥æœŸ</label><input type="date" id="date" required>
          </div>
          <div>
            <label>ç™»è¨˜äºº</label>
            <select id="owner"><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>æ–¹å‘</label>
            <select id="direction"><option>æ”¯å‡º</option><option>æ”¶å…¥</option></select>
          </div>
          <div>
            <label>é‡‘é¡</label><input type="number" id="amount" min="0.01" step="0.01" inputmode="decimal" required>
          </div>
        </div>

        <div class="row">
          <div>
            <label>åˆ†é¡</label>
            <select id="category">
              <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
              <option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option>
              <option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option>
            </select>
          </div>
          <div>
            <label>å¸³æˆ¶ï¼ˆè½‰å‡ºå¸³æˆ¶ï¼‰</label>
            <select id="account">
              <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
              <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
              <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
              <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
            </select>
          </div>
        </div>

        <label>é …ç›®</label>
        <div class="inline">
          <select id="itemSelect">
            <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
            <option value="é£Ÿç‰©">é£Ÿç‰©</option><option value="å…¬å¸ä»£å¢Š">å…¬å¸ä»£å¢Š</option>
            <option value="ç©æ¨‚">ç©æ¨‚</option><option value="äº¤é€š">äº¤é€š</option>
            <option value="å…¶ä»–">å…¶ä»–ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
          </select>
          <input id="itemOther" placeholder="è¼¸å…¥å…¶ä»–é …ç›®" style="display:none">
        </div>

        <label>å‚™è¨»</label><input id="note" placeholder="">

        <!-- äº’è½‰ï¼ˆåŒä¸€è¡Œã€æ»‘å‹•é–‹é—œï¼‰ -->
        <div class="switch">
          <input type="checkbox" id="isTransfer" class="toggle">
          <label for="isTransfer" style="margin:0;font-weight:700">äº’è½‰</label>
        </div>
        <div id="transferFields" style="display:none;">
          <label>è½‰å…¥å¸³æˆ¶</label>
          <select id="accountIn">
            <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
            <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
            <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
            <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
          </select>
        </div>

        <div class="rowbtns">
          <button class="btn" type="submit">é€å‡º</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h1>æœ¬æ©Ÿç™¼é€ç´€éŒ„</h1>
      <div class="rowbtns">
        <button class="btn secondary" id="btnExport" type="button">åŒ¯å‡º CSV</button>
        <button class="btn secondary" id="btnClear" type="button">æ¸…é™¤ç´€éŒ„</button>
      </div>
      <p class="muted">åƒ…å„²å­˜åœ¨æ­¤è£ç½®ï¼ˆæœ¬æ©Ÿï¼‰ï¼Œæœ€å¤šä¿ç•™ 50 ç­†ã€‚</p>
      <div class="log" id="log"></div>
    </div>
  </section>

  <!-- æœ€æ–° -->
  <section data-view="recent" hidden>
    <div class="card">
      <h1>æœ€æ–° N ç­†ï¼ˆé›²ç«¯ï¼‰</h1>
      <div class="inline">
        <input type="number" id="rLimit" value="5" min="1" max="50" style="max-width:120px" />
        <select id="rAccount">
          <option value="">å…¨éƒ¨å¸³æˆ¶</option>
          <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
          <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
          <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
        </select>
      </div>
      <div class="inline" style="margin-top:8px">
        <select id="rCategory">
          <option value="">å…¨éƒ¨åˆ†é¡</option>
          <option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option>
          <option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option>
        </select>
        <select id="rOwner"><option value="">å…¨éƒ¨ç™»è¨˜äºº</option><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
      </div>
      <div class="rowbtns"><button class="btn secondary" id="btnRecent" type="button">æŸ¥è©¢æœ€æ–°ç´€éŒ„</button></div>
      <p class="muted mono" id="recentHint">â€”</p>
      <div class="list" id="recentList" style="display:none"></div>
    </div>
  </section>

  <!-- é¤˜é¡ -->
  <section data-view="balance" hidden>
    <div class="card">
      <h1>é¤˜é¡æŸ¥è©¢</h1>
      <div class="inline">
        <input id="qMonth" placeholder="æœˆä»½ï¼ˆyyyy-MMï¼Œå¯ç•™ç©ºï¼‰">
        <select id="qOwner"><option value="">ï¼ˆå…¨éƒ¨ï¼‰</option><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
      </div>
      <div class="rowbtns"><button class="btn secondary" id="btnBalance" type="button">æŸ¥è©¢å„å¸³æˆ¶é¤˜é¡</button></div>
      <div id="balanceArea">
        <p class="muted mono" id="balanceResult">â€”</p>
        <table class="table" id="balanceTable" style="display:none">
          <thead><tr><th>å¸³æˆ¶</th><th class="right">é¤˜é¡</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><th>ç¸½è¨ˆ</th><th class="right" id="balanceTotal">0.00</th></tr></tfoot>
        </table>
      </div>
    </div>
  </section>

  <!-- è¨­å®š -->
  <section data-view="settings" hidden>
    <div class="card">
      <h1>è¨­å®š</h1>
      <label>Endpoint URL</label>
      <input id="endpoint" value="https://script.google.com/macros/s/AKfycbzjpwoEGtRpX9FnQ0i-rSjvgaUB40gG44tBAcd_tI30R1X9HydICtdlSiooJXViatJZ/exec">
      <label>API Keyï¼ˆå¯ç•™ç©ºï¼‰</label><input id="apiKey">
      <div class="rowbtns">
        <button class="btn secondary" id="btnTest" type="button">é€£ç·šæ¸¬è©¦</button>
        <button class="btn secondary" id="btnSaveCfg" type="button">å„²å­˜è¨­å®š</button>
      </div>
      <p class="muted mono" id="cfgHint"></p>
    </div>

    <div class="card">
      <h1>å¤–é€å¸³å–®åŒ¯å…¥</h1>
      <div class="inline">
        <input id="importDays" type="number" min="1" max="90" value="10" placeholder="æœ€è¿‘ N å¤©ï¼ˆé è¨­ 10ï¼‰">
        <button class="btn secondary" id="btnImport" type="button">æŠ“å–å¤–é€å¸³å–®</button>
      </div>
      <p class="muted">è§£æ Gmailï¼ˆfoodpanda / Uber Eatsï¼‰ï¼Œä¸é‡è¤‡å¯«å…¥ã€Šæ˜ç´°ã€‹ï¼ˆä»¥ messageId å»é‡ï¼›åˆªé™¤å¾Œå¯é‡æŠ“ï¼‰ã€‚</p>
      <p class="muted mono" id="importHint">â€”</p>
    </div>
  </section>
</div>

<!-- Bottom tabs -->
<nav class="tabs" role="tablist" aria-label="é ç±¤">
  <div class="tabbar">
    <a class="tab" href="#home"><span class="ico">ğŸ§¾</span>è¨˜å¸³</a>
    <a class="tab" href="#recent"><span class="ico">ğŸ•’</span>æœ€æ–°</a>
    <a class="tab" href="#balance"><span class="ico">ğŸ“Š</span>é¤˜é¡</a>
    <a class="tab" href="#settings"><span class="ico">âš™ï¸</span>è¨­å®š</a>
  </div>
</nav>

<div id="toast" class="toast"></div>

<script>
/* Router */
function showView(name){
  document.querySelectorAll('section[data-view]').forEach(sec=>sec.hidden = sec.dataset.view !== name);
  document.querySelectorAll('.tabbar .tab').forEach(a=>a.classList.toggle('active', a.getAttribute('href') === '#'+name));
}
function route(){ const name=(location.hash||'#home').slice(1); showView(['home','recent','balance','settings'].includes(name)?name:'home'); }
window.addEventListener('hashchange', route);

/* Utils */
const $ = id => document.getElementById(id);
const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); };
function cssEscape(s){ return String(s).replace(/[^a-zA-Z0-9_\-:.]/g,'_'); }

/* å¸¸é‡ */
const ACCOUNTS = ['é»ƒç¾é‡‘','åˆ·å¡','è•­ç¾é‡‘','åˆä½œé‡‘åº«','è•­éƒµå±€','è¯å—éŠ€è¡Œ','é»ƒéƒµå±€','è•­LINE','å½°åŒ–éŠ€è¡Œ','é»ƒä¸­ä¿¡','é»ƒLINE','åœ‹æ³°ä¸–è¯'];
const CATEGORIES = ['å…±ç”¨','é»ƒæ”¯å‡º','è•­æ”¯å‡º','æ´‹æ”¯å‡º','ä¿¡ç”¨å¡','æ”¶å…¥','è² å‚µ','å¹³è¡¡','å…¬å¸ä»£å¢Š','å…¶ä»–'];
const ITEM_OPTIONS = ['é£Ÿç‰©','å…¬å¸ä»£å¢Š','ç©æ¨‚','äº¤é€š','å…¶ä»–'];
const OWNERS = ['æ¬£å®œ','å–¬çŒ·'];

/* åˆå§‹ */
(function init(){
  $('date').value = new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
  fetch($('endpoint').value.trim() + '?ping=1').catch(()=>{});
  loadCfg(); renderLog(); route();
})();

/* è¨˜å¸³ï¼šé …ç›®å…¶ä»– */
const itemSelect = $('itemSelect'), itemOther = $('itemOther');
itemSelect.onchange = ()=>{ if(itemSelect.value==='å…¶ä»–'){ itemOther.style.display='block'; itemOther.focus(); } else { itemOther.style.display='none'; itemOther.value=''; } };

/* è¨˜å¸³ï¼šäº’è½‰åˆ‡æ›ï¼ˆæ»‘å‹•é–‹é—œï¼Œé‚è¼¯ä¸è®Šï¼‰ */
$('isTransfer').onchange = ()=>{
  const on = $('isTransfer').checked;
  $('transferFields').style.display = on ? 'block' : 'none';
  if (on){
    $('category').value='å¹³è¡¡'; $('category').disabled=true;
    itemSelect.value='å…¶ä»–'; itemOther.style.display='block'; itemOther.value='å…§æ§äº’è½‰';
  } else {
    $('category').disabled=false;
    if(itemSelect.value==='å…¶ä»–' && itemOther.value==='å…§æ§äº’è½‰'){ itemOther.value=''; itemOther.style.display='none'; }
  }
};

/* æœ¬æ©Ÿç™¼é€ç´€éŒ„ */
const SENT_KEY='spend.sent.v18';
function loadSent(){ try{return JSON.parse(localStorage.getItem(SENT_KEY)||'[]');}catch{return[];} }
function saveSent(list){ localStorage.setItem(SENT_KEY, JSON.stringify(list.slice(-50))); }
function addSent(rec){ const list=loadSent(); list.push(rec); saveSent(list); }
function renderLog(){
  const list=loadSent().slice().reverse();
  if(!list.length){ $('log').innerHTML='<div class="muted" style="padding:12px">å°šç„¡ç´€éŒ„</div>'; return; }
  let html='<table><thead><tr><th>æ™‚é–“</th><th>æ–¹å‘/é‡‘é¡</th><th>åˆ†é¡/å¸³æˆ¶</th><th>é …ç›®/å‚™è¨»</th><th>ç™»è¨˜äºº</th></tr></thead><tbody>';
  for(const r of list){
    const isOut=r.direction==='æ”¯å‡º'; const amt=Math.abs(Number(r.amount||0));
    html+=`<tr><td class="muted">${r.ts||''}</td><td class="${isOut?'neg':'pos'}">${r.direction} ${isOut?'-':''}${amt.toFixed(2)}</td>
      <td>${r.category||''}ï½œ${r.account||''}</td><td>${r.item||''}ï½œ${r.note||''}</td><td>${r.owner||''}</td></tr>`;
  }
  html+='</tbody></table>'; $('log').innerHTML=html;
}
$('btnExport').onclick=()=>{
  const list=loadSent(); const header=['æ—¥æœŸ','æ™‚é–“æˆ³','æ–¹å‘','é‡‘é¡','åˆ†é¡','å¸³æˆ¶','é …ç›®','å‚™è¨»','ç™»è¨˜äºº'];
  const rows=[header.join(',')];
  const esc=s=>{if(s==null)return'';const t=String(s).replace(/"/g,'""');return /[",\n]/.test(t)?`"${t}"`:t;}
  for(const r of list){ rows.push([r.date||'',r.ts||'',r.direction||'',r.amount||'',r.category||'',r.account||'',r.item||'',r.note||'',r.owner||''].map(esc).join(',')); }
  const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'}),url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='spend-log.csv'; a.click(); URL.revokeObjectURL(url);
};
$('btnClear').onclick=()=>{ if(confirm('æ¸…é™¤æœ¬æ©Ÿç™¼é€ç´€éŒ„ï¼Ÿ')){ localStorage.removeItem(SENT_KEY); renderLog(); } };

/* èƒŒæ™¯é€å‡º */
function backgroundSend(url, payloadObj){
  const body=new URLSearchParams(payloadObj).toString();
  const mime='application/x-www-form-urlencoded;charset=UTF-8';
  if(navigator.sendBeacon){ navigator.sendBeacon(url,new Blob([body],{type:mime})); }
  else{ fetch(url,{method:'POST',headers:{'Content-Type':mime},body,keepalive:true}).catch(()=>{}); }
}

/* æ–°å¢é€å‡º */
$('form').onsubmit=(e)=>{
  e.preventDefault();
  const date=$('date').value, owner=$('owner').value, direction=$('direction').value, amount=$('amount').value, isXfer=$('isTransfer').checked;
  const category=isXfer?'å¹³è¡¡':$('category').value;
  const account=$('account').value;
  const item=isXfer?'å…§æ§äº’è½‰':((itemSelect.value==='å…¶ä»–')?$('itemOther').value.trim():itemSelect.value);
  const note=$('note').value.trim();
  const accountIn=$('accountIn').value;
  if(!date||!amount||Number(amount)<=0){ toast('è«‹è¼¸å…¥æ—¥æœŸèˆ‡é‡‘é¡'); return; }
  if(!category){ toast('è«‹é¸æ“‡åˆ†é¡'); return; }
  if(!account){ toast('è«‹é¸æ“‡å¸³æˆ¶'); return; }
  if(!item){ toast('è«‹é¸æ“‡æˆ–è¼¸å…¥é …ç›®'); return; }
  if(isXfer&&!accountIn){ toast('è«‹é¸æ“‡è½‰å…¥å¸³æˆ¶'); return; }

  const endpoint=$('endpoint').value.trim(); const apiKey=$('apiKey').value.trim();
  const d=new Date(); const pad=n=>String(n).padStart(2,'0'); const ts=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  const norm=s=>s.replace(/^åˆä½œ$/,'åˆä½œé‡‘åº«').replace(/^è•­è³´$/,'è•­LINE');

  if(isXfer){
    addSent({ts,date,owner,direction:'æ”¯å‡º',amount:Number(amount),category,account:norm(account),item,note});
    addSent({ts,date,owner,direction:'æ”¶å…¥',amount:Number(amount),category,account:norm(accountIn),item,note});
  }else{
    addSent({ts,date,owner,direction,amount:Number(amount),category,account:norm(account),item,note});
  }
  renderLog();
  $('amount').value=''; $('itemOther').value=''; $('note').value='';
  if(isXfer){ $('isTransfer').checked=false; $('transferFields').style.display='none'; $('category').disabled=false; }
  toast(isXfer?'å·²é€å‡ºï¼ˆèƒŒæ™¯è™•ç†ï¼šäº’è½‰Ã—2ï¼‰':'å·²é€å‡ºï¼ˆèƒŒæ™¯è™•ç†ï¼‰');

  const payload={ date, owner, amount, category, account:norm(account), item, note, apiKey };
  if(isXfer){ payload.isTransfer='true'; payload.accountIn=norm(accountIn); } else { payload.direction=direction; }
  backgroundSend(endpoint,payload);
};

/* æœ€æ–°ï¼šæŸ¥è©¢èˆ‡æ¸²æŸ“ï¼ˆå…è¨±åˆªæ”¹ï¼šæ‰€æœ‰ä¾†æºï¼‰ */
$('btnRecent').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆè¨­å®š Endpoint'); return; }
  const limit=Math.max(1,Math.min(50,Number($('rLimit').value)||5));
  const params=new URLSearchParams({recent:String(limit)});
  const acc=$('rAccount').value.trim(), cat=$('rCategory').value.trim(), own=$('rOwner').value.trim();
  if(acc)params.set('account',acc); if(cat)params.set('category',cat); if(own)params.set('owner',own);
  $('recentHint').textContent='æŸ¥è©¢ä¸­â€¦'; $('recentList').style.display='none';
  try{
    const res=await fetch(`${endpoint}?${params.toString()}`); if(!res.ok) throw 0;
    const data=await res.json(); if(!data.ok||!Array.isArray(data.records)) throw 0;
    renderRecent(data.records); $('recentHint').textContent=`é¡¯ç¤ºæœ€è¿‘ ${Math.min(data.records.length,limit)} ç­†`; $('recentList').style.display='';
  }catch{ $('recentHint').textContent='æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Endpoint/æ¬Šé™'; }
};

function makeOptions(list, selected, includeEmpty=true, emptyLabel='ï¼ˆä¸æ›´æ”¹ï¼‰'){
  const opts=[]; if(includeEmpty)opts.push(`<option value="">${emptyLabel}</option>`);
  for(const v of list){ opts.push(`<option value="${v}"${v===selected?' selected':''}>${v}</option>`); }
  return opts.join('');
}

function renderRecent(records){
  const listEl=$('recentList');
  listEl.innerHTML=records.map((r)=>{
    const amtRaw=Number(r.amount||0), isOut=(r.direction==='æ”¯å‡º'); const amt=Math.abs(amtRaw);
    const cls=isOut?'neg':'pos';
    const meta=`<span class="chip">${r.category||'æœªåˆ†é¡'}</span><span class="chip">${r.account||'æœªæŒ‡å®šå¸³æˆ¶'}</span><span class="chip">${r.owner||''}</span><span class="chip">${r.source||''}</span>`;
    const text=`${r.item||''}${r.note?`ï½œ${r.note}`:''}`;
    const rawKey = r.createdAt || r.date || '';  // åŸå§‹ createdAtï¼ˆçµ¦å¾Œç«¯ï¼‰
    const escKey = cssEscape(rawKey);
    const isTransferRow=(r.category==='å¹³è¡¡' && r.item==='å…§æ§äº’è½‰');
    const itemInList=ITEM_OPTIONS.includes(r.item||'');
    const itemSelValue=itemInList?(r.item||''):'å…¶ä»–';
    const itemOtherValue=itemInList?'':(r.item||'');

    return `<div class="list-item" data-key="${rawKey}">
      <div class="list-head">
        <div class="list-amt ${cls}">${isOut?'-':''}${amt.toFixed(2)}</div>
        <div class="list-meta">${rawKey}</div>
      </div>
      <div class="list-meta" style="margin-bottom:4px">${meta}</div>
      <div class="list-body clamp2">${text}</div>
      <div class="rowbtns" style="margin-top:10px">
        <button class="btn secondary" type="button" onclick="toggleEdit('${rawKey}')">âœï¸ ç·¨è¼¯</button>
        <button class="btn secondary" type="button" onclick="askDelete('${rawKey}')">ğŸ—‘ åˆªé™¤</button>
      </div>
      <form class="editbox" id="edit-${escKey}" style="display:none;margin-top:8px">
        <div class="inline">
          <input name="amount" id="amt-${escKey}" type="number" step="0.01" placeholder="é‡‘é¡ï¼ˆå¿…å¡«ï¼‰" value="${amt||''}">
          <input name="note"   id="note-${escKey}" placeholder="å‚™è¨»" value="${r.note||''}">
        </div>
        <div class="inline" style="margin-top:8px">
          <select name="account" id="acc-${escKey}">${makeOptions(ACCOUNTS, r.account, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}</select>
          <select name="item" id="itemSel-${escKey}" onchange="editItemChanged('${rawKey}')">
            ${makeOptions(ITEM_OPTIONS, itemSelValue, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}
          </select>
        </div>
        <input id="itemOther-${escKey}" placeholder="è¼¸å…¥å…¶ä»–é …ç›®" style="margin-top:8px;${itemSelValue==='å…¶ä»–'?'':'display:none;'}" value="${itemOtherValue}">
        <div class="inline" style="margin-top:8px">
          <select name="category" id="cat-${escKey}">${makeOptions(CATEGORIES, r.category, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}</select>
          <select name="owner" id="owner-${escKey}">${makeOptions(OWNERS, r.owner, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}</select>
        </div>
        ${ isTransferRow ? `<select name="accountIn" id="accIn-${escKey}" style="margin-top:8px">${makeOptions(ACCOUNTS,'',true,'ï¼ˆè½‰å…¥å¸³æˆ¶-ä¸æ›´æ”¹ï¼‰')}</select>` : '' }
        <div class="rowbtns" style="margin-top:8px">
          <button class="btn" type="button" onclick="submitEdit('${rawKey}', ${isTransferRow?'true':'false'}, '${isOut?'æ”¯å‡º':'æ”¶å…¥'}')">å„²å­˜</button>
        </div>
      </form>
    </div>`;
  }).join('');
}

function toggleEdit(rawKey){
  const escKey = cssEscape(rawKey);
  const el=$('edit-'+escKey);
  if(el) el.style.display = el.style.display==='none' ? 'block' : 'none';
}

function editItemChanged(rawKey){
  const escKey = cssEscape(rawKey);
  const sel=$('itemSel-'+escKey), other=$('itemOther-'+escKey); if(!sel||!other) return;
  if(sel.value==='å…¶ä»–'){ other.style.display='block'; other.focus(); } else { other.style.display='none'; other.value=''; }
}

async function submitEdit(rawKey, isTransfer, dir){
  const escKey = cssEscape(rawKey);
  const amt=Number(($('amt-'+escKey)?.value)||'0'); if(!(amt>0)){ toast('é‡‘é¡å¿…å¡«'); return; }
  const note=$('note-'+escKey)?.value ?? '';
  const account=$('acc-'+escKey)?.value ?? '';
  const category=$('cat-'+escKey)?.value ?? '';
  const owner=$('owner-'+escKey)?.value ?? '';
  const itemSel=$('itemSel-'+escKey)?.value ?? '';
  const itemOther=$('itemOther-'+escKey)?.value?.trim() ?? '';
  const item=(itemSel==='å…¶ä»–')?itemOther:itemSel;
  const apiKey=$('apiKey').value.trim();

  const payload={ action:'update', createdAt:rawKey, amount:String(amt), note, account, category, owner, item:item||'', apiKey };
  if(isTransfer){ const ain=$('accIn-'+escKey)?.value ?? ''; payload.isTransfer='true'; if(ain) payload.accountIn=ain; }
  else { payload.direction=dir; }

  try{
    const res=await fetch($('endpoint').value.trim(), { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body:new URLSearchParams(payload).toString() });
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'æ›´æ–°å¤±æ•—');
    toast('å·²æ›´æ–°'); $('btnRecent').click();
  }catch(e){ toast('æ›´æ–°å¤±æ•—ï¼š'+e.message); }
}

async function askDelete(rawKey){
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ï¼ˆäº’è½‰æœƒè‡ªå‹•åˆªå…©åˆ—ï¼‰ï¼Ÿ')) return;
  const apiKey=$('apiKey').value.trim();
  try{
    const res=await fetch($('endpoint').value.trim(), { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body:new URLSearchParams({action:'delete', createdAt:rawKey, apiKey}).toString() });
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'åˆªé™¤å¤±æ•—');
    toast('å·²åˆªé™¤'); $('btnRecent').click();
  }catch(e){ toast('åˆªé™¤å¤±æ•—ï¼š'+e.message); }
}

/* é¤˜é¡ */
$('btnBalance').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆåœ¨ã€Œè¨­å®šã€å¡«å…¥ Endpoint'); return; }
  const params=new URLSearchParams({balance:'1',by:'account'}); const m=$('qMonth').value.trim(), own=$('qOwner').value.trim();
  if(m)params.set('month',m); if(own)params.set('owner',own);
  $('balanceResult').textContent='æŸ¥è©¢ä¸­â€¦'; $('balanceTable').style.display='none';
  try{
    const res=await fetch(`${endpoint}?${params.toString()}`); if(!res.ok) throw 0;
    const data=await res.json(); if(!data.ok||!Array.isArray(data.breakdown)) throw 0;
    const map=new Map(data.breakdown.map(x=>[x.account,Number(x.balance||0)]));
    const rows=ACCOUNTS.map(a=>({account:a,balance:map.has(a)?map.get(a):0}));
    const tbody=document.querySelector('#balanceTable tbody');
    tbody.innerHTML=rows.map(r=>`<tr><td>${r.account}</td><td class="right">${r.balance.toFixed(2)}</td></tr>`).join('');
    const total=rows.reduce((s,r)=>s+r.balance,0);
    $('balanceTotal').textContent=total.toFixed(2);
    $('balanceResult').textContent=`ä¾†æºï¼š${data.source||'detail.byAccount'}${m?`ï½œæœˆä»½ï¼š${m}`:''}${own?`ï½œç™»è¨˜äººï¼š${own}`:''}`;
    $('balanceTable').style.display='';
  }catch{ $('balanceResult').textContent='æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Endpoint/æ¬Šé™'; }
};

/* è¨­å®š */
function loadCfg(){ $('cfgHint').textContent = $('endpoint').value ? 'å·²è¨­å®š Endpoint' : 'å°šæœªè¨­å®š Endpoint'; }
$('btnTest').onclick=async()=>{ try{ const r=await fetch($('endpoint').value.trim()+'?ping=1'); toast(r.ok?'é€£ç·šæ­£å¸¸':'é€£ç·šå¤±æ•—'); }catch{ toast('é€£ç·šå¤±æ•—'); } };
$('btnSaveCfg').onclick=()=>{ loadCfg(); toast('è¨­å®šå·²å„²å­˜'); };

/* æ‰‹å‹•åŒ¯å…¥ Gmail å¤–é€å¸³å–®ï¼ˆé è¨­ 10 å¤©ï¼‰ */
$('btnImport').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆåœ¨ã€Œè¨­å®šã€å¡«å…¥ Endpoint'); return; }
  const days=Math.max(1,Math.min(90,Number($('importDays').value)||10)); $('importHint').textContent='è™•ç†ä¸­â€¦';
  try{
    const res=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body:new URLSearchParams({action:'ingest_gmail',days:String(days),apiKey:$('apiKey').value.trim()}).toString()});
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'åŒ¯å…¥å¤±æ•—');
    toast(`å®Œæˆï¼šæ–°å¢ ${data.added||0} ç­†`); $('importHint').textContent=`å®Œæˆï¼šæ–°å¢ ${data.added||0} ç­†ï¼ˆè€—æ™‚ ${data.elapsedMs||0} msï¼‰`;
    if(location.hash==='#recent'){ $('btnRecent').click(); }
  }catch(e){ $('importHint').textContent='å¤±æ•—ï¼š' + e.message; toast('åŒ¯å…¥å¤±æ•—ï¼š' + e.message); }
};
</script>
</body>
</html>
