<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>æ”¶æ”¯å¿«è¨˜ï½œSPA</title>
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#f6f7fb; --panel:#ffffff; --panel-2:#f3f4f6;
    --text:#0f172a; --muted:#6b7280; --line:#e5e7eb; --brand:#2563eb; --ok:#16a34a; --bad:#dc2626;
    --radius:14px; --shadow:0 6px 16px rgba(0,0,0,.06);
  }
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
  .container{max-width:720px;margin:auto;padding:12px 12px 80px}
  .tabs{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--line)}
  .tabbar{display:grid;grid-template-columns:repeat(4,1fr)}
  .tab{display:flex;gap:6px;align-items:center;justify-content:center;padding:12px 8px;text-decoration:none;color:#334155;border-bottom:2px solid transparent}
  .tab.active{color:var(--brand);border-bottom-color:var(--brand);font-weight:700}
  section[hidden]{display:none}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin:12px 0;box-shadow:var(--shadow)}
  h1{font-size:18px;margin:0 0 10px}
  h2{font-size:14px;margin:0 0 8px;color:var(--muted)}
  label{font-size:14px;display:block;margin:10px 0 6px}
  .muted{color:var(--muted);font-size:12px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  input,select{display:block;width:100%;max-width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:var(--panel-2);color:var(--text);font-size:16px}
  input:disabled, select:disabled { background: var(--line); color: var(--muted); opacity: 0.8; }
  .inline{display:flex;gap:10px;align-items:center}
  .inline > *{flex:1}
  .rowbtns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:12px 14px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-weight:700;font-size:16px;cursor:pointer}
  .btn:disabled { background: var(--muted); opacity: 0.7; cursor: not-allowed; }
  .btn.secondary{background:#64748b}
  .btn.ghost{background:#fff;border:1px solid var(--line);color:#111827}
  .log{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:10px}
  .log table{width:100%;border-collapse:collapse;font-size:14px}
  .log th,.log td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
  .neg{color:var(--bad)} .pos{color:var(--ok)}
  .list{display:grid;gap:10px;margin-top:8px}
  .list-item{background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px}
  .list-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
  .list-amt{font-weight:800; font-size:18px}
  .list-amt.neg{color:var(--bad)} .list-amt.pos{color:var(--ok)}
  .list-meta{color:var(--muted);font-size:12px}
  .list-body{margin-top:2px;font-size:14px}
  .clamp2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .table{width:100%;border-collapse:collapse;margin-top:8px}
  .table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  .right{text-align:right}
  .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;border:1px solid #111827;padding:10px 12px;border-radius:10px;display:none;box-shadow:var(--shadow);max-width:90%;font-size:14px}
  .toast.show{display:block}
  .switchline{display:flex;align-items:center;gap:10px;margin-top:6px}
  .switchline input[type="checkbox"]{width:20px;height:20px}
  
  #splitList { margin-top: 12px; }
  #splitList table { width: 100%; font-size: 14px; border-collapse: collapse; }
  #splitList th, #splitList td { padding: 6px; text-align: left; border-bottom: 1px solid var(--line); }
  #splitList .del-btn { color: var(--bad); cursor: pointer; padding-left: 8px; }
  #splitList tfoot td { border: none; font-weight: 600; text-align: right; padding-top: 8px; color: var(--brand); }
</style>
</head>
<body>

<div class="tabs">
  <div class="tabbar">
    <a class="tab" href="#home">ğŸ§¾ è¨˜å¸³</a>
    <a class="tab" href="#recent">ğŸ•’ æœ€æ–°</a>
    <a class="tab" href="#balance">ğŸ“Š é¤˜é¡</a>
    <a class="tab" href="#settings">âš™ï¸ è¨­å®š</a>
  </div>
</div>

<div class="container">
  <section data-view="home">
    <div class="card">
      <h1>æ”¶æ”¯å¿«è¨˜</h1>
      <form id="form" autocomplete="off" style="margin-top:8px">
        <label>æ—¥æœŸ</label><input type="date" id="date" required>
        <label>ç™»è¨˜äºº</label>
        <select id="owner"><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
        <label>æ–¹å‘</label>
        <select id="direction"><option>æ”¯å‡º</option><option>æ”¶å…¥</option></select>
        <label>é‡‘é¡</label><input type="number" id="amount" min="0.01" step="0.01" inputmode="decimal" required>
        <label>åˆ†é¡</label>
        <select id="category">
          <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
          <option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option>
          <option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option>
        </select>
        <label>å¸³æˆ¶ï¼ˆè½‰å‡ºå¸³æˆ¶ï¼‰</label>
        <select id="account">
          <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
          <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
          <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
          <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
        </select>
        <label>é …ç›®</label>
        <div class="inline">
          <select id="itemSelect">
            <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
            <option value="é£Ÿç‰©">é£Ÿç‰©</option><option value="å…¬å¸ä»£å¢Š">å…¬å¸ä»£å¢Š</option>
            <option value="ç©æ¨‚">ç©æ¨‚</option><option value="äº¤é€š">äº¤é€š</option>
            <option value="å…¶ä»–">å…¶ä»–ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
          </select>
          <input id="itemOther" placeholder="è¼¸å…¥å…¶ä»–é …ç›®" style="display:none">
        </div>
        <div class="switchline">
          <input type="checkbox" id="isTransfer">
          <label for="isTransfer" style="margin:0">äº’è½‰</label>
        </div>
        <div id="transferFields" style="display:none;margin-top:6px">
          <label>è½‰å…¥å¸³æˆ¶</label>
          <select id="accountIn">
            <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
            <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
            <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
            <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
          </select>
        </div>
        <label>å‚™è¨»</label><input id="note" placeholder="">

        <hr style="border:0; border-top: 1px dashed var(--line); margin: 16px 0;">
        <div id="splitList"></div>
        <button class="btn secondary" type="button" id="btnAddSplit" style="width:100%">â• æ–°å¢åˆ†é … (æš«å­˜)</button>
        
        <div class="rowbtns" style="margin-top:12px"><button class="btn" type="submit" id="btnSubmit" style="width:100%">é€å‡º</button></div>
      </form>
    </div>

    <div class="card">
      <h1>ç™¼é€ç´€éŒ„</h1>
      <div class="rowbtns">
        <button class="btn secondary" id="btnExport" type="button">åŒ¯å‡º CSV</button>
        <button class="btn ghost" id="btnClear" type="button">æ¸…é™¤ç´€éŒ„</button>
      </div>
      <p class="muted">åƒ…å„²å­˜åœ¨æ­¤è£ç½®ï¼ˆæœ¬æ©Ÿï¼‰ï¼Œæœ€å¤šä¿ç•™ 50 ç­†ã€‚</p>
      <div class="log" id="log"></div>
    </div>
  </section>

  <section data-view="recent" hidden>
    <div class="card">
      <h1>æœ€æ–° N ç­†ï¼ˆé›²ç«¯ï¼‰</h1>
      <div class="inline">
        <input type="number" id="rLimit" value="10" min="1" max="50" style="max-width:110px" />
        <select id="rAccount">
          <option value="">å…¨éƒ¨å¸³æˆ¶</option>
          <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
          <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
          <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
        </select>
      </div>
      <div class="inline" style="margin-top:8px">
        <select id="rCategory">
          <option value="">å…¨éƒ¨åˆ†é¡</option>
          <option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option>
          <option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option>
        </select>
        <select id="rOwner"><option value="">å…¨éƒ¨ç™»è¨˜äºº</option><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
      </div>
      <div class="rowbtns" style="margin-top:8px">
        <button class="btn secondary" id="btnRecent" type="button">æŸ¥è©¢æœ€æ–°ç´€éŒ„</button>
      </div>
      <p class="muted mono" id="recentHint">â€”</p>
      <div class="list" id="recentList" style="display:none"></div>
    </div>
  </section>
  <section data-view="balance" hidden>
    <div class="card">
      <h1>é¤˜é¡æŸ¥è©¢</h1>
      <div class="inline">
        <input id="qMonth" placeholder="æœˆä»½ï¼ˆyyyy-MMï¼Œå¯ç•™ç©ºï¼‰">
        <select id="qOwner"><option value="">ï¼ˆå…¨éƒ¨ï¼‰</option><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
      </div>
      <div class="rowbtns"><button class="btn secondary" id="btnBalance" type="button">æŸ¥è©¢å„å¸³æˆ¶é¤˜é¡</button></div>
      <div id="balanceArea">
        <p class="muted mono" id="balanceResult">â€”</p>
        <table class="table" id="balanceTable" style="display:none">
          <thead><tr><th>å¸³æˆ¶</th><th class="right">é¤˜é¡</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><th>ç¸½è¨ˆ</th><th class="right" id="balanceTotal">0.00</th></tr></tfoot>
        </table>
      </div>
    </div>
  </section>
  <section data-view="settings" hidden>
    <div class="card">
      <h1>è¨­å®š</h1>
      <label>Endpoint URL</label>
      <input id="endpoint" value="https://script.google.com/macros/s/AKfycbzjpwoEGtRpX9FnQ0i-rSjvgaUB40gG44tBAcd_tI30R1X9HydICtdlSiooJXViatJZ/exec">
      <label>API Keyï¼ˆå¯ç•™ç©ºï¼‰</label><input id="apiKey">
      <div class="rowbtns">
        <button class="btn secondary" id="btnTest" type="button">é€£ç·šæ¸¬è©¦</button>
        <button class="btn ghost" id="btnSaveCfg" type="button">å„²å­˜è¨­å®š</button>
      </div>
      <p class="muted mono" id="cfgHint"></p>
    </div>
    <div class="card">
      <h1>å¤–é€å¸³å–®åŒ¯å…¥</h1>
      <div class="inline">
        <input id="importDays" type="number" min="1" max="90" value="10" placeholder="æœ€è¿‘ N å¤©ï¼ˆé è¨­ 10ï¼‰">
        <select id="importPlatform">
          <option value="">Foodpanda + Uber</option>
          <option value="foodpanda">åªæŠ“ Foodpanda</option>
          <option value="uber">åªæŠ“ Uber Eats</option>
        </select>
      </div>
      <div class="switchline">
        <input type="checkbox" id="importForce">
        <label for="importForce" style="margin:0">é‡æ–°åŒ¯å…¥ï¼ˆå¿½ç•¥å·²è™•ç†ï¼‰</label>
      </div>
      <div class="rowbtns" style="margin-top:8px">
        <button class="btn secondary" id="btnImport" type="button">æŠ“å–å¤–é€å¸³å–®</button>
      </div>
      <p class="muted">åªæŠ“ Foodpanda / Uber Eats è¨‚å–®ï¼›æ’é™¤é€€æ¬¾èˆ‡ç™¼ç¥¨ã€‚å‹¾é¸ã€Œé‡æ–°åŒ¯å…¥ã€å¯æŠŠåŒå€é–“é‡çŒå›è¡¨ã€‚</p>
      <p class="muted mono" id="importHint">â€”</p>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
/* Router */
function showView(name){
  document.querySelectorAll('section[data-view]').forEach(sec=>sec.hidden = sec.dataset.view !== name);
  document.querySelectorAll('.tabbar .tab').forEach(a=>a.classList.toggle('active', a.getAttribute('href') === '#'+name));
}
function route(){ const name=(location.hash||'#home').slice(1); showView(['home','recent','balance','settings'].includes(name)?name:'home'); }
window.addEventListener('hashchange', route);

/* Utils */
const $ = id => document.getElementById(id);
const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };
function cssEscape(s){ return String(s).replace(/[^a-zA-Z0-9_\-:.]/g,'_'); }

/* æ——æ¨™èˆ‡æš«å­˜ */
let isSubmitting = false; 
let currentSplits = []; 

/* å¸¸é‡ */
const ACCOUNTS = ['é»ƒç¾é‡‘','åˆ·å¡','è•­ç¾é‡‘','åˆä½œé‡‘åº«','è•­éƒµå±€','è¯å—éŠ€è¡Œ','é»ƒéƒµå±€','è•­LINE','å½°åŒ–éŠ€è¡Œ','é»ƒä¸­ä¿¡','é»ƒLINE','åœ‹æ³°ä¸–è¯'];
const CATEGORIES = ['å…±ç”¨','é»ƒæ”¯å‡º','è•­æ”¯å‡º','æ´‹æ”¯å‡º','ä¿¡ç”¨å¡','æ”¶å…¥','è² å‚µ','å¹³è¡¡','å…¬å¸ä»£å¢Š','å…¶ä»–'];
const ITEM_OPTIONS = ['é£Ÿç‰©','å…¬å¸ä»£å¢Š','ç©æ¨‚','äº¤é€š','å…¶ä»–'];
const OWNERS = ['æ¬£å®œ','å–¬çŒ·'];

/* åˆå§‹ */
(function init(){
  $('date').value = new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
  fetch($('endpoint').value.trim() + '?ping=1').catch(()=>{});
  loadCfg(); renderLog(); route();
})();

/* è¨˜å¸³ï¼šé …ç›®å…¶ä»– */
const itemSelect = $('itemSelect'), itemOther = $('itemOther');
itemSelect.onchange = ()=>{ if(itemSelect.value==='å…¶ä»–'){ itemOther.style.display='block'; itemOther.focus(); } else { itemOther.style.display='none'; itemOther.value=''; } };

/* è¨˜å¸³ï¼šäº’è½‰åˆ‡æ› */
$('isTransfer').onchange = ()=>{
  const on = $('isTransfer').checked;
  $('transferFields').style.display = on ? 'block' : 'none';
  if (on){ 
    $('category').value='å¹³è¡¡'; $('category').disabled=true; itemSelect.value='å…¶ä»–'; itemOther.style.display='block'; itemOther.value='å…§æ§äº’è½‰'; 
    if (currentSplits.length > 0) {
      toast('æ¸…é™¤åˆ†å¸³æš«å­˜ä»¥å•Ÿç”¨äº’è½‰');
      currentSplits = [];
      renderSplits();
    }
  }
  else { $('category').disabled=false; if(itemOther.value==='å…§æ§äº’è½‰'){ itemOther.value=''; itemSelect.value=''; itemOther.style.display='none'; } }
};

/* åˆ†å¸³ç›¸é—œå‡½å¼ */
function setSharedFieldsDisabled(disabled) {
  $('date').disabled = disabled;
  $('owner').disabled = disabled;
  $('account').disabled = disabled;
}

function renderSplits() {
  const btnSubmit = $('btnSubmit');
  if (currentSplits.length === 0) {
    $('splitList').innerHTML = '';
    btnSubmit.textContent = 'é€å‡º'; 
    setSharedFieldsDisabled(false); // è§£é–
    return;
  }
  
  let html = '<table><thead><tr><th>é‡‘é¡</th><th>åˆ†é¡/é …ç›®</th><th>å‚™è¨»</th><th></th></tr></thead><tbody>';
  let totalSplit = 0;
  currentSplits.forEach((s, i) => {
    const signedAmt = s.direction === 'æ”¯å‡º' ? s.amount : -s.amount;
    totalSplit += signedAmt; 
    const isOut = s.direction === 'æ”¯å‡º';
    html += `<tr>
      <td class="right ${isOut?'neg':'pos'}">${isOut?'-':''}${s.amount.toFixed(2)}</td>
      <td>${s.category}ï½œ${s.item}</td>
      <td>${s.note}</td>
      <td><span class="del-btn" data-idx="${i}">âœ•</span></td>
    </tr>`;
  });
  html += `</tbody><tfoot><tr><td colspan="4">æš«å­˜ç¸½è¨ˆ (æ·¨æ”¯å‡º)ï¼š${totalSplit.toFixed(2)}</td></tr></tfoot>`;
  $('splitList').innerHTML = html;
  
  btnSubmit.textContent = `é€å‡º ${currentSplits.length} ç­†åˆ†å¸³`;
  setSharedFieldsDisabled(true); // é–å®š
}

$('btnAddSplit').onclick = () => {
  if (currentSplits.length === 0) {
    if (!$('date').value) { toast('è«‹å…ˆå¡«å¯«æ—¥æœŸ'); $('date').focus(); return; }
    if (!$('account').value) { toast('è«‹å…ˆé¸æ“‡è½‰å‡ºå¸³æˆ¶'); $('account').focus(); return; }
  }

  const amount = Number($('amount').value || 0);
  const category = $('category').value;
  const item = ($('itemSelect').value==='å…¶ä»–') ? $('itemOther').value.trim() : $('itemSelect').value;
  const note = $('note').value.trim();
  const direction = $('direction').value;

  if ($('isTransfer').checked) {
    toast('äº’è½‰æ¨¡å¼ä¸‹ç„¡æ³•æ–°å¢åˆ†é …');
    return;
  }
  if (!amount || amount <= 0 || !category || !item) {
    toast('åˆ†é …çš„é‡‘é¡(>0)ã€åˆ†é¡ã€é …ç›® å‡é ˆå¡«å¯«');
    return;
  }
  
  currentSplits.push({ amount, category, item, note, direction });
  renderSplits(); 
  
  $('amount').value = '';
  $('itemSelect').value = '';
  $('itemOther').value = '';
  $('itemOther').style.display = 'none';
  $('note').value = '';
  $('amount').focus(); 
};

$('splitList').onclick = (e) => {
  if (e.target.classList.contains('del-btn')) {
    const idx = Number(e.target.dataset.idx);
    currentSplits.splice(idx, 1);
    renderSplits(); 
  }
};


/* æœ¬æ©Ÿç™¼é€ç´€éŒ„ (åŠŸèƒ½ä¸è®Š) */
const SENT_KEY='spend.sent.v19';
function loadSent(){ try{return JSON.parse(localStorage.getItem(SENT_KEY)||'[]');}catch{return[];} }
function saveSent(list){ localStorage.setItem(SENT_KEY, JSON.stringify(list.slice(-50))); }
function addSent(rec){ const list=loadSent(); list.push(rec); saveSent(list); }
function renderLog(){
  const list=loadSent().slice().reverse();
  if(!list.length){ $('log').innerHTML='<div class="muted" style="padding:12px">å°šç„¡ç´€éŒ„</div>'; return; }
  let html='<table><thead><tr><th>æ™‚é–“</th><th>æ–¹å‘/é‡‘é¡</th><th>åˆ†é¡/å¸³æˆ¶</th><th>é …ç›®/å‚™è¨»</th><th>ç™»è¨˜äºº</th></tr></thead><tbody>';
  for(const r of list){
    const isOut=r.direction==='æ”¯å‡º'; const amt=Math.abs(Number(r.amount||0));
    html+=`<tr><td class="muted">${r.ts||''}</td><td class="${isOut?'neg':'pos'}">${r.direction} ${isOut?'-':''}${amt.toFixed(2)}</td>
      <td>${r.category||''}ï½œ${r.account||''}</td><td>${r.item||''}ï½œ${r.note||''}</td><td>${r.owner||''}</td></tr>`;
  }
  html+='</tbody></table>'; $('log').innerHTML=html;
}
$('btnExport').onclick=()=>{
  const list=loadSent(); const header=['æ—¥æœŸ','æ™‚é–“æˆ³','æ–¹å‘','é‡‘é¡','åˆ†é¡','å¸³æˆ¶','é …ç›®','å‚™è¨»','ç™»è¨˜äºº'];
  const rows=[header.join(',')];
  const esc=s=>{if(s==null)return'';const t=String(s).replace(/"/g,'""');return /[",\n]/.test(t)?`"${t}"`:t;}
  for(const r of list){ rows.push([r.date||'',r.ts||'',r.direction||'',r.amount||'',r.category||'',r.account||'',r.item||'',r.note||'',r.owner||''].map(esc).join(',')); }
  const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'}),url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='spend-log.csv'; a.click(); URL.revokeObjectURL(url);
};
$('btnClear').onclick=()=>{ if(confirm('æ¸…é™¤æœ¬æ©Ÿç™¼é€ç´€éŒ„ï¼Ÿ')){ localStorage.removeItem(SENT_KEY); renderLog(); } };

/* èƒŒæ™¯é€å‡º (åŠŸèƒ½ä¸è®Š) */
function backgroundSend(url, payloadObj){
  const body=new URLSearchParams(payloadObj).toString();
  const mime='application/x-www-form-urlencoded;charset=UTF-8';
  if(navigator.sendBeacon){ navigator.sendBeacon(url,new Blob([body],{type:mime})); }
  else{ fetch(url,{method:'POST',headers:{'Content-Type':mime},body,keepalive:true}).catch(()=>{}); }
}

/* â­ æ•´åˆï¼šæ–°å¢é€å‡º (å·²ä¿®å¾©éŒ¯èª¤) */
$('form').onsubmit=(e)=>{
  e.preventDefault();
  
  if (isSubmitting) return; 
  isSubmitting = true;     
  const btnSubmit = $('btnSubmit');
  btnSubmit.disabled = true; 

  const endpoint=$('endpoint').value.trim(); const apiKey=$('apiKey').value.trim();
  const date=$('date').value, owner=$('owner').value, account=$('account').value;
  const norm=s=>s.replace(/^åˆä½œ$/,'åˆä½œé‡‘åº«').replace(/^è•­è³´$/,'è•­LINE');

  // å…±ç”¨æ¬„ä½é©—è­‰ (ç„¡è«–å–®ç­†æˆ–åˆ†å¸³éƒ½éœ€è¦)
  if (!date) { toast('è«‹è¼¸å…¥æ—¥æœŸ'); isSubmitting = false; btnSubmit.disabled = false; return; }
  if (!account) { toast('è«‹é¸æ“‡å¸³æˆ¶'); isSubmitting = false; btnSubmit.disabled = false; return; }

  const d=new Date(); const pad=n=>String(n).padStart(2,'0'); const ts=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  
  let payload={ date, owner, account:norm(account), apiKey };
  let localLogs = []; 

  if (currentSplits.length > 0) {
    // --- (A) åˆ†å¸³æ¨¡å¼ ---
    
    // â­ ä¿®å¾©ï¼šç§»é™¤éŒ¯èª¤çš„æª¢æŸ¥ `if (Number($('amount').value || 0) > 0)`
    // ç¾åœ¨å®ƒæœƒç›´æ¥æäº¤æš«å­˜åˆ—è¡¨

    payload.action = 'split_add'; 
    payload.splits_json = JSON.stringify(currentSplits);
    
    currentSplits.forEach(s => {
      localLogs.push({ ts, date, owner, direction: s.direction, amount: s.amount, category: s.category, account: norm(account), item: s.item, note: s.note });
    });
    
    toast(`å·²é€å‡º (èƒŒæ™¯è™•ç†ï¼šåˆ†å¸³ Ã—${currentSplits.length})`);
    
    currentSplits = [];
    renderSplits(); // æ¸…ç©ºåˆ—è¡¨ã€é‚„åŸæŒ‰éˆ•ã€è§£é–æ¬„ä½

    // â­ æ–°å¢ï¼šåŒæ™‚æ¸…ç©ºå¯èƒ½æ®˜ç•™çš„è¡¨å–®è³‡æ–™
    $('amount').value=''; 
    $('itemSelect').value = '';
    $('itemOther').value = '';
    $('itemOther').style.display = 'none';
    $('note').value='';

  } else {
    // --- (B) å–®ç­†æ¨¡å¼ ---
    const direction=$('direction').value, amount=$('amount').value, isXfer=$('isTransfer').checked;
    const category=isXfer?'å¹³è¡¡':$('category').value;
    const item=isXfer?'å…§æ§äº’è½‰':((itemSelect.value==='å…¶ä»–')?$('itemOther').value.trim():itemSelect.value);
    const note=$('note').value.trim();
    const accountIn=$('accountIn').value;

    if(!amount||Number(amount)<=0){ toast('è«‹è¼¸å…¥é‡‘é¡'); isSubmitting = false; btnSubmit.disabled = false; return; }
    if(!isXfer && !category){ toast('è«‹é¸æ“‡åˆ†é¡'); isSubmitting = false; btnSubmit.disabled = false; return; }
    if(!item){ toast('è«‹é¸æ“‡æˆ–è¼¸å…¥é …ç›®'); isSubmitting = false; btnSubmit.disabled = false; return; }
    if(isXfer&&!accountIn){ toast('è«‹é¸æ“‡è½‰å…¥å¸³æˆ¶'); isSubmitting = false; btnSubmit.disabled = false; return; }
    
    if(isXfer){
      addSent({ts,date,owner,direction:'æ”¯å‡º',amount:Number(amount),category,account:norm(account),item,note});
      addSent({ts,date,owner,direction:'æ”¶å…¥',amount:Number(amount),category,account:norm(accountIn),item,note});
    }else{
      addSent({ts,date,owner,direction,amount:Number(amount),category,account:norm(account),item,note});
    }
    
    Object.assign(payload, { amount, category, item, note });
    if(isXfer){ payload.isTransfer='true'; payload.accountIn=norm(accountIn); } else { payload.direction=direction; }
    
    toast(isXfer?'å·²é€å‡ºï¼ˆèƒŒæ™¯è™•ç†ï¼šäº’è½‰Ã—2ï¼‰':'å·²é€å‡ºï¼ˆèƒŒæ™¯è™•ç†ï¼‰');
    
    $('amount').value=''; $('itemOther').value=''; $('note').value='';
    if($('itemSelect').value !== 'å…¶ä»–') $('itemSelect').value = '';
    if(isXfer){ $('isTransfer').checked=false; $('transferFields').style.display='none'; $('category').disabled=false; }
  }

  // --- (C) å…±ç”¨ï¼šåŸ·è¡Œé€å‡ºèˆ‡å¯«å…¥ Log ---
  localLogs.forEach(log => addSent(log));
  renderLog();
  backgroundSend(endpoint,payload);
  
  setTimeout(() => { 
    isSubmitting = false; 
    btnSubmit.disabled = false; 
    if (currentSplits.length === 0) {
      btnSubmit.textContent = 'é€å‡º'; 
    }
  }, 1000); 
};


/* (ä»¥ä¸‹ç‚º "æœ€æ–°" "é¤˜é¡" "è¨­å®š" "åŒ¯å…¥" ç­‰åŠŸèƒ½ï¼Œå‡å®Œæ•´ä¿ç•™ï¼Œç„¡éœ€ä¿®æ”¹) */

/* æœ€æ–°ï¼šæŸ¥è©¢èˆ‡æ¸²æŸ“ */
$('btnRecent').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆè¨­å®š Endpoint'); return; }
  const limit=Math.max(1,Math.min(50,Number($('rLimit').value)||10));
  const params=new URLSearchParams({recent:String(limit)});
  const acc=$('rAccount').value.trim(), cat=$('rCategory').value.trim(), own=$('rOwner').value.trim();
  if(acc)params.set('account',acc); if(cat)params.set('category',cat); if(own)params.set('owner',own);
  $('recentHint').textContent='æŸ¥è©¢ä¸­â€¦'; $('recentList').style.display='none';
  try{
    const res=await fetch(`${endpoint}?${params.toString()}`); if(!res.ok) throw 0;
    const data=await res.json(); if(!data.ok||!Array.isArray(data.records)) throw 0;
    renderRecent(data.records); $('recentHint').textContent=`é¡¯ç¤ºæœ€è¿‘ ${Math.min(data.records.length,limit)} ç­†`; $('recentList').style.display='';
  }catch{ $('recentHint').textContent='æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Endpoint/æ¬Šé™'; }
};

function makeOptions(list, selected, includeEmpty=true, emptyLabel='ï¼ˆä¸æ›´æ”¹ï¼‰'){
  const opts=[]; if(includeEmpty)opts.push(`<option value="">${emptyLabel}</option>`);
  for(const v of list){ opts.push(`<option value="${v}"${v===selected?' selected':''}>${v}</option>`); }
  return opts.join('');
}

function renderRecent(records){
  const listEl=$('recentList');
  const frag = document.createDocumentFragment();
  listEl.innerHTML='';
  records.forEach((r)=>{
    const amtRaw=Number(r.amount||0), isOut=(r.direction==='æ”¯å‡º'); const amt=Math.abs(amtRaw);
    const cls=isOut?'neg':'pos'; const meta=`${r.category||''}ãƒ»${r.account||''}ãƒ»${r.owner||''}`;
    const text=`${r.item||''}${r.note?`ï½œ${r.note}`:''}`;
    const rawKey = r.createdAt || r.date || '';
    const escKey = cssEscape(rawKey);
    const isTransferRow=(r.category==='å¹³è¡¡' && r.item==='å…§æ§äº’è½‰');
    const itemInList=ITEM_OPTIONS.includes(r.item||'');
    const itemSelValue=itemInList?(r.item||''):'å…¶ä»–';
    const itemOtherValue=itemInList?'':(r.item||'');

    const wrapper = document.createElement('div');
    wrapper.className='list-item';
    wrapper.dataset.key = rawKey;
    wrapper.innerHTML = `
      <div class="list-head"><div class="list-amt ${cls}">${isOut?'-':''}${amt.toFixed(2)}</div><div class="list-meta">${rawKey}</div></div>
      <div class="list-meta">${meta}</div>
      <div class="list-body clamp2">${text}</div>
      <div class="rowbtns" style="margin-top:8px">
        <button class="btn secondary" type="button" onclick="toggleEdit('${rawKey}')">âœï¸ ç·¨è¼¯</button>
        <button class="btn ghost" type="button" onclick="askDelete('${rawKey}')">ğŸ—‘ åˆªé™¤</button>
      </div>
      <form class="editbox" id="edit-${escKey}" style="display:none;margin-top:8px">
        <div class="inline">
          <input name="amount" id="amt-${escKey}" type="number" step="0.01" placeholder="é‡‘é¡ï¼ˆå¿…å¡«ï¼‰" value="${amt||''}">
          <input name="note"   id="note-${escKey}" placeholder="å‚™è¨»" value="${r.note||''}">
        </div>
        <div class="inline" style="margin-top:8px">
          <select name="account" id="acc-${escKey}">${makeOptions(ACCOUNTS, r.account, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}</select>
          <select name="item" id="itemSel-${escKey}" onchange="editItemChanged('${rawKey}')">
            ${makeOptions(ITEM_OPTIONS, itemSelValue, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}
          </select>
        </div>
        <input id="itemOther-${escKey}" placeholder="è¼¸å…¥å…¶ä»–é …ç›®" style="margin-top:8px;${itemSelValue==='å…¶ä»–'?'':'display:none;'}" value="${itemOtherValue}">
        <div class="inline" style="margin-top:8px">
          <select name="category" id="cat-${escKey}">${makeOptions(CATEGORIES, r.category, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}</select>
          <select name="owner" id="owner-${escKey}">${makeOptions(OWNERS, r.owner, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}</select>
        </div>
        ${ isTransferRow ? `<select name="accountIn" id="accIn-${escKey}" style="margin-top:8px">${makeOptions(ACCOUNTS,'',true,'ï¼ˆè½‰å…¥å¸³æˆ¶-ä¸æ›´æ”¹ï¼‰')}</select>` : '' }
        <div class="rowbtns" style="margin-top:8px">
          <button class="btn" type="button" onclick="submitEdit('${rawKey}', ${isTransferRow?'true':'false'}, '${isOut?'æ”¯å‡º':'æ”¶å…¥'}')">å„²å­˜</button>
        </div>
      </form>
    `;
    frag.appendChild(wrapper);
  });
  listEl.appendChild(frag);
  listEl.style.display='';
}

function toggleEdit(rawKey){
  const escKey = cssEscape(rawKey);
  const el=$('edit-'+escKey);
  if(el) el.style.display = el.style.display==='none' ? 'block' : 'none';
}

function editItemChanged(rawKey){
  const escKey = cssEscape(rawKey);
  const sel=$('itemSel-'+escKey), other=$('itemOther-'+escKey); if(!sel||!other) return;
  if(sel.value==='å…¶ä»–'){ other.style.display='block'; other.focus(); } else { other.style.display='none'; other.value=''; }
}

async function submitEdit(rawKey, isTransfer, dir){
  const escKey = cssEscape(rawKey);
  const amt=Number(($('amt-'+escKey)?.value)||'0'); if(!(amt>0)){ toast('é‡‘é¡å¿…å¡«'); return; }
  const note=$('note-'+escKey)?.value ?? '';
  const account=$('acc-'+escKey)?.value ?? '';
  const category=$('cat-'+escKey)?.value ?? '';
  const owner=$('owner-'+escKey)?.value ?? '';
  const itemSel=$('itemSel-'+escKey)?.value ?? '';
  const itemOther=$('itemOther-'+escKey)?.value?.trim() ?? '';
  const item=(itemSel==='å…¶ä»–')?itemOther:itemSel;
  const apiKey=$('apiKey').value.trim();

  const payload={ action:'update', createdAt:rawKey, amount:String(amt), note, account, category, owner, item:item||'', apiKey };
  if(isTransfer){ const ain=$('accIn-'+escKey)?.value ?? ''; payload.isTransfer='true'; if(ain) payload.accountIn=ain; }
  else { payload.direction=dir; }

  try{
    const res=await fetch($('endpoint').value.trim(), { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body:new URLSearchParams(payload).toString() });
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'æ›´æ–°å¤±æ•—');
    toast('å·²æ›´æ–°'); $('btnRecent').click();
  }catch(e){ toast('æ›´æ–°å¤±æ•—ï¼š'+e.message); }
}

async function askDelete(rawKey){
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ï¼ˆäº’è½‰æœƒè‡ªå‹•åˆªå…©åˆ—ï¼‰ï¼Ÿ')) return;
  const apiKey=$('apiKey').value.trim();
  try{
    const res=await fetch($('endpoint').value.trim(), { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body:new URLSearchParams({action:'delete', createdAt:rawKey, apiKey}).toString() });
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'åˆªé™¤å¤±æ•—');
    toast('å·²åˆªé™¤'); $('btnRecent').click();
  }catch(e){ toast('åˆªé™¤å¤±æ•—ï¼š'+e.message); }
}

/* é¤˜é¡ */
$('btnBalance').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆåœ¨ã€Œè¨­å®šã€å¡«å…¥ Endpoint'); return; }
  const params=new URLSearchParams({balance:'1',by:'account'}); const m=$('qMonth').value.trim(), own=$('qOwner').value.trim();
  if(m)params.set('month',m); if(own)params.set('owner',own);
  $('balanceResult').textContent='æŸ¥è©¢ä¸­â€¦'; $('balanceTable').style.display='none';
  try{
    const res=await fetch(`${endpoint}?${params.toString()}`); if(!res.ok) throw 0;
    const data=await res.json(); if(!data.ok||!Array.isArray(data.breakdown)) throw 0;
    const map=new Map(data.breakdown.map(x=>[x.account,Number(x.balance||0)]));
    const rows=ACCOUNTS.map(a=>({account:a,balance:map.has(a)?map.get(a):0}));
    const tbody=document.querySelector('#balanceTable tbody');
    tbody.innerHTML=rows.map(r=>`<tr><td>${r.account}</td><td class="right">${r.balance.toFixed(2)}</td></tr>`).join('');
    const total=rows.reduce((s,r)=>s+r.balance,0);
    $('balanceTotal').textContent=total.toFixed(2);
    $('balanceResult').textContent=`ä¾†æºï¼š${data.source||'detail.byAccount'}${m?`ï½œæœˆä»½ï¼š${m}`:''}${own?`ï½œç™»è¨˜äººï¼š${own}`:''}`;
    $('balanceTable').style.display='';
  }catch{ $('balanceResult').textContent='æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Endpoint/æ¬Šé™'; }
};

/* è¨­å®š */
function loadCfg(){ 
  $('endpoint').value = localStorage.getItem('spend.endpoint') || $('endpoint').value;
  $('apiKey').value = localStorage.getItem('spend.apiKey') || '';
  $('cfgHint').textContent = $('endpoint').value ? 'å·²è¨­å®š Endpoint' : 'å°šæœªè¨­å®š Endpoint'; 
}
$('btnTest').onclick=async()=>{ try{ const r=await fetch($('endpoint').value.trim()+'?ping=1'); toast(r.ok?'é€£ç·šæ­£å¸¸':'é€£ç·šå¤±æ•—'); }catch{ toast('é€£ç·šå¤±æ•—'); } };
$('btnSaveCfg').onclick=()=>{ 
  localStorage.setItem('spend.endpoint', $('endpoint').value.trim());
  localStorage.setItem('spend.apiKey', $('apiKey').value.trim());
  loadCfg(); 
  toast('è¨­å®šå·²å„²å­˜'); 
};

/* æ‰‹å‹•åŒ¯å…¥ Gmail å¤–é€å¸³å–®ï¼ˆå¯å‹¾é¸ã€Œé‡æ–°åŒ¯å…¥ã€ï¼‰ */
$('btnImport').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆåœ¨ã€Œè¨­å®šã€å¡«å…¥ Endpoint'); return; }
  const days=Math.max(1,Math.min(90,Number($('importDays').value)||10));
  const force = $('importForce').checked ? 'true' : 'false';
  $('importHint').textContent='è™•ç†ä¸­â€¦';
  try{
    const res=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body:new URLSearchParams({action:'ingest_gmail',days:String(days),force,apiKey:$('apiKey').value.trim()}).toString()});
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'åŒ¯å…¥å¤±æ•—');
    toast(`å®Œæˆï¼šæ–°å¢ ${data.added||0} ç­†`); $('importHint').textContent=`å®Œæˆï¼šæ–°å¢ ${data.added||0} ç­†ï¼ˆè€—æ™‚ ${data.elapsedMs||0} msï¼‰`;
    if(location.hash==='#recent'){ $('btnRecent').click(); }
  }catch(e){ $('importHint').textContent='å¤±æ•—ï¼š' + e.message; toast('åŒ¯å…¥å¤±æ•—ï¼š' + e.message); }
};

/* åˆå§‹å•Ÿå‹• */
(function(){ route(); })();
</script>
</body>
</html>
