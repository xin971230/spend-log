<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#F5F7F9">
  <title>æ”¶æ”¯å¿«è¨˜</title>
  
  <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=Ledger&background=5D7B9D&color=fff&size=192&font-size=0.3&rounded=true">

  <style>
    :root {
      --bg: #F5F7F9; --card: #FFFFFF;
      --text: #334155; --text-light: #94A3B8;
      --primary: #5D7B9D; --danger: #EF4444; --success: #059669;
      --radius: 12px; --border: #E2E8F0;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      height: 100vh; display: flex; flex-direction: column;
      padding-top: env(safe-area-inset-top);
      padding-bottom: calc(100px + env(safe-area-inset-bottom));
    }
    .icon { width: 20px; height: 20px; fill: currentColor; }
    .nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.98); border: 1px solid var(--border);
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      border-radius: 32px; padding: 6px 12px;
      display: flex; gap: 8px; z-index: 100; width: 90%; max-width: 360px; justify-content: space-between;
    }
    .nav-item {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 8px 0; color: var(--text-light); text-decoration: none;
      font-size: 10px; font-weight: 600; border-radius: 20px; transition: all 0.2s ease;
    }
    .nav-item.active { color: var(--primary); background: #F1F5F9; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px 16px; width: 100%; flex: 1; overflow-y: auto; }
    section[hidden] { display: none; }
    .card { background: var(--card); border-radius: var(--radius); overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.02); margin-bottom: 16px; border: 1px solid var(--border); }
    .big-input-wrapper { display: flex; justify-content: center; align-items: center; padding: 0 0 24px; position: relative; }
    .currency-symbol { font-size: 20px; font-weight: 500; color: var(--text-light); margin-right: 4px; }
    .big-input { border: none; background: transparent; text-align: center; font-size: 48px; font-weight: 600; color: var(--text); width: 180px; padding: 0; margin: 0; font-family: monospace; }
    .input-row { display: flex; align-items: center; padding: 14px 20px; border-bottom: 1px solid var(--border); min-height: 52px; }
    .row-label { width: 70px; font-size: 14px; color: var(--text-light); font-weight: 500; }
    .row-input { flex: 1; border: none; background: transparent; font-size: 15px; color: var(--text); text-align: right; }
    select.row-input { direction: rtl; }
    .btn-main { background: var(--primary); color: #fff; width: 100%; padding: 14px; border: none; border-radius: var(--radius); font-size: 15px; font-weight: 600; margin-top: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(93,123,157,0.2); transition: 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-ghost { background: transparent; color: var(--text-light); border: 1px solid var(--border); }
    .switch { position: relative; display: inline-block; width: 44px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #CBD5E1; transition: .3s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(18px); }
    .seg-control { display: flex; background: var(--bg); border-radius: 12px; padding: 4px; margin: 0 16px 20px; }
    .seg-item { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; border-radius: 8px; color: var(--text-light); cursor: pointer; transition: 0.2s; }
    .seg-item.active { background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); color: var(--text); }
    .seg-item[data-val="æ”¯å‡º"].active { color: var(--danger); }
    .seg-item[data-val="æ”¶å…¥"].active { color: var(--success); }
    .record-item { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .rec-amt { font-size: 16px; font-weight: 600; font-family: monospace; }
    .rec-amt.neg { color: var(--text); } .rec-amt.pos { color: var(--success); }
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-50px); background: #334155; color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; opacity: 0; transition: 0.4s; pointer-events: none; z-index: 2000; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(2px); z-index: 999; display: none; justify-content: center; align-items: flex-end; }
    .modal-overlay.open { display: flex; }
    .modal-card { background: #fff; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 24px; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    #verLog { font-size:12px; background:#f1f5f9; padding:16px; border-radius:12px; line-height:1.6; max-height:200px; overflow-y:auto; margin-top:12px; display:none; text-align:left; border:1px solid var(--border); }
    #verLog ul { padding-left:16px; margin:0; }
    #verLog li { margin-bottom:6px; color:var(--text); }
    .ver-date { font-size:10px; color:var(--text-light); margin-right:6px; background:#e2e8f0; padding:2px 4px; border-radius:4px; font-family:monospace; }
    
    .footer { text-align: center; margin-top: 40px; padding-bottom: 20px; color: var(--text-light); }
    .ver-badge { font-size: 10px; background: #E2E8F0; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
    .ver-desc { font-size: 11px; margin-top: 6px; line-height: 1.4; opacity: 0.8; }

    /* Photo Upload Styles */
    .cam-btn { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; background: #F1F5F9; color: var(--primary); cursor: pointer; margin-left: 8px; border: 1px solid var(--border); }
    .img-preview-area { display: flex; gap: 8px; overflow-x: auto; padding: 8px 16px; background: #fff; border-bottom: 1px solid var(--border); }
    .img-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 1px solid #eee; flex-shrink: 0; }
    .img-thumb-wrap { position: relative; }
    .img-del { position: absolute; top: -5px; right: -5px; background: red; color: white; width: 16px; height: 16px; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
  </style>
</head>
<body>

  <nav class="nav">
    <a href="#home" class="nav-item active" onclick="routeClick('home')"><svg class="icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>è¨˜å¸³</a>
    <a href="#recent" class="nav-item" onclick="routeClick('recent')"><svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>æ˜ç´°</a>
    <a href="#balance" class="nav-item" onclick="routeClick('balance')"><svg class="icon" viewBox="0 0 24 24"><path d="M4 10h12v2H4zm0-4h12v2H4zm0 8h8v2H4zm10 0v6l5.5-3-5.5-3z"/></svg>è³‡ç”¢</a>
    <a href="#settings" class="nav-item" onclick="routeClick('settings')"><svg class="icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>è¨­å®š</a>
  </nav>

  <section data-view="home" class="container">
    <form id="form" autocomplete="off">
      <select id="direction" style="display:none"><option>æ”¯å‡º</option><option>æ”¶å…¥</option></select>
      
      <div class="card" style="padding-top: 24px;">
        <div class="seg-control">
          <div class="seg-item active" data-val="æ”¯å‡º" onclick="setDirection('æ”¯å‡º')">æ”¯å‡º</div>
          <div class="seg-item" data-val="æ”¶å…¥" onclick="setDirection('æ”¶å…¥')">æ”¶å…¥</div>
        </div>

        <div class="big-input-wrapper">
          <span class="currency-symbol">$</span>
          <input type="number" id="amount" class="big-input" placeholder="0" step="0.01" inputmode="decimal" oninput="saveDraft()">
          <label class="cam-btn">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zM20 5h-3.17L15 3H9L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-8 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
            <input type="file" id="imgInput" accept="image/*" multiple style="display:none">
          </label>
        </div>

        <div class="input-row"><span class="row-label">æ—¥æœŸ</span><input type="date" id="date" class="row-input" required onchange="saveDraft()"></div>
        <div class="input-row"><span class="row-label">åˆ†é¡</span><select id="category" class="row-input" onchange="saveDraft()"><option value="">é¸æ“‡åˆ†é¡</option><option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option><option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option></select></div>
        <div class="input-row"><span class="row-label">å¸³æˆ¶</span>
          <select id="account" class="row-input" onchange="saveDraft()">
            <option value="">é¸æ“‡å¸³æˆ¶</option>
            <option>é»ƒç¾é‡‘</option><option>è•­ç¾é‡‘</option>
            <option>åˆä½œé‡‘åº«</option><option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option>
            <option>é»ƒéƒµå±€</option><option>è•­LINE</option><option>å½°åŒ–éŠ€è¡Œ</option>
            <option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
            <option>è¯å—å¡</option><option>åœ‹æ³°å¡</option><option>è¯é‚¦å¡</option>
          </select>
        </div>
        <div class="input-row"><span class="row-label">é …ç›®</span><div style="flex:1;display:flex;justify-content:flex-end;gap:8px;"><input id="itemOther" class="row-input" placeholder="é …ç›®" style="display:none;border-bottom:1px dashed #94A3B8;" oninput="saveDraft()"><select id="itemSelect" class="row-input" onchange="saveDraft()"><option value="">é¸æ“‡é …ç›®</option><option value="é£Ÿç‰©">é£Ÿç‰©</option><option value="å…¬å¸ä»£å¢Š">å…¬å¸ä»£å¢Š</option><option value="ç©æ¨‚">ç©æ¨‚</option><option value="äº¤é€š">äº¤é€š</option><option value="å…¶ä»–">æ‰‹å‹•è¼¸å…¥...</option></select></div></div>
        <div class="input-row"><span class="row-label">å‚™è¨»</span><input id="note" class="row-input" placeholder="é¸å¡«" oninput="saveDraft()"></div>
        <div class="input-row" style="justify-content:space-between;"><span class="row-label">å¸³æˆ¶äº’è½‰</span><label class="switch"><input type="checkbox" id="isTransfer" onchange="saveDraft()"><span class="slider"></span></label></div>
        <div id="transferFields" class="input-row" style="display:none;background:#F1F5F9;"><span class="row-label" style="color:var(--primary)">è½‰å…¥è‡³</span>
          <select id="accountIn" class="row-input" onchange="saveDraft()">
            <option value="">é¸æ“‡è½‰å…¥å¸³æˆ¶</option>
            <option>é»ƒç¾é‡‘</option><option>è•­ç¾é‡‘</option>
            <option>åˆä½œé‡‘åº«</option><option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option>
            <option>é»ƒéƒµå±€</option><option>è•­LINE</option><option>å½°åŒ–éŠ€è¡Œ</option>
            <option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
            <option>è¯å—å¡</option><option>åœ‹æ³°å¡</option><option>è¯é‚¦å¡</option>
          </select>
        </div>
        
        <div id="imgPreview" class="img-preview-area" style="display:none"></div>
      </div>

      <div id="splitSection" style="display:none"><div class="group-title">åˆ†å¸³é è¦½</div><div class="card"><div id="splitList"></div></div></div>

      <div style="display:flex;gap:12px;">
        <button class="btn-main btn-ghost" type="button" id="btnAddSplit"><svg class="icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>åˆ†å¸³</button>
        <button class="btn-main" type="submit" id="btnSubmit"><svg class="icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>ç¢ºèª</button>
      </div>
      
      <div class="group-title">æœ€è¿‘æœ¬æ©Ÿç´€éŒ„</div>
      <div class="card">
        <div class="log" id="log" style="max-height:200px;overflow:auto;"></div>
        <div style="padding:12px;text-align:center;border-top:1px solid var(--border);"><span id="btnClear" style="color:var(--danger);font-size:12px;cursor:pointer">æ¸…é™¤ç´€éŒ„</span></div>
      </div>

      <div class="footer"><span class="ver-badge">v4.2</span><div class="ver-desc">é–‹æ”¾ç›¸ç°¿é¸åœ–ãƒ»è‡ªå‹•è¶…é€£çµãƒ»å¤šå¼µä¸Šå‚³</div></div>
    </form>
  </section>

  <section data-view="recent" class="container" hidden>
    <div class="card" style="padding:16px;">
      <div style="display:flex;gap:8px;margin-bottom:12px;"><input type="number" id="rLimit" value="10" class="row-input" style="background:var(--bg);border-radius:8px;padding:8px;text-align:center;" placeholder="ç­†æ•¸"><select id="rCategory" class="row-input" style="background:var(--bg);border-radius:8px;padding:8px;"><option value="">å…¨éƒ¨åˆ†é¡</option><option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option><option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option></select></div>
      <button class="btn-main" id="btnRecent" type="button" style="margin:0;padding:12px;">âŸ³ åˆ·æ–°åˆ—è¡¨</button>
    </div>
    <div id="recentList" style="padding-bottom:20px;"></div>
  </section>

  <section data-view="balance" class="container" hidden>
    <div class="card" style="padding:16px;">
       <h2 style="margin:0 0 16px;font-size:16px;color:var(--text);">ç•¶ä¸‹è³‡ç”¢ç¸½è¦½</h2>
       <button class="btn-main" id="btnBalance" type="button" style="margin-top:0;padding:12px;">æŸ¥è©¢æ‰€æœ‰é¤˜é¡</button>
    </div>
    <div class="card" id="balanceArea" style="display:none;padding:20px;">
       <div style="text-align:center;margin-bottom:24px;"><div style="font-size:12px;color:var(--text-light);margin-bottom:4px;">ç¸½è³‡ç”¢</div><div id="balanceTotal" style="font-size:36px;font-weight:700;color:var(--primary);">0.00</div></div>
       <div id="balanceListContainer"></div>
    </div>
  </section>

  <section data-view="settings" class="container" hidden>
    <div style="font-size:12px;color:#94A3B8;margin:24px 0 8px 8px;font-weight:600;">é€£ç·šè¨­å®š</div>
    <div class="card">
      <div class="input-row"><span class="row-label">API URL</span><input id="endpoint" class="row-input" value="https://script.google.com/macros/s/AKfycbzjpwoEGtRpX9FnQ0i-rSjvgaUB40gG44tBAcd_tI30R1X9HydICtdlSiooJXViatJZ/exec"></div>
      <div class="input-row"><span class="row-label">API Key</span><input id="apiKey" class="row-input" placeholder="é¸å¡«"></div>
      <div style="display:flex;padding:16px;gap:12px;"><button id="btnTest" style="flex:1;padding:12px;background:var(--bg);border:none;border-radius:10px;color:var(--text);">æ¸¬è©¦</button><button id="btnSaveCfg" style="flex:1;padding:12px;background:var(--text);color:#fff;border:none;border-radius:10px;">å„²å­˜</button></div>
    </div>
    <div style="font-size:12px;color:#94A3B8;margin:24px 0 8px 8px;font-weight:600;">Gmail åŒ¯å…¥</div>
    <div class="card" style="padding:16px;">
      <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center;"><input id="importDays" type="number" value="10" class="row-input" style="background:var(--bg);border-radius:8px;padding:8px;text-align:center;width:80px;" placeholder="å¤©æ•¸"><div style="flex:1;display:flex;align-items:center;justify-content:flex-end;gap:8px;"><span style="font-size:13px;color:var(--text);">å¼·åˆ¶é‡æŠ“</span><label class="switch" style="transform:scale(0.8);"><input type="checkbox" id="importForce"><span class="slider"></span></label></div></div>
      <button class="btn-main" id="btnImport" type="button" style="margin:0;">é–‹å§‹æŠ“å–å¸³å–®</button>
      <div id="importHint" style="text-align:center;font-size:12px;color:var(--text-light);margin-top:12px;">â€”</div>
    </div>
    
    <div style="text-align:center; margin-top:30px;">
      <button onclick="toggleLog()" style="background:none; border:none; color:var(--primary); font-size:12px; cursor:pointer; padding:10px;">ğŸ•’ æŸ¥çœ‹ç‰ˆæœ¬ç´€éŒ„</button>
      <div id="verLog">
        <ul>
          <li><span class="ver-date">2026-01-16</span><strong>v4.2:</strong> é–‹æ”¾ç›¸ç°¿é¸åœ– (æ”¯æ´æ‰‹æ©Ÿåœ–åº«)</li>
          <li><span class="ver-date">2026-01-16</span><strong>v4.0:</strong> æ–°å¢ç…§ç‰‡ä¸Šå‚³åŠŸèƒ½ï¼Œæ”¯æ´å¤šé¸èˆ‡è¶…é€£çµ</li>
          <li><span class="ver-date">2026-01-16</span><strong>v3.4:</strong> æ›´æ–°å¸³æˆ¶åˆ—è¡¨ (ç§»é™¤åˆ·å¡/æ–°å¢è¯å—/åœ‹æ³°/è¯é‚¦)</li>
          <li><span class="ver-date">2026-01-13</span><strong>v3.3:</strong> ä¿®å¾©æ˜ç´°æ›´æ–°å¤±æ•ˆ</li>
        </ul>
      </div>
    </div>
  </section>

  <div id="editModal" class="modal-overlay"><div class="modal-card"><div style="display:flex;justify-content:space-between;margin-bottom:20px;"><h3 style="margin:0;">ç·¨è¼¯ç´€éŒ„</h3><span onclick="closeEditModal()" style="font-size:24px;cursor:pointer;">&times;</span></div><div id="modalContent"></div></div></div>
  <div id="toast" class="toast">è¨Šæ¯</div>

<script>
let isSubmitting=false; let currentSplits=[]; let selectedImages=[];
// âœ… æ›´æ–°å¸³æˆ¶åˆ—è¡¨
const ACCOUNTS=['é»ƒç¾é‡‘','è•­ç¾é‡‘','åˆä½œé‡‘åº«','è•­éƒµå±€','è¯å—éŠ€è¡Œ','é»ƒéƒµå±€','è•­LINE','å½°åŒ–éŠ€è¡Œ','é»ƒä¸­ä¿¡','é»ƒLINE','åœ‹æ³°ä¸–è¯','è¯å—å¡','åœ‹æ³°å¡','è¯é‚¦å¡'];
const CATEGORIES=['å…±ç”¨','é»ƒæ”¯å‡º','è•­æ”¯å‡º','æ´‹æ”¯å‡º','ä¿¡ç”¨å¡','æ”¶å…¥','è² å‚µ','å¹³è¡¡','å…¬å¸ä»£å¢Š','å…¶ä»–'];
const ITEM_OPTIONS=['é£Ÿç‰©','å…¬å¸ä»£å¢Š','ç©æ¨‚','äº¤é€š','å…¶ä»–'];
const DRAFT_KEY='spend.draft.v4'; const SENT_KEY='spend.sent.v19'; 

window.addEventListener('DOMContentLoaded', () => {
  $('date').value=new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
  loadCfg(); restoreDraft(); renderLog(); route();
  populateModalSelects();
});

const $ = id => document.getElementById(id);
const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };
function cssEscape(s){ return String(s).replace(/[^a-zA-Z0-9_\-:.]/g,'_'); }
function getDeviceType() {
  let id = localStorage.getItem('spend.deviceId');
  if(!id) { id = Math.random().toString(36).substring(2,6).toUpperCase(); localStorage.setItem('spend.deviceId', id); }
  const ua = navigator.userAgent;
  let os = 'Web';
  if (/iPhone|iPad|iPod/i.test(ua)) os = 'iOS'; else if (/Android/i.test(ua)) os = 'Android'; else if (/Macintosh/i.test(ua)) os = 'Mac'; else if (/Windows/i.test(ua)) os = 'PC';
  return `${os} #${id}`;
}
function routeClick(name) { location.hash = '#' + name; }
function showView(name){ document.querySelectorAll('section[data-view]').forEach(sec=>sec.hidden = sec.dataset.view !== name); document.querySelectorAll('.nav-item').forEach(a => a.classList.toggle('active', a.getAttribute('href') === '#' + name)); }
function route(){ const name=(location.hash||'#home').slice(1); showView(['home','recent','balance','settings'].includes(name)?name:'home'); }
window.addEventListener('hashchange', route);
function toggleLog(){ const l=$('verLog'); l.style.display = l.style.display==='block'?'none':'block'; }

/* Image Handling */
$('imgInput').onchange = async function(e) {
  const files = e.target.files;
  if (!files || files.length === 0) return;
  
  for (let i = 0; i < files.length; i++) {
    const b64 = await compressImage(files[i]);
    selectedImages.push(b64);
  }
  renderImgPreview();
  this.value = ''; // Reset input
};

function renderImgPreview() {
  const div = $('imgPreview');
  if (selectedImages.length === 0) { div.style.display='none'; return; }
  div.style.display = 'flex';
  div.innerHTML = selectedImages.map((src, i) => 
    `<div class="img-thumb-wrap">
       <img src="${src}" class="img-thumb">
       <div class="img-del" onclick="removeImg(${i})">Ã—</div>
     </div>`
  ).join('');
}
window.removeImg = (i) => { selectedImages.splice(i, 1); renderImgPreview(); };

function compressImage(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (event) => {
      const img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const MAX_WIDTH = 800; // Limit width
        const scaleSize = MAX_WIDTH / img.width;
        canvas.width = MAX_WIDTH;
        canvas.height = img.height * scaleSize;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL('image/jpeg', 0.7)); // Compress
      };
    };
  });
}

function saveDraft() {
  const draft = { amount:$('amount').value, date:$('date').value, category:$('category').value, account:$('account').value, itemSelect:$('itemSelect').value, itemOther:$('itemOther').value, note:$('note').value, direction:$('direction').value, isTransfer:$('isTransfer').checked, accountIn:$('accountIn').value, splits:currentSplits };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
}
function restoreDraft() {
  const saved = localStorage.getItem(DRAFT_KEY); if (!saved) return;
  try {
    const d = JSON.parse(saved);
    if(d.date) $('date').value = d.date; if(d.amount) $('amount').value = d.amount; if(d.category) $('category').value = d.category; if(d.account) $('account').value = d.account; if(d.note) $('note').value = d.note; if(d.direction) setDirection(d.direction);
    $('itemSelect').value = d.itemSelect||''; $('itemOther').value = d.itemOther||'';
    if($('itemSelect').value==='å…¶ä»–') $('itemOther').style.display='block';
    $('isTransfer').checked = !!d.isTransfer; $('transferFields').style.display = d.isTransfer ? 'flex' : 'none';
    if(d.accountIn) $('accountIn').value = d.accountIn;
    if(d.isTransfer) $('category').disabled = true;
    if(d.splits && d.splits.length > 0) { currentSplits=d.splits; renderSplits(); }
  } catch(e){}
}
function resetForm() {
  localStorage.removeItem(DRAFT_KEY); currentSplits = []; selectedImages = []; renderImgPreview();
  $('splitList').innerHTML = ''; $('splitSection').style.display = 'none'; $('btnSubmit').textContent = 'ç¢ºèªé€å‡º';
  $('date').disabled = false; $('account').disabled = false;
  $('amount').value = ''; $('category').value = ''; $('account').value = ''; $('note').value = ''; 
  $('itemSelect').value = ''; $('itemOther').value = ''; $('itemOther').style.display = 'none';
  if($('isTransfer').checked) { $('isTransfer').checked = false; $('transferFields').style.display='none'; $('category').disabled = false; }
}

function setDirection(val) { $('direction').value = val; document.querySelectorAll('.seg-item').forEach(el => el.classList.toggle('active', el.dataset.val === val)); saveDraft(); }
$('itemSelect').onchange = ()=>{ const v = $('itemSelect').value; $('itemOther').style.display = v==='å…¶ä»–' ? 'block' : 'none'; if(v!=='å…¶ä»–') $('itemOther').value=''; saveDraft(); };
$('isTransfer').onchange = ()=>{
  const on = $('isTransfer').checked; $('transferFields').style.display = on ? 'flex' : 'none';
  if (on){ $('category').value='å¹³è¡¡'; $('category').disabled=true; $('itemSelect').value='å…¶ä»–'; $('itemOther').style.display='block'; $('itemOther').value='å…§æ§äº’è½‰'; $('direction').value='æ”¯å‡º'; if(currentSplits.length>0){toast('äº’è½‰å·²æ¸…é™¤åˆ†å¸³');currentSplits=[];renderSplits();} } 
  else { $('category').disabled=false; if($('itemOther').value==='å…§æ§äº’è½‰'){ $('itemOther').value=''; $('itemSelect').value=''; $('itemOther').style.display='none'; } }
  saveDraft();
};
function renderSplits() {
  const btnSubmit = $('btnSubmit'); const listDiv = $('splitList'); const section = $('splitSection');
  if (currentSplits.length === 0) { section.style.display = 'none'; listDiv.innerHTML = ''; btnSubmit.textContent = 'ç¢ºèªé€å‡º'; $('date').disabled = false; $('account').disabled = false; saveDraft(); return; }
  section.style.display = 'block'; let html = ''; let total = 0;
  currentSplits.forEach((s, i) => { const isOut = s.direction === 'æ”¯å‡º'; const signed = isOut ? s.amount : -s.amount; total += signed; html += `<div class="record-item"><div class="rec-left"><div class="rec-title">${s.category} - ${s.item}</div></div><div class="rec-right"><span class="rec-amt ${isOut?'neg':'pos'}">${isOut?'-':''}${s.amount}</span><span style="color:var(--danger);font-size:18px;margin-left:10px;cursor:pointer" onclick="delSplit(${i})">âœ•</span></div></div>`; });
  html += `<div style="padding:10px;text-align:right;font-weight:600;color:var(--primary)">æš«å­˜ç¸½è¨ˆ: ${total.toFixed(2)}</div>`;
  listDiv.innerHTML = html; btnSubmit.textContent = `é€å‡º ${currentSplits.length} ç­†åˆ†å¸³`;
  $('date').disabled = true; $('account').disabled = true; saveDraft();
}
window.delSplit = (i) => { currentSplits.splice(i, 1); renderSplits(); };
$('btnAddSplit').onclick = () => {
  if (currentSplits.length === 0) { if (!$('date').value) return toast('è«‹å¡«æ—¥æœŸ'); if (!$('account').value) return toast('è«‹é¸å¸³æˆ¶'); }
  const amt = Number($('amount').value || 0); const cat = $('category').value; 
  const item = ($('itemSelect').value==='å…¶ä»–') ? $('itemOther').value.trim() : $('itemSelect').value;
  if ($('isTransfer').checked) return toast('äº’è½‰ç„¡æ³•åˆ†å¸³');
  if (!amt || amt <= 0) return toast('è«‹è¼¸é‡‘é¡'); if (!cat) return toast('è«‹é¸åˆ†é¡'); if (!item) return toast('è«‹è¼¸é …ç›®');
  currentSplits.push({ amount: amt, category: cat, item: item, note: $('note').value.trim(), direction: $('direction').value });
  renderSplits(); $('amount').value = ''; $('note').value = ''; $('amount').focus();
};

/* Submit using JSON Payload */
$('form').onsubmit = (e) => {
  e.preventDefault(); if (isSubmitting) return;
  const amt = Number($('amount').value); const isXfer = $('isTransfer').checked;
  
  if (!$('account').value) return toast('è«‹é¸æ“‡å¸³æˆ¶');

  if (currentSplits.length === 0) {
    if (!amt || amt <= 0) return toast('è«‹è¼¸å…¥é‡‘é¡');
    if (!isXfer) {
        if (!$('category').value) return toast('è«‹é¸æ“‡åˆ†é¡');
        const it = ($('itemSelect').value==='å…¶ä»–') ? $('itemOther').value.trim() : $('itemSelect').value;
        if (!it) return toast('è«‹è¼¸å…¥é …ç›®');
    }
    if (isXfer && !$('accountIn').value) return toast('è«‹é¸æ“‡è½‰å…¥å¸³æˆ¶');
  }
  
  isSubmitting = true; 
  const btn = $('btnSubmit'); 
  const originalText = btn.textContent;
  btn.textContent = 'ä¸Šå‚³ä¸­...'; 
  btn.disabled = true;
  
  const norm = s => s.replace(/^åˆä½œ$/,'åˆä½œé‡‘åº«').replace(/^è•­è³´$/,'è•­LINE');
  const payload = { 
    date: $('date').value, 
    account: norm($('account').value), 
    apiKey: $('apiKey').value.trim(), 
    device: getDeviceType(),
    images: selectedImages // Add images
  };
  
  const ts = new Date().toLocaleString('sv').replace(' ','T');
  const addLog = (o) => addSent({ts, date:payload.date, account:payload.account, ...o});

  if (currentSplits.length > 0) {
    payload.action = 'split_add'; payload.splits_json = JSON.stringify(currentSplits);
    currentSplits.forEach(s => addLog({direction:s.direction, amount:s.amount, category:s.category, item:s.item, note:s.note}));
  } else {
    Object.assign(payload, { amount: amt, category: isXfer?'å¹³è¡¡':$('category').value, item: isXfer?'å…§æ§äº’è½‰':(($('itemSelect').value==='å…¶ä»–')?$('itemOther').value:$('itemSelect').value), note: $('note').value });
    if (isXfer) {
      payload.isTransfer = 'true'; payload.accountIn = norm($('accountIn').value);
      addLog({direction:'æ”¯å‡º', amount:amt, category:payload.category, item:payload.item, note:payload.note});
      addLog({direction:'æ”¶å…¥', amount:amt, category:payload.category, account:payload.accountIn, item:payload.item, note:payload.note});
    } else {
      payload.direction = $('direction').value;
      addLog({direction:payload.direction, amount:amt, category:payload.category, item:payload.item, note:payload.note});
    }
  }
  
  // Use fetch with JSON body for large payload
  fetch($('endpoint').value, {
    method: 'POST',
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if(data.ok) {
        toast(currentSplits.length > 0 ? `é€å‡º ${currentSplits.length} ç­†` : 'è¨˜å¸³æˆåŠŸ');
        renderLog();
        setTimeout(() => { resetForm(); }, 500);
    } else {
        toast('å¤±æ•—: ' + (data.error || 'æœªçŸ¥'));
    }
  })
  .catch(err => { toast('é€£ç·šå¤±æ•—'); })
  .finally(() => {
    isSubmitting = false; 
    btn.disabled = false; 
    btn.textContent = originalText;
  });
};

function loadSent(){ try{return JSON.parse(localStorage.getItem(SENT_KEY)||'[]');}catch{return[];} }
function saveSent(list){ localStorage.setItem(SENT_KEY, JSON.stringify(list.slice(-50))); }
function addSent(rec){ const list=loadSent(); list.push(rec); saveSent(list); }
function renderLog(){
  const list=loadSent().slice().reverse(); const el=$('log');
  if(!list.length){ el.innerHTML='<div style="padding:20px;text-align:center;font-size:12px;color:#ccc">å°šç„¡ç´€éŒ„</div>'; return; }
  let h='';
  for(const r of list){
    const isOut = r.direction==='æ”¯å‡º'; const amt = Math.abs(Number(r.amount)); const sign = isOut ? '-' : '';
    h += `<div class="record-item"><div class="rec-left"><div class="rec-title">${r.item}</div><div class="rec-meta"><span class="rec-tag">${r.category}</span><span>${r.date.slice(5)}</span></div></div><div class="rec-right"><span class="rec-amt ${isOut?'neg':'pos'}">${sign}${amt}</span></div></div>`;
  }
  el.innerHTML=h;
}
$('btnClear').onclick=()=>{ if(confirm('æ¸…é™¤?')) { localStorage.removeItem(SENT_KEY); renderLog(); }};

$('btnBalance').onclick=async()=>{
  const ep=$('endpoint').value.trim(); if(!ep) return;
  const btn = $('btnBalance'); btn.textContent = 'è¨ˆç®—ä¸­...'; btn.disabled = true;
  $('balanceListContainer').innerHTML=''; $('balanceTotal').textContent='...'; $('balanceArea').style.display='block';
  try {
     const p = new URLSearchParams({balance:'1', by:'account'});
     const res = await fetch(ep+'?'+p); const data = await res.json();
     if(!data.ok) throw new Error(data.error || 'Unknown Error');
     let h='';
     if(data.breakdown) {
       data.breakdown.forEach(b => {
         h += `<div style="display:flex;justify-content:space-between;padding:12px;border-bottom:1px solid #eee;font-size:15px;"><span style="color:var(--text)">${b.account}</span><span style="font-family:monospace;font-weight:600;">${b.balance.toFixed(2)}</span></div>`;
       });
       $('balanceListContainer').innerHTML = h; $('balanceTotal').textContent = data.total.toFixed(2);
     } else { $('balanceListContainer').innerHTML = '<div style="text-align:center;padding:20px">ç„¡è³‡æ–™</div>'; }
  } catch(e) { $('balanceListContainer').innerHTML=`<div style="color:red;text-align:center">${e.message}</div>`; }
  btn.textContent = 'æŸ¥è©¢æ‰€æœ‰é¤˜é¡'; btn.disabled = false;
};

$('btnRecent').onclick=async()=>{
  const ep=$('endpoint').value.trim(); if(!ep) return;
  $('recentList').innerHTML='<div style="text-align:center;padding:20px">è¼‰å…¥ä¸­...</div>';
  try {
    const p = new URLSearchParams({recent:$('rLimit').value});
    if($('rCategory').value) p.set('category',$('rCategory').value);
    const res = await fetch(ep+'?'+p); const data = await res.json();
    if(data.records) {
      let h='';
      data.records.forEach(r => {
         const isOut = r.direction==='æ”¯å‡º'; const amt = Math.abs(Number(r.amount));
         const dateDay = String(r.date).substring(0, 10).slice(5);
         const dev = r.device ? `<span style="font-size:10px;background:#eee;padding:1px 4px;border-radius:3px">${r.device.split('#')[0]}</span>` : '';
         // Show photo icon if exists
         const photoIcon = r.photos ? `<a href="${r.photos.split('\n')[0]}" target="_blank" style="text-decoration:none;margin-left:4px">ğŸ“¸</a>` : '';
         h += `<div class="card" style="padding:0;margin-bottom:12px;" onclick='openEditModal(${JSON.stringify(r)})'><div class="record-item" style="border:none;cursor:pointer"><div class="rec-left"><div class="rec-title">${r.item} ${photoIcon} <span style="font-weight:400;color:#94A3B8;font-size:12px">${r.note?`(${r.note})`:''}</span></div><div class="rec-meta"><span class="rec-tag">${r.category}</span><span class="rec-tag">${r.account}</span>${dev}</div><div class="rec-dates">æ¶ˆè²»: ${dateDay}</div></div><div class="rec-right"><span class="rec-amt ${isOut?'neg':'pos'}">${isOut?'-':''}${amt}</span></div></div></div>`;
      });
      $('recentList').innerHTML = h || '<div style="text-align:center">ç„¡è³‡æ–™</div>';
    }
  } catch(e){ $('recentList').innerHTML='è¼‰å…¥å¤±æ•—'; }
};

function populateModalSelects() {
  const fill = (id, list) => { const el=$(id); if(!el)return; el.innerHTML=''; list.forEach(v=>{const op=document.createElement('option');op.value=v;op.textContent=v;el.appendChild(op)}); };
  fill('modal-cat', CATEGORIES); fill('modal-acc', ACCOUNTS); fill('modal-accIn', ACCOUNTS); 
  const itemEl=$('modal-itemSel'); if(itemEl){ itemEl.innerHTML=''; ITEM_OPTIONS.forEach(v=>{const op=document.createElement('option');op.value=v;op.textContent=v;itemEl.appendChild(op)}); const op=document.createElement('option');op.value='å…¶ä»–';op.textContent='å…¶ä»–';itemEl.appendChild(op); }
}
function openEditModal(r) {
  const amt = Math.abs(Number(r.amount)); const isOut = r.direction === 'æ”¯å‡º'; const isTransfer = (r.category==='å¹³è¡¡' && r.item==='å…§æ§äº’è½‰');
  let html = `<div class="big-input-wrapper"><span class="currency-symbol">$</span><input id="m-amt" type="number" class="big-input" value="${amt}"></div>
    <div class="input-row"><span class="row-label">é …ç›®</span><div style="flex:1"><input id="m-item" class="row-input" value="${r.item}"></div></div>
    <div class="input-row"><span class="row-label">å‚™è¨»</span><input id="m-note" class="row-input" value="${r.note||''}"></div>
    <div class="input-row"><span class="row-label">åˆ†é¡</span><select id="m-cat" class="row-input">${makeOpts(CATEGORIES,r.category)}</select></div>
    <div class="input-row"><span class="row-label">å¸³æˆ¶</span><select id="m-acc" class="row-input">${makeOpts(ACCOUNTS,r.account)}</select></div>
    <div style="display:flex;gap:12px;margin-top:20px;"><button class="btn-main" onclick="saveModal('${r.createdAt}', ${isTransfer}, '${isOut?'æ”¯å‡º':'æ”¶å…¥'}')">å„²å­˜</button><button class="btn-main" style="background:#FEE2E2;color:var(--danger);box-shadow:none" onclick="delModal('${r.createdAt}')">åˆªé™¤</button></div>`;
  $('modalContent').innerHTML = html; $('editModal').classList.add('open');
}
function closeEditModal(){ $('editModal').classList.remove('open'); }
function makeOpts(l,s){ return l.map(v=>`<option value="${v}" ${v===s?'selected':''}>${v}</option>`).join(''); }
async function saveModal(key, isTransfer, dir){
  const amt=$('m-amt').value; if(!amt) return toast('è«‹è¼¸é‡‘é¡');
  const payload = { action:'update', createdAt:key, amount:amt, note:$('m-note').value, account:$('m-acc').value, category:$('m-cat').value, item:$('m-item').value, apiKey:$('apiKey').value.trim() };
  if(!isTransfer) payload.direction = dir;
  closeEditModal(); toast('æ›´æ–°ä¸­...');
  try { await fetch($('endpoint').value.trim(), {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams(payload).toString()}); toast('å·²æ›´æ–°'); $('btnRecent').click(); } catch(e) { toast('æ›´æ–°å¤±æ•—'); }
}
function delModal(key){ if(confirm('åˆªé™¤?')) { closeEditModal(); 
  fetch($('endpoint').value, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:`action=delete&createdAt=${key}&apiKey=${$('apiKey').value}`})
  .then(()=>{ toast('å·²åˆªé™¤'); $('btnRecent').click(); });
}}

$('btnImport').onclick=async()=>{
  const ep=$('endpoint').value.trim();
  $('importHint').textContent='ç³»çµ±è™•ç†ä¸­...';
  try {
    const res = await fetch(ep, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:`action=ingest_gmail&days=${$('importDays').value}&force=${$('importForce').checked}&apiKey=${$('apiKey').value}`});
    const d = await res.json();
    if(d.ok) { toast(`æ–°å¢ ${d.added} ç­†`); $('importHint').textContent=`âœ… æˆåŠŸæ–°å¢ ${d.added} ç­†`; } else throw d;
  } catch(e) { $('importHint').textContent='âŒ å¤±æ•—'; }
};

function loadCfg(){ if(localStorage.getItem('spend.endpoint')) $('endpoint').value = localStorage.getItem('spend.endpoint'); if(localStorage.getItem('spend.apiKey')) $('apiKey').value = localStorage.getItem('spend.apiKey'); }
$('btnSaveCfg').onclick=()=>{ localStorage.setItem('spend.endpoint',$('endpoint').value); localStorage.setItem('spend.apiKey',$('apiKey').value); toast('è¨­å®šå·²å„²å­˜'); };
$('btnTest').onclick=()=>{ fetch($('endpoint').value+'?ping=1').then(r=>toast(r.ok?'âœ… é€šè¡Œ':'âŒ å¤±æ•—')).catch(()=>toast('âŒ å¤±æ•—')); };
</script>
</body>
</html>
