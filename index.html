<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>æ”¶æ”¯å¿«è¨˜ï½œSPA</title>
<style>
  /* æ¥µç°¡æ·±è‰²ï¼ˆç„¡æ¼¸å±¤ï¼‰ï¼Œè¡Œå‹•å„ªå…ˆ */
  *, *::before, *::after { box-sizing: border-box; }
  :root{
    --bg:#0e1116; --panel:#141820; --panel2:#0f131a;
    --text:#e7eaf0; --muted:#9aa3af; --line:#2b3240; --brand:#3b82f6; --ok:#86efac; --bad:#fca5a5;
    --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.28);
  }
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
       background:var(--bg); color:var(--text);}
  .container{max-width:720px;margin:auto;padding:12px 12px 72px}
  .tabs{position:sticky;top:0;z-index:30;background:var(--bg);padding:8px 12px;border-bottom:1px solid var(--line)}
  .tabbar{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .tab{display:flex;gap:8px;align-items:center;justify-content:center;
       padding:10px 12px;border:1px solid var(--line);border-radius:12px;color:var(--text);text-decoration:none;
       background:var(--panel);font-size:14px}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff;box-shadow:var(--shadow)}
  section[hidden]{display:none}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0;box-shadow:var(--shadow)}
  h1{font-size:18px;margin:0 0 8px}
  h2{font-size:14px;margin:0 0 6px;color:var(--muted)}
  label{font-size:14px;display:block;margin:10px 0 6px}
  .muted{color:var(--muted);font-size:12px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  input,select{display:block;width:100%;max-width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:var(--panel2);color:var(--text);font-size:16px}
  .inline{display:flex;gap:10px;align-items:center}
  .inline > *{flex:1}
  .rowbtns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:12px 14px;border:none;border-radius:12px;background:var(--brand);color:#fff;font-weight:700;font-size:16px;cursor:pointer}
  .btn.secondary{background:#465874}
  .log{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:12px}
  .log table{width:100%;border-collapse:collapse;font-size:14px}
  .log th,.log td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
  .neg{color:var(--bad)} .pos{color:var(--ok)}
  .list{display:grid;gap:10px;margin-top:8px}
  .list-item{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:12px}
  .list-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;gap:10px}
  .list-amt{font-weight:800; font-size:18px}
  .list-amt.neg{color:var(--bad)} .list-amt.pos{color:var(--ok)}
  .list-meta{color:var(--muted);font-size:12px;display:flex;flex-wrap:wrap;gap:6px}
  .list-body{margin-top:2px;font-size:14px}
  .clamp2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .table{width:100%;border-collapse:collapse;margin-top:8px}
  .table th,.table td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  .right{text-align:right}
  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--panel2);color:var(--text);border:1px solid var(--line);padding:10px 12px;border-radius:12px;display:none;box-shadow:var(--shadow);max-width:90%}
  .toast.show{display:block}
  @media (max-width:420px){
    h1{font-size:17px}
    .tab{font-size:13px;padding:9px 10px}
    input,select{font-size:15px}
  }
</style>
</head>
<body>

<div class="tabs">
  <div class="tabbar">
    <a class="tab" href="#home">ğŸ§¾ è¨˜å¸³</a>
    <a class="tab" href="#recent">ğŸ•’ æœ€æ–°</a>
    <a class="tab" href="#balance">ğŸ“Š é¤˜é¡</a>
    <a class="tab" href="#settings">âš™ï¸ è¨­å®š</a>
  </div>
</div>

<div class="container">
  <!-- è¨˜å¸³ -->
  <section data-view="home">
    <div class="card">
      <h1>æ”¶æ”¯å¿«è¨˜</h1>
      <form id="form" autocomplete="off" style="margin-top:8px">
        <label>æ—¥æœŸ</label><input type="date" id="date" required>
        <label>ç™»è¨˜äºº</label>
        <select id="owner"><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
        <label>æ–¹å‘</label>
        <select id="direction"><option>æ”¯å‡º</option><option>æ”¶å…¥</option></select>
        <label>é‡‘é¡</label><input type="number" id="amount" min="0.01" step="0.01" inputmode="decimal" required>
        <label>åˆ†é¡</label>
        <select id="category">
          <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
          <option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option>
          <option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option>
        </select>
        <label>å¸³æˆ¶ï¼ˆè½‰å‡ºå¸³æˆ¶ï¼‰</label>
        <select id="account">
          <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
          <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
          <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
          <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
        </select>
        <label>é …ç›®</label>
        <div class="inline">
          <select id="itemSelect">
            <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
            <option value="é£Ÿç‰©">é£Ÿç‰©</option><option value="å…¬å¸ä»£å¢Š">å…¬å¸ä»£å¢Š</option>
            <option value="ç©æ¨‚">ç©æ¨‚</option><option value="äº¤é€š">äº¤é€š</option>
            <option value="å…¶ä»–">å…¶ä»–ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
          </select>
          <input id="itemOther" placeholder="è¼¸å…¥å…¶ä»–é …ç›®" style="display:none">
        </div>

        <!-- äº’è½‰åˆ‡æ›ï¼šåŒä¸€è¡Œ -->
        <div class="inline" style="margin-top:10px;align-items:center">
          <label style="display:flex;align-items:center;gap:8px;margin:0">
            <input type="checkbox" id="isTransfer" style="width:20px;height:20px"> äº’è½‰
          </label>
        </div>

        <div id="transferFields" style="display:none;margin-top:8px">
          <label>è½‰å…¥å¸³æˆ¶</label>
          <select id="accountIn">
            <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
            <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
            <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
            <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
          </select>
        </div>

        <label style="margin-top:10px">å‚™è¨»</label><input id="note" placeholder="">
        <div class="rowbtns"><button class="btn" type="submit">é€å‡º</button></div>
      </form>
    </div>

    <div class="card">
      <h1>ç™¼é€ç´€éŒ„</h1>
      <div class="rowbtns">
        <button class="btn secondary" id="btnExport" type="button">åŒ¯å‡º CSV</button>
        <button class="btn secondary" id="btnClear" type="button">æ¸…é™¤ç´€éŒ„</button>
      </div>
      <p class="muted">åƒ…å„²å­˜åœ¨æ­¤è£ç½®ï¼ˆæœ¬æ©Ÿï¼‰ï¼Œæœ€å¤šä¿ç•™ 50 ç­†ã€‚</p>
      <div class="log" id="log"></div>
    </div>
  </section>

  <!-- æœ€æ–° -->
  <section data-view="recent" hidden>
    <div class="card">
      <h1>æœ€æ–° N ç­†ï¼ˆé›²ç«¯ï¼‰</h1>
      <div class="inline">
        <input type="number" id="rLimit" value="10" min="1" max="50" style="max-width:120px" />
        <select id="rAccount">
          <option value="">å…¨éƒ¨å¸³æˆ¶</option>
          <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
          <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
          <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
        </select>
      </div>
      <div class="inline" style="margin-top:8px">
        <select id="rCategory">
          <option value="">å…¨éƒ¨åˆ†é¡</option>
          <option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option>
          <option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option>
        </select>
        <select id="rOwner"><option value="">å…¨éƒ¨ç™»è¨˜äºº</option><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
      </div>
      <div class="rowbtns"><button class="btn secondary" id="btnRecent" type="button">æŸ¥è©¢æœ€æ–°ç´€éŒ„</button></div>
      <p class="muted mono" id="recentHint">â€”</p>
      <div class="list" id="recentList" style="display:none"></div>
    </div>
  </section>

  <!-- é¤˜é¡ -->
  <section data-view="balance" hidden>
    <div class="card">
      <h1>é¤˜é¡æŸ¥è©¢</h1>
      <div class="inline">
        <input id="qMonth" placeholder="æœˆä»½ï¼ˆyyyy-MMï¼Œå¯ç•™ç©ºï¼‰">
        <select id="qOwner"><option value="">ï¼ˆå…¨éƒ¨ï¼‰</option><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
      </div>
      <div class="rowbtns"><button class="btn secondary" id="btnBalance" type="button">æŸ¥è©¢å„å¸³æˆ¶é¤˜é¡</button></div>
      <div id="balanceArea">
        <p class="muted mono" id="balanceResult">â€”</p>
        <table class="table" id="balanceTable" style="display:none">
          <thead><tr><th>å¸³æˆ¶</th><th class="right">é¤˜é¡</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><th>ç¸½è¨ˆ</th><th class="right" id="balanceTotal">0.00</th></tr></tfoot>
        </table>
      </div>
    </div>
  </section>

  <!-- è¨­å®š -->
  <section data-view="settings" hidden>
    <div class="card">
      <h1>è¨­å®š</h1>
      <label>Endpoint URL</label>
      <input id="endpoint" value="https://script.google.com/macros/s/AKfycbzjpwoEGtRpX9FnQ0i-rSjvgaUB40gG44tBAcd_tI30R1X9HydICtdlSiooJXViatJZ/exec">
      <label>API Keyï¼ˆå¯ç•™ç©ºï¼‰</label><input id="apiKey">
      <div class="rowbtns">
        <button class="btn secondary" id="btnTest" type="button">é€£ç·šæ¸¬è©¦</button>
        <button class="btn secondary" id="btnSaveCfg" type="button">å„²å­˜è¨­å®š</button>
      </div>
      <p class="muted mono" id="cfgHint"></p>
    </div>

    <div class="card">
      <h1>å¤–é€å¸³å–®åŒ¯å…¥</h1>
      <div class="inline">
        <input id="importDays" type="number" min="1" max="90" value="10" placeholder="æœ€è¿‘ N å¤©ï¼ˆé è¨­ 10ï¼‰">
        <button class="btn secondary" id="btnImport" type="button">æŠ“å–å¤–é€å¸³å–®</button>
      </div>
      <div class="inline" style="margin-top:8px;align-items:center">
        <label style="display:flex;align-items:center;gap:8px;margin:0">
          <input type="checkbox" id="resetWindow" style="width:18px;height:18px"> å…è¨±é‡æ–°åŒ¯å…¥æœ¬è¦–çª—
        </label>
      </div>
      <p class="muted">åªæŠ“ foodpanda / Uber Eats è¨‚å–®ï¼ˆæ’é™¤ç™¼ç¥¨ã€é€€æ¬¾ï¼‰ï¼Œä¸é‡è¤‡å¯«å…¥ã€Šæ˜ç´°ã€‹ï¼›å‹¾é¸ã€Œå…è¨±é‡æ–°åŒ¯å…¥ã€æœƒæ¸…é™¤æ­¤è¦–çª—çš„å·²è™•ç†æ¸…å–®ã€‚</p>
      <p class="muted mono" id="importHint">â€”</p>
    </div>
  </section>
</div>

<div id="toast" class="toast"></div>

<script>
/* Router */
function showView(name){
  document.querySelectorAll('section[data-view]').forEach(sec=>sec.hidden = sec.dataset.view !== name);
  document.querySelectorAll('.tabbar .tab').forEach(a=>a.classList.toggle('active', a.getAttribute('href') === '#'+name));
}
function route(){ const name=(location.hash||'#home').slice(1); showView(['home','recent','balance','settings'].includes(name)?name:'home'); }
window.addEventListener('hashchange', route);

/* Utils */
const $ = id => document.getElementById(id);
const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); };
function cssEscape(s){ return String(s).replace(/[^a-zA-Z0-9_\-:.]/g,'_'); }

/* å¸¸é‡ */
const ACCOUNTS = ['é»ƒç¾é‡‘','åˆ·å¡','è•­ç¾é‡‘','åˆä½œé‡‘åº«','è•­éƒµå±€','è¯å—éŠ€è¡Œ','é»ƒéƒµå±€','è•­LINE','å½°åŒ–éŠ€è¡Œ','é»ƒä¸­ä¿¡','é»ƒLINE','åœ‹æ³°ä¸–è¯'];
const CATEGORIES = ['å…±ç”¨','é»ƒæ”¯å‡º','è•­æ”¯å‡º','æ´‹æ”¯å‡º','ä¿¡ç”¨å¡','æ”¶å…¥','è² å‚µ','å¹³è¡¡','å…¬å¸ä»£å¢Š','å…¶ä»–'];
const ITEM_OPTIONS = ['é£Ÿç‰©','å…¬å¸ä»£å¢Š','ç©æ¨‚','äº¤é€š','å…¶ä»–'];
const OWNERS = ['æ¬£å®œ','å–¬çŒ·'];

/* åˆå§‹ */
(function init(){
  $('date').value = new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
  fetch($('endpoint').value.trim() + '?ping=1').catch(()=>{});
  loadCfg(); renderLog(); route();
})();

/* è¨˜å¸³ï¼šé …ç›®å…¶ä»– */
const itemSelect = $('itemSelect'), itemOther = $('itemOther');
itemSelect.onchange = ()=>{ if(itemSelect.value==='å…¶ä»–'){ itemOther.style.display='block'; itemOther.focus(); } else { itemOther.style.display='none'; itemOther.value=''; } };

/* è¨˜å¸³ï¼šäº’è½‰åˆ‡æ› */
$('isTransfer').onchange = ()=>{
  const on = $('isTransfer').checked;
  $('transferFields').style.display = on ? 'block' : 'none';
  if (on){ $('category').value='å¹³è¡¡'; $('category').disabled=true; itemSelect.value='å…¶ä»–'; itemOther.style.display='block'; itemOther.value='å…§æ§äº’è½‰'; }
  else { $('category').disabled=false; if($('category').value==='å¹³è¡¡') $('category').value=''; if(itemSelect.value==='å…¶ä»–' && itemOther.value==='å…§æ§äº’è½‰'){ itemOther.value=''; itemOther.style.display='none'; itemSelect.value=''; } }
};

/* æœ¬æ©Ÿç™¼é€ç´€éŒ„ */
const SENT_KEY='spend.sent.v20';
function loadSent(){ try{return JSON.parse(localStorage.getItem(SENT_KEY)||'[]');}catch{return[];} }
function saveSent(list){ localStorage.setItem(SENT_KEY, JSON.stringify(list.slice(-50))); }
function addSent(rec){ const list=loadSent(); list.push(rec); saveSent(list); }
function renderLog(){
  const list=loadSent().slice().reverse();
  if(!list.length){ $('log').innerHTML='<div class="muted" style="padding:12px">å°šç„¡ç´€éŒ„</div>'; return; }
  let html='<table><thead><tr><th>æ™‚é–“</th><th>æ–¹å‘/é‡‘é¡</th><th>åˆ†é¡/å¸³æˆ¶</th><th>é …ç›®/å‚™è¨»</th><th>ç™»è¨˜äºº</th></tr></thead><tbody>';
  for(const r of list){
    const isOut=r.direction==='æ”¯å‡º'; const amt=Math.abs(Number(r.amount||0));
    html+=`<tr><td class="muted">${r.ts||''}</td><td class="${isOut?'neg':'pos'}">${r.direction} ${isOut?'-':''}${amt.toFixed(2)}</td>
      <td>${r.category}ï½œ${r.account}</td><td>${r.item||''}ï½œ${r.note||''}</td><td>${r.owner||''}</td></tr>`;
  }
  html+='</tbody></table>'; $('log').innerHTML=html;
}
$('btnExport').onclick=()=>{
  const list=loadSent(); const header=['æ—¥æœŸ','æ™‚é–“æˆ³','æ–¹å‘','é‡‘é¡','åˆ†é¡','å¸³æˆ¶','é …ç›®','å‚™è¨»','ç™»è¨˜äºº'];
  const rows=[header.join(',')];
  const esc=s=>{if(s==null)return'';const t=String(s).replace(/"/g,'""');return /[",\n]/.test(t)?`"${t}"`:t;}
  for(const r of list){ rows.push([r.date||'',r.ts||'',r.direction||'',r.amount||'',r.category||'',r.account||'',r.item||'',r.note||'',r.owner||''].map(esc).join(',')); }
  const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'}),url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='spend-log.csv'; a.click(); URL.revokeObjectURL(url);
};
$('btnClear').onclick=()=>{ if(confirm('æ¸…é™¤æœ¬æ©Ÿç™¼é€ç´€éŒ„ï¼Ÿ')){ localStorage.removeItem(SENT_KEY); renderLog(); } };

/* èƒŒæ™¯é€å‡º */
function backgroundSend(url, payloadObj){
  const body=new URLSearchParams(payloadObj).toString();
  const mime='application/x-www-form-urlencoded;charset=UTF-8';
  if(navigator.sendBeacon){ navigator.sendBeacon(url,new Blob([body],{type:mime})); }
  else{ fetch(url,{method:'POST',headers:{'Content-Type':mime},body,keepalive:true}).catch(()=>{}); }
}

/* æ–°å¢é€å‡º */
$('form').onsubmit=(e)=>{
  e.preventDefault();
  const date=$('date').value, owner=$('owner').value, direction=$('direction').value, amount=$('amount').value, isXfer=$('isTransfer').checked;
  const category=isXfer?'å¹³è¡¡':$('category').value;
  const account=$('account').value;
  const item=isXfer?'å…§æ§äº’è½‰':((itemSelect.value==='å…¶ä»–')?$('itemOther').value.trim():itemSelect.value);
  const note=$('note').value.trim();
  const accountIn=$('accountIn').value;
  if(!date||!amount||Number(amount)<=0){ toast('è«‹è¼¸å…¥æ—¥æœŸèˆ‡é‡‘é¡'); return; }
  if(!category && !isXfer){ toast('è«‹é¸æ“‡åˆ†é¡'); return; }
  if(!account && !isXfer){ toast('è«‹é¸æ“‡å¸³æˆ¶'); return; }
  if(!item){ toast('è«‹é¸æ“‡æˆ–è¼¸å…¥é …ç›®'); return; }
  if(isXfer&&!accountIn){ toast('è«‹é¸æ“‡è½‰å…¥å¸³æˆ¶'); return; }

  const endpoint=$('endpoint').value.trim(); const apiKey=$('apiKey').value.trim();
  const d=new Date(); const pad=n=>String(n).padStart(2,'0'); const ts=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  const norm=s=>s.replace(/^åˆä½œ$/,'åˆä½œé‡‘åº«').replace(/^è•­è³´$/,'è•­LINE');

  if(isXfer){
    addSent({ts,date,owner,direction:'æ”¯å‡º',amount:Number(amount),category,account:norm(account),item,note});
    addSent({ts,date,owner,direction:'æ”¶å…¥',amount:Number(amount),category,account:norm(accountIn),item,note});
  }else{
    addSent({ts,date,owner,direction,amount:Number(amount),category,account:norm(account),item,note});
  }
  renderLog();
  $('amount').value=''; $('itemOther').value=''; $('note').value='';
  if(isXfer){ $('isTransfer').checked=false; $('transferFields').style.display='none'; $('category').disabled=false; }
  toast(isXfer?'å·²é€å‡ºï¼ˆèƒŒæ™¯è™•ç†ï¼šäº’è½‰Ã—2ï¼‰':'å·²é€å‡ºï¼ˆèƒŒæ™¯è™•ç†ï¼‰');

  const payload={ date, owner, amount, category, account:norm(account), item, note, apiKey };
  if(isXfer){ payload.isTransfer='true'; payload.accountIn=norm(accountIn); } else { payload.direction=direction; }
  backgroundSend(endpoint,payload);
};

/* æœ€æ–°ï¼šæŸ¥è©¢èˆ‡æ¸²æŸ“ï¼ˆå«å¿«ç…§ç´¢å¼•ï¼‰ */
let RECENT_CACHE = [];                   // è¨˜æ†¶é«”å¿«å–ï¼ˆå¡ç‰‡é¡¯ç¤º + fallbackï¼‰
const RECENT_INDEX = new Map();          // key -> index

$('btnRecent').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆè¨­å®š Endpoint'); return; }
  const limit=Math.max(1,Math.min(50,Number($('rLimit').value)||10));
  const params=new URLSearchParams({recent:String(limit)});
  const acc=$('rAccount').value.trim(), cat=$('rCategory').value.trim(), own=$('rOwner').value.trim();
  if(acc)params.set('account',acc); if(cat)params.set('category',cat); if(own)params.set('owner',own);
  $('recentHint').textContent='æŸ¥è©¢ä¸­â€¦'; $('recentList').style.display='none';
  try{
    const res=await fetch(`${endpoint}?${params.toString()}`); if(!res.ok) throw 0;
    const data=await res.json(); if(!data.ok||!Array.isArray(data.records)) throw 0;
    RECENT_CACHE = data.records.slice();
    RECENT_INDEX.clear();
    RECENT_CACHE.forEach((r,i)=>{ const k=r.createdAt? r.createdAt : `${r.date}|${r.amount}|${r.direction}|${r.owner}|${r.item}|${r.account}|${r.category}|${r.note}`; RECENT_INDEX.set(k,i); });
    renderRecent(RECENT_CACHE);
    $('recentHint').textContent=`é¡¯ç¤ºæœ€è¿‘ ${Math.min(data.records.length,limit)} ç­†`; $('recentList').style.display='';
  }catch{ $('recentHint').textContent='æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Endpoint/æ¬Šé™'; }
};

function makeOptions(list, selected, includeEmpty=true, emptyLabel='ï¼ˆä¸æ›´æ”¹ï¼‰'){
  const opts=[]; if(includeEmpty)opts.push(`<option value="">${emptyLabel}</option>`);
  for(const v of list){ opts.push(`<option value="${v}"${v===selected?' selected':''}>${v}</option>`); }
  return opts.join('');
}

function renderRecent(records){
  const listEl=$('recentList');
  listEl.innerHTML=records.map((r)=>{
    const amtRaw=Number(r.amount||0), isOut=(r.direction==='æ”¯å‡º'); const amt=Math.abs(amtRaw);
    const cls=isOut?'neg':'pos'; const meta=`${r.category||''}ãƒ»${r.account||''}ãƒ»${r.owner||''}`;
    const text=`${r.item||''}${r.note?`ï½œ${r.note}`:''}`;
    const rawKey = r.createdAt ? r.createdAt : `${r.date}|${r.amount}|${r.direction}|${r.owner}|${r.item}|${r.account}|${r.category}|${r.note}`;
    const escKey = cssEscape(rawKey);
    const isTransferRow=(r.category==='å¹³è¡¡' && r.item==='å…§æ§äº’è½‰');
    const itemInList=ITEM_OPTIONS.includes(r.item||'');
    const itemSelValue=itemInList?(r.item||''):'å…¶ä»–';
    const itemOtherValue=itemInList?'':(r.item||'');

    return `<div class="list-item" id="row-${escKey}" data-key="${rawKey}">
      <div class="list-head">
        <div id="amtShow-${escKey}" class="list-amt ${cls}">${isOut?'-':''}${amt.toFixed(2)}</div>
        <div class="list-meta"><span>${r.createdAt || r.date || ''}</span></div>
      </div>
      <div class="list-meta"><span>${meta}</span></div>
      <div class="list-body clamp2" id="text-${escKey}">${text}</div>
      <div class="rowbtns" style="margin-top:8px">
        <button class="btn secondary" type="button" onclick="toggleEdit('${rawKey}')">âœï¸ ç·¨è¼¯</button>
        <button class="btn secondary" type="button" onclick="askDelete('${rawKey}')">ğŸ—‘ åˆªé™¤</button>
      </div>
      <form class="editbox" id="edit-${escKey}" style="display:none;margin-top:8px">
        <div class="inline">
          <input name="amount" id="amt-${escKey}" type="number" step="0.01" placeholder="é‡‘é¡ï¼ˆå¿…å¡«ï¼‰" value="${amt||''}">
          <input name="note"   id="note-${escKey}" placeholder="å‚™è¨»" value="${r.note||''}">
        </div>
        <div class="inline" style="margin-top:8px">
          <select name="account" id="acc-${escKey}">${makeOptions(ACCOUNTS, r.account, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}</select>
          <select name="item" id="itemSel-${escKey}" onchange="editItemChanged('${rawKey}')">
            ${makeOptions(ITEM_OPTIONS, itemSelValue, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}
          </select>
        </div>
        <input id="itemOther-${escKey}" placeholder="è¼¸å…¥å…¶ä»–é …ç›®" style="margin-top:8px;${itemSelValue==='å…¶ä»–'?'':'display:none;'}" value="${itemOtherValue}">
        <div class="inline" style="margin-top:8px">
          <select name="category" id="cat-${escKey}">${makeOptions(CATEGORIES, r.category, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}</select>
          <select name="owner" id="owner-${escKey}">${makeOptions(OWNERS, r.owner, true, 'ï¼ˆä¸æ›´æ”¹ï¼‰')}</select>
        </div>
        ${ isTransferRow ? `<select name="accountIn" id="accIn-${escKey}" style="margin-top:8px">${makeOptions(ACCOUNTS,'',true,'ï¼ˆè½‰å…¥å¸³æˆ¶-ä¸æ›´æ”¹ï¼‰')}</select>` : '' }
        <div class="rowbtns" style="margin-top:8px">
          <button class="btn" type="button" onclick="submitEdit('${rawKey}', ${isTransferRow?'true':'false'}, '${isOut?'æ”¯å‡º':'æ”¶å…¥'}')">å„²å­˜</button>
        </div>
      </form>
    </div>`;
  }).join('');
}

function toggleEdit(rawKey){
  const escKey = cssEscape(rawKey);
  const el=$('edit-'+escKey);
  if(el) el.style.display = el.style.display==='none' ? 'block' : 'none';
}

function editItemChanged(rawKey){
  const escKey = cssEscape(rawKey);
  const sel=$('itemSel-'+escKey), other=$('itemOther-'+escKey); if(!sel||!other) return;
  if(sel.value==='å…¶ä»–'){ other.style.display='block'; other.focus(); } else { other.style.display='none'; other.value=''; }
}

async function submitEdit(rawKey, isTransfer, dir){
  const escKey = cssEscape(rawKey);
  const idx = RECENT_INDEX.get(rawKey);
  const snap = (idx!=null)? RECENT_CACHE[idx] : null;

  const amt=Number(($('amt-'+escKey)?.value)||'0'); if(!(amt>0)){ toast('é‡‘é¡å¿…å¡«'); return; }
  const note=$('note-'+escKey)?.value ?? '';
  const account=$('acc-'+escKey)?.value ?? '';
  const category=$('cat-'+escKey)?.value ?? '';
  const owner=$('owner-'+escKey)?.value ?? '';
  const itemSel=$('itemSel-'+escKey)?.value ?? '';
  const itemOther=$('itemOther-'+escKey)?.value?.trim() ?? '';
  const item=(itemSel==='å…¶ä»–')?itemOther:itemSel;

  const apiKey=$('apiKey').value.trim();
  const payload={ action:'update', amount:String(amt), note, account, category, owner, item:item||'', apiKey };
  // åƒ…åœ¨ã€ŒçœŸçš„æœ‰ createdAtã€æ™‚æ‰å‚³ï¼ˆé¿å…æŠŠçµ„åˆéµç•¶ createdAtï¼‰
  if(snap?.createdAt){ payload.createdAt = snap.createdAt; }
  if(isTransfer){ const ain=$('accIn-'+escKey)?.value ?? ''; payload.isTransfer='true'; if(ain) payload.accountIn=ain; }
  else { payload.direction = (snap?.direction) || dir || 'æ”¯å‡º'; }

  // fallbackï¼ˆä¾›å¾Œç«¯å¯¬é¬†æ¯”å°ï¼‰
  if (snap){
    payload['fallback-date']      = snap.date || '';
    payload['fallback-category']  = snap.category || '';
    payload['fallback-account']   = snap.account || '';
    payload['fallback-item']      = snap.item || '';
    payload['fallback-note']      = snap.note ?? '';
    payload['fallback-direction'] = snap.direction || '';
    payload['fallback-owner']     = snap.owner || '';
    payload['fallback-amount']    = String(Number(snap.amount||0));
  }

  try{
    const res=await fetch($('endpoint').value.trim(), {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body:new URLSearchParams(payload).toString()
    });
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'æ›´æ–°å¤±æ•—');

    // å°±åœ°æ›´æ–°
    if(idx!=null){
      const rec = RECENT_CACHE[idx];
      const finalDir = (payload.direction||rec.direction);
      rec.amount = finalDir==='æ”¯å‡º' ? -Math.abs(amt) : Math.abs(amt);
      if(note!=='' && note!=null) rec.note = note;
      if(account) rec.account = account;
      if(category) rec.category = category;
      if(owner) rec.owner = owner;
      if(item) rec.item = item;

      const showAmt = Math.abs(Number(rec.amount||0)).toFixed(2);
      const isOut = finalDir === 'æ”¯å‡º';
      const amtEl = $('amtShow-'+escKey);
      if(amtEl){ amtEl.textContent = (isOut?'-':'') + showAmt; amtEl.className = 'list-amt ' + (isOut?'neg':'pos'); }
      const textEl = $('text-'+escKey);
      if(textEl){ textEl.textContent = `${rec.item||''}${rec.note?`ï½œ${rec.note}`:''}`; }
    }
    toast('å·²æ›´æ–°'); toggleEdit(rawKey);
  }catch(e){ toast('æ›´æ–°å¤±æ•—ï¼š'+e.message); }
}

async function askDelete(rawKey){
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ï¼ˆäº’è½‰æœƒè‡ªå‹•åˆªå…©åˆ—ï¼‰ï¼Ÿ')) return;
  const idx = RECENT_INDEX.get(rawKey);
  const snap = (idx!=null)? RECENT_CACHE[idx] : null;

  const apiKey=$('apiKey').value.trim();
  const payload = { action:'delete', apiKey };
  if(snap?.createdAt){ payload.createdAt = snap.createdAt; }

  if (snap){
    payload['fallback-date']      = snap.date || '';
    payload['fallback-category']  = snap.category || '';
    payload['fallback-account']   = snap.account || '';
    payload['fallback-item']      = snap.item || '';
    payload['fallback-note']      = snap.note ?? '';
    payload['fallback-direction'] = snap.direction || '';
    payload['fallback-owner']     = snap.owner || '';
    payload['fallback-amount']    = String(Number(snap.amount||0));
  }

  try{
    const res=await fetch($('endpoint').value.trim(), {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body:new URLSearchParams(payload).toString()
    });
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'åˆªé™¤å¤±æ•—');

    const card = document.getElementById('row-'+cssEscape(rawKey));
    if(card) card.remove();
    if(idx!=null){ RECENT_CACHE.splice(idx,1); RECENT_INDEX.delete(rawKey); }
    toast('å·²åˆªé™¤');
  }catch(e){ toast('åˆªé™¤å¤±æ•—ï¼š'+e.message); }
}

/* é¤˜é¡ */
$('btnBalance').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆåœ¨ã€Œè¨­å®šã€å¡«å…¥ Endpoint'); return; }
  const params=new URLSearchParams({balance:'1',by:'account'}); const m=$('qMonth').value.trim(), own=$('qOwner').value.trim();
  if(m)params.set('month',m); if(own)params.set('owner',own);
  $('balanceResult').textContent='æŸ¥è©¢ä¸­â€¦'; $('balanceTable').style.display='none';
  try{
    const res=await fetch(`${endpoint}?${params.toString()}`); if(!res.ok) throw 0;
    const data=await res.json(); if(!data.ok||!Array.isArray(data.breakdown)) throw 0;
    const map=new Map(data.breakdown.map(x=>[x.account,Number(x.balance||0)]));
    const rows=ACCOUNTS.map(a=>({account:a,balance:map.has(a)?map.get(a):0}));
    const tbody=document.querySelector('#balanceTable tbody');
    tbody.innerHTML=rows.map(r=>`<tr><td>${r.account}</td><td class="right">${r.balance.toFixed(2)}</td></tr>`).join('');
    const total=rows.reduce((s,r)=>s+r.balance,0);
    $('balanceTotal').textContent=total.toFixed(2);
    $('balanceResult').textContent=`ä¾†æºï¼š${data.source||'detail.byAccount'}${m?`ï½œæœˆä»½ï¼š${m}`:''}${own?`ï½œç™»è¨˜äººï¼š${own}`:''}`;
    $('balanceTable').style.display='';
  }catch{ $('balanceResult').textContent='æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Endpoint/æ¬Šé™'; }
};

/* è¨­å®š */
function loadCfg(){ $('cfgHint').textContent = $('endpoint').value ? 'å·²è¨­å®š Endpoint' : 'å°šæœªè¨­å®š Endpoint'; }
$('btnTest').onclick=async()=>{ try{ const r=await fetch($('endpoint').value.trim()+'?ping=1'); toast(r.ok?'é€£ç·šæ­£å¸¸':'é€£ç·šå¤±æ•—'); }catch{ toast('é€£ç·šå¤±æ•—'); } };
$('btnSaveCfg').onclick=()=>{ loadCfg(); toast('è¨­å®šå·²å„²å­˜'); };

/* æ‰‹å‹•åŒ¯å…¥ Gmail å¤–é€å¸³å–® */
$('btnImport').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆåœ¨ã€Œè¨­å®šã€å¡«å…¥ Endpoint'); return; }
  const days=Math.max(1,Math.min(90,Number($('importDays').value)||10));
  const reset=$('resetWindow').checked ? 'true' : 'false';
  $('importHint').textContent='è™•ç†ä¸­â€¦';
  try{
    const res=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body:new URLSearchParams({action:'ingest_gmail',days:String(days),resetWindow:reset,apiKey:$('apiKey').value.trim()}).toString()});
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'åŒ¯å…¥å¤±æ•—');
    toast(`å®Œæˆï¼šæ–°å¢ ${data.added||0} ç­†`); $('importHint').textContent=`å®Œæˆï¼šæ–°å¢ ${data.added||0} ç­†ï¼ˆè€—æ™‚ ${data.elapsedMs||0} msï¼‰`;
    if(location.hash==='#recent'){ $('btnRecent').click(); }
  }catch(e){ $('importHint').textContent='å¤±æ•—ï¼š' + e.message; toast('åŒ¯å…¥å¤±æ•—ï¼š' + e.message); }
};
</script>
</body>
</html>
