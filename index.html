<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#F5F7F9">
  <title>æ”¶æ”¯å¿«è¨˜</title>
  <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=Ledger&background=5D7B9D&color=fff&size=192&font-size=0.3&rounded=true">
  <style>
    :root { --bg:#F5F7F9; --card:#FFFFFF; --text:#334155; --text-light:#94A3B8; --primary:#5D7B9D; --danger:#EF4444; --success:#059669; --radius:12px; --border:#E2E8F0; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { margin:0; background:var(--bg); color:var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height:100vh; display:flex; flex-direction:column; padding-top:env(safe-area-inset-top); padding-bottom:calc(100px + env(safe-area-inset-bottom)); }
    .nav { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.98); border:1px solid var(--border); box-shadow:0 10px 25px rgba(0,0,0,0.05); border-radius:32px; padding:6px 12px; display:flex; gap:8px; z-index:100; width:90%; max-width:360px; justify-content:space-between; }
    .nav-item { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px 0; color:var(--text-light); text-decoration:none; font-size:10px; font-weight:600; border-radius:20px; transition:0.2s; }
    .nav-item.active { color:var(--primary); background:#F1F5F9; }
    .icon { width:20px; height:20px; fill:currentColor; }
    .container { max-width:600px; margin:0 auto; padding:20px 16px; width:100%; flex:1; overflow-y:auto; }
    section[hidden] { display:none; }
    .card { background:var(--card); border-radius:var(--radius); overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.02); margin-bottom:16px; border:1px solid var(--border); }
    .big-input-wrapper { display:flex; justify-content:center; align-items:center; padding:0 0 24px; position:relative; }
    .currency-symbol { font-size:20px; font-weight:500; color:var(--text-light); margin-right:4px; }
    .big-input { border:none; background:transparent; text-align:center; font-size:48px; font-weight:600; color:var(--text); width:180px; padding:0; margin:0; font-family:monospace; }
    .input-row { display:flex; align-items:center; padding:14px 20px; border-bottom:1px solid var(--border); min-height:52px; }
    .row-label { width:70px; font-size:14px; color:var(--text-light); font-weight:500; flex-shrink:0; }
    .row-input { flex:1; border:none; background:transparent; font-size:15px; color:var(--text); text-align:right; width:100%; }
    select.row-input { direction:rtl; appearance:none; background:url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23334155%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E") no-repeat right center; background-size:10px; padding-right:15px; }
    .btn-main { background:var(--primary); color:#fff; width:100%; padding:14px; border:none; border-radius:var(--radius); font-size:15px; font-weight:600; margin-top:20px; cursor:pointer; box-shadow:0 4px 12px rgba(93,123,157,0.2); display:flex; align-items:center; justify-content:center; gap:8px; }
    .btn-ghost { background:transparent; color:var(--text-light); border:1px solid var(--border); }
    .seg-control { display:flex; background:var(--bg); border-radius:12px; padding:4px; margin:0 16px 20px; }
    .seg-item { flex:1; text-align:center; padding:10px; font-size:14px; font-weight:600; border-radius:8px; color:var(--text-light); cursor:pointer; transition:0.2s; }
    .seg-item.active { background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.05); color:var(--text); }
    .seg-item[data-val="æ”¯å‡º"].active { color:var(--danger); }
    .seg-item[data-val="æ”¶å…¥"].active { color:var(--success); }
    .switch { position:relative; display:inline-block; width:44px; height:26px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#CBD5E1; transition:.3s; border-radius:34px; }
    .slider:before { position:absolute; content:""; height:20px; width:20px; left:3px; bottom:3px; background-color:white; transition:.3s; border-radius:50%; }
    input:checked + .slider { background-color:var(--primary); }
    input:checked + .slider:before { transform:translateX(18px); }
    .record-item { padding:14px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .rec-amt { font-size:16px; font-weight:600; font-family:monospace; }
    .rec-amt.neg { color:var(--text); } .rec-amt.pos { color:var(--success); }
    .toast { position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-50px); background:#334155; color:white; padding:10px 20px; border-radius:20px; font-size:13px; opacity:0; transition:0.4s; pointer-events:none; z-index:2000; }
    .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); backdrop-filter:blur(2px); z-index:999; display:none; justify-content:center; align-items:flex-end; }
    .modal-overlay.open { display:flex; }
    .modal-card { background:#fff; width:100%; max-width:600px; border-radius:20px 20px 0 0; padding:24px; animation:slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    #verLog { font-size:12px; background:#f1f5f9; padding:16px; border-radius:12px; line-height:1.6; max-height:200px; overflow-y:auto; margin-top:12px; display:none; text-align:left; border:1px solid var(--border); }
    #verLog ul { padding-left:16px; margin:0; }
    #verLog li { margin-bottom:6px; color:var(--text); }
    .ver-date { font-size:10px; color:var(--text-light); margin-right:6px; background:#e2e8f0; padding:2px 4px; border-radius:4px; font-family:monospace; }
    .footer { text-align:center; margin-top:40px; padding-bottom:20px; color:var(--text-light); font-size:11px; }
    .ver-badge { background:#E2E8F0; padding:2px 6px; border-radius:4px; }
    .cam-btn { display:flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:50%; background:#F1F5F9; color:var(--primary); cursor:pointer; margin-left:8px; border:1px solid var(--border); }
    .img-preview-area { display:flex; gap:8px; overflow-x:auto; padding:8px 16px; background:#fff; border-bottom:1px solid var(--border); }
    .img-thumb { width:50px; height:50px; border-radius:8px; object-fit:cover; border:1px solid #eee; flex-shrink:0; }
    .img-del { position:absolute; top:-5px; right:-5px; background:red; color:white; width:16px; height:16px; border-radius:50%; font-size:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .img-thumb-wrap { position:relative; }
    .split-cam { font-size:16px; color:#94A3B8; cursor:pointer; margin-left:10px; padding:4px; }
    .split-cam.has-img { color:var(--primary); }
  </style>
</head>
<body>

  <nav class="nav">
    <a href="#home" class="nav-item active" onclick="routeClick('home')"><svg class="icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>è¨˜å¸³</a>
    <a href="#recent" class="nav-item" onclick="routeClick('recent')"><svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>æ˜ç´°</a>
    <a href="#balance" class="nav-item" onclick="routeClick('balance')"><svg class="icon" viewBox="0 0 24 24"><path d="M4 10h12v2H4zm0-4h12v2H4zm0 8h8v2H4zm10 0v6l5.5-3-5.5-3z"/></svg>è³‡ç”¢</a>
    <a href="#settings" class="nav-item" onclick="routeClick('settings')"><svg class="icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>è¨­å®š</a>
  </nav>

  <section data-view="home" class="container">
    <form id="form" autocomplete="off">
      <select id="direction" style="display:none"><option>æ”¯å‡º</option><option>æ”¶å…¥</option></select>
      <div class="card" style="padding-top: 24px;">
        <div class="seg-control">
          <div class="seg-item active" data-val="æ”¯å‡º" onclick="setDirection('æ”¯å‡º')">æ”¯å‡º</div>
          <div class="seg-item" data-val="æ”¶å…¥" onclick="setDirection('æ”¶å…¥')">æ”¶å…¥</div>
        </div>
        <div class="big-input-wrapper">
          <span class="currency-symbol">$</span>
          <input type="number" id="amount" class="big-input" placeholder="0" step="0.01" inputmode="decimal" oninput="saveDraft()">
          <label class="cam-btn">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zM20 5h-3.17L15 3H9L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-8 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
            <input type="file" id="imgInput" accept="image/*" multiple style="display:none">
          </label>
        </div>
        <div class="input-row"><span class="row-label">æ—¥æœŸ</span><input type="date" id="date" class="row-input" required onchange="saveDraft()"></div>
        <div class="input-row"><span class="row-label">åˆ†é¡</span><select id="category" class="row-input" onchange="renderItems()"><option value="">é¸æ“‡åˆ†é¡</option></select></div>
        
        <div class="input-row"><span class="row-label">é …ç›®</span>
          <div style="flex:1; display:flex; flex-direction:column; align-items:flex-end;">
            <select id="itemSelect" class="row-input" onchange="renderSubItems()"><option value="">é¸æ“‡é …ç›®</option></select>
            <input id="itemInput" class="row-input" placeholder="è¼¸å…¥é …ç›®" style="display:none; border-bottom:1px dashed #ccc; margin-top:4px;" oninput="saveDraft()">
          </div>
        </div>
        
        <div class="input-row"><span class="row-label">æ¬¡é …ç›®</span>
          <div style="flex:1; display:flex; flex-direction:column; align-items:flex-end;">
            <select id="subSelect" class="row-input" onchange="checkCustomInput('sub')"><option value="">é¸æ“‡æ¬¡é …ç›®</option></select>
            <input id="subInput" class="row-input" placeholder="è¼¸å…¥æ¬¡é …ç›®" style="display:none; border-bottom:1px dashed #ccc; margin-top:4px;" oninput="saveDraft()">
          </div>
        </div>

        <div class="input-row"><span class="row-label">å¸³æˆ¶</span>
          <select id="account" class="row-input" onchange="saveDraft()">
            <option value="">é¸æ“‡å¸³æˆ¶</option>
            <option>é»ƒç¾é‡‘</option><option>è•­ç¾é‡‘</option>
            <option>åˆä½œé‡‘åº«</option><option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option>
            <option>é»ƒéƒµå±€</option><option>è•­LINE</option><option>å½°åŒ–éŠ€è¡Œ</option>
            <option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
            <option>è¯å—å¡</option><option>åœ‹æ³°å¡</option><option>è¯é‚¦å¡</option>
          </select>
        </div>
        
        <div class="input-row"><span class="row-label">å‚™è¨»</span><input id="note" class="row-input" placeholder="é¸å¡«" oninput="saveDraft()"></div>
        
        <div class="input-row" style="justify-content:space-between;"><span class="row-label">å¸³æˆ¶äº’è½‰</span><label class="switch"><input type="checkbox" id="isTransfer" onchange="saveDraft()"><span class="slider"></span></label></div>
        <div id="transferFields" class="input-row" style="display:none;background:#F1F5F9;"><span class="row-label" style="color:var(--primary)">è½‰å…¥è‡³</span><select id="accountIn" class="row-input" onchange="saveDraft()"><option value="">é¸æ“‡è½‰å…¥å¸³æˆ¶</option><option>é»ƒç¾é‡‘</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option><option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option><option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option><option>è¯å—å¡</option><option>åœ‹æ³°å¡</option><option>è¯é‚¦å¡</option></select></div>
        
        <div id="imgPreview" class="img-preview-area" style="display:none"></div>
      </div>

      <div id="splitSection" style="display:none"><div class="group-title">åˆ†å¸³é è¦½</div><div class="card"><div id="splitList"></div></div></div>
      <div style="display:flex;gap:12px;">
        <button class="btn-main btn-ghost" type="button" id="btnAddSplit"><svg class="icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>åˆ†å¸³</button>
        <button class="btn-main" type="submit" id="btnSubmit"><svg class="icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>ç¢ºèª</button>
      </div>
      <div class="group-title">æœ€è¿‘æœ¬æ©Ÿç´€éŒ„</div>
      <div class="card">
        <div class="log" id="log" style="max-height:200px;overflow:auto;"></div>
        <div style="padding:12px;text-align:center;border-top:1px solid var(--border);"><span id="btnClear" style="color:var(--danger);font-size:12px;cursor:pointer">æ¸…é™¤ç´€éŒ„</span></div>
      </div>
      <div class="footer"><span class="ver-badge">v6.1</span><div class="ver-desc">é¸å–®æ›´æ–°ãƒ»å®Œæ•´åŠŸèƒ½ä¿®å¾©</div></div>
    </form>
  </section>

  <input type="file" id="splitImgInput" accept="image/*" multiple style="display:none">

  <section data-view="recent" class="container" hidden>
    <div class="card" style="padding:16px;">
      <div style="display:flex;gap:8px;margin-bottom:12px;"><input type="number" id="rLimit" value="10" class="row-input" style="background:var(--bg);border-radius:8px;padding:8px;text-align:center;" placeholder="ç­†æ•¸"><select id="rCategory" class="row-input" style="background:var(--bg);border-radius:8px;padding:8px;"><option value="">å…¨éƒ¨åˆ†é¡</option></select></div>
      <button class="btn-main" id="btnRecent" type="button" style="margin:0;padding:12px;">âŸ³ åˆ·æ–°åˆ—è¡¨</button>
    </div>
    <div id="recentList" style="padding-bottom:20px;"></div>
  </section>

  <section data-view="balance" class="container" hidden>
    <div class="card" style="padding:16px;">
       <h2 style="margin:0 0 16px;font-size:16px;color:var(--text);">ç•¶ä¸‹è³‡ç”¢ç¸½è¦½</h2>
       <button class="btn-main" id="btnBalance" type="button" style="margin-top:0;padding:12px;">æŸ¥è©¢æ‰€æœ‰é¤˜é¡</button>
    </div>
    <div class="card" id="balanceArea" style="display:none;padding:20px;">
       <div style="text-align:center;margin-bottom:24px;"><div style="font-size:12px;color:var(--text-light);margin-bottom:4px;">ç¸½è³‡ç”¢</div><div id="balanceTotal" style="font-size:36px;font-weight:700;color:var(--primary);">0.00</div></div>
       <div id="balanceListContainer"></div>
    </div>
  </section>

  <section data-view="settings" class="container" hidden>
    <div style="text-align:center; margin-top:30px;">
      <button onclick="toggleLog()" style="background:none; border:none; color:var(--primary); font-size:12px; cursor:pointer; padding:10px;">ğŸ•’ æŸ¥çœ‹ç‰ˆæœ¬ç´€éŒ„</button>
      <div id="verLog">
        <ul>
          <li><span class="ver-date">2026-02-03</span><strong>v6.1:</strong> æ›´æ–°åˆ†é¡èˆ‡é …ç›®é¸å–®ï¼Œç¬¦åˆæœ€æ–°éœ€æ±‚ã€‚</li>
          <li><span class="ver-date">2026-01-26</span><strong>v6.0:</strong> å…¨é¢ä¿®å¾©æ¬„ä½éŒ¯ä½å°è‡´çš„æŸ¥è©¢å¤±æ•ˆã€‚</li>
          <li><span class="ver-date">2026-01-26</span><strong>v5.8:</strong> é€²å…¥ç¶²é æ™‚å¼·åˆ¶æ¸…ç©ºæ‰€æœ‰æ¬„ä½ã€‚</li>
        </ul>
      </div>
    </div>
    <div class="group-title">é€£ç·šè¨­å®š</div>
    <div class="card">
      <div class="input-row"><span class="row-label">API URL</span><input id="endpoint" class="row-input" value="https://script.google.com/macros/s/AKfycbzjpwoEGtRpX9FnQ0i-rSjvgaUB40gG44tBAcd_tI30R1X9HydICtdlSiooJXViatJZ/exec"></div>
      <div class="input-row"><span class="row-label">API Key</span><input id="apiKey" class="row-input" placeholder="é¸å¡«"></div>
      <div style="display:flex;padding:16px;gap:12px;"><button id="btnTest" style="flex:1;padding:12px;background:var(--bg);border:none;border-radius:10px;color:var(--text);">æ¸¬è©¦</button><button id="btnSaveCfg" style="flex:1;padding:12px;background:var(--text);color:#fff;border:none;border-radius:10px;">å„²å­˜</button></div>
    </div>
    <div class="group-title">Gmail åŒ¯å…¥</div>
    <div class="card" style="padding:16px;">
      <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center;"><input id="importDays" type="number" value="10" class="row-input" style="background:var(--bg);border-radius:8px;padding:8px;text-align:center;width:80px;" placeholder="å¤©æ•¸"><div style="flex:1;display:flex;align-items:center;justify-content:flex-end;gap:8px;"><span style="font-size:13px;color:var(--text);">å¼·åˆ¶é‡æŠ“</span><label class="switch" style="transform:scale(0.8);"><input type="checkbox" id="importForce"><span class="slider"></span></label></div></div>
      <button class="btn-main" id="btnImport" type="button" style="margin:0;">é–‹å§‹æŠ“å–å¸³å–®</button>
      <div id="importHint" style="text-align:center;font-size:12px;color:var(--text-light);margin-top:12px;">â€”</div>
    </div>
  </section>

  <div id="editModal" class="modal-overlay"><div class="modal-card"><div style="display:flex;justify-content:space-between;margin-bottom:20px;"><h3 style="margin:0;">ç·¨è¼¯ç´€éŒ„</h3><span onclick="closeEditModal()" style="font-size:24px;cursor:pointer;">&times;</span></div><div id="modalContent"></div></div></div>
  <div id="toast" class="toast">è¨Šæ¯</div>

<script>
// âœ… 2026-02-03 æœ€æ–°é¸å–®è³‡æ–™ v6.1
const MENU_DATA = {
  "å…±ç”¨": {
    "æ°´é›»è²»": ["é›»è²»", "æ°´è²»", "ç“¦æ–¯è²»"],
    "äº¤é€š": ["æ±½è»Šæ²¹è³‡", "æ±½è»Šä¿é¤Š", "ä¿éšª", "æ´—è»Š", "åœè»Šè²»", "ç½°å–®", "æ©Ÿè»Šæ²¹è³‡", "æ©Ÿè»Šä¿é¤Š"],
    "æˆ¿ç§Ÿ": ["æˆ¿ç§Ÿ"],
    "ç©æ¨‚": ["è¡Œç¨‹", "ä½å®¿"],
    "é£Ÿç‰©": ["å‡æ—¥æ—©é¤", "å‡æ—¥åˆé¤", "å‡æ—¥æ™šé¤", "å¹³æ—¥æ—©é¤", "å¹³æ—¥åˆé¤", "å¹³æ—¥æ™šé¤", "æ°´æœ", "é£²æ–™", "é»å¿ƒ"],
    "å®¶ç”¨å“": ["æ¶ˆè€—å“", "éæ¶ˆè€—å“"],
    "é›»è©±è²»": ["å°é¡æ”¯ä»˜", "æœƒå“¡è²»", "é›»è©±è²»"]
  },
  "é»ƒæ”¯å‡º": {
    "ç©æ¨‚": ["ç”¨å“", "æœé£¾", "ç©å…·", "å­¸è²»"],
    "é£Ÿç‰©": ["äººæƒ…å¾€ä¾†", "å€‹äººåˆé¤", "å€‹äººæ™šé¤", "é£²æ–™", "é»å¿ƒ"],
    "å¥åº·": ["ä¿å¥å“", "çœ‹è¨º", "è—¥è²»"]
  },
  "è•­æ”¯å‡º": {
    "ç©æ¨‚": ["äººæƒ…å¾€ä¾†", "ç”¨å“", "æœé£¾", "ç©å…·", "ä¿é¤Šå“", "æ›¸ç±"],
    "é£Ÿç‰©": ["äººæƒ…å¾€ä¾†", "å€‹äººæ™šé¤", "å€‹äººåˆé¤", "å€‹äººæ—©é¤", "é£²æ–™"],
    "å¥åº·": ["ä¿å¥å“", "æ¸›é‡è—¥å“", "çœ‹è¨º", "è—¥è²»"]
  },
  "æ´‹æ”¯å‡º": {
    "é£Ÿç‰©": ["é›¶é£Ÿ", "é£¼æ–™"],
    "ç©æ¨‚": ["ç©å…·", "è¡£æœ", "æ´—æ¾¡"]
  },
  "å…¬å¸ä»£å¢Š": {
    "å…¬å¸ä»£å¢Š": ["å…¬å¸ä»£å¢Š"],
    "é£Ÿç‰©": ["å…¬å¸åˆé¤"]
  },
  "ä¿¡ç”¨å¡": {
    "åœ‹æ³°ä¸–è¯": ["åœ‹æ³°ä¸–è¯"],
    "è¯å—éŠ€è¡Œ": ["è¯å—éŠ€è¡Œ"],
    "è¯é‚¦éŠ€è¡Œ": ["è¯é‚¦éŠ€è¡Œ"]
  },
  "è² å‚µ": {
    "ä¸­åœ‹ä¿¡è¨—": ["ä¸­åœ‹ä¿¡è¨—"],
    "åœ‹æ³°ä¸–è¯": ["åœ‹æ³°ä¸–è¯"],
    "åŒ¯è±": ["åŒ¯è±"],
    "è£•è": ["è£•è"]
  },
  "æ”¶å…¥": {
    "æ¬£å®œçé‡‘": ["æ¬£å®œçé‡‘"],
    "æ¬£å®œè–ªè³‡": ["æ¬£å®œè–ªè³‡"],
    "ç§Ÿé‡‘è£œè²¼": ["ç§Ÿé‡‘è£œè²¼"],
    "å–¬çŒ·è–ªè³‡": ["å–¬çŒ·è–ªè³‡"]
  },
  "å¹³è¡¡": {
    "å…§æ§äº’è½‰": ["å…§æ§äº’è½‰"]
  },
  "å…¶ä»–": {
    "åœ‹æ³°è­‰åˆ¸": ["åœ‹æ³°è­‰åˆ¸"]
  }
};

let isSubmitting=false; let currentSplits=[]; let selectedImages=[]; let activeSplitIdx = -1;
const DRAFT_KEY='spend.draft.v6.1'; const SENT_KEY='spend.sent.v19'; 

window.addEventListener('DOMContentLoaded', () => {
  $('date').value=new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
  loadCfg(); renderCategories(); resetForm(); renderLog(); route();
  populateModalSelects();
  
  localStorage.removeItem(DRAFT_KEY);
});

const $ = id => document.getElementById(id);
const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };
function getDeviceType() {
  let id = localStorage.getItem('spend.deviceId');
  if(!id) { id = Math.random().toString(36).substring(2,6).toUpperCase(); localStorage.setItem('spend.deviceId', id); }
  const ua = navigator.userAgent; let os='Web'; if(/iPhone|iPad/.test(ua)) os='iOS'; else if(/Android/.test(ua)) os='Android';
  return `${os} #${id}`;
}
function routeClick(name) { location.hash = '#' + name; }
function showView(name){ document.querySelectorAll('section[data-view]').forEach(sec=>sec.hidden = sec.dataset.view !== name); document.querySelectorAll('.nav-item').forEach(a => a.classList.toggle('active', a.getAttribute('href') === '#' + name)); }
function route(){ const name=(location.hash||'#home').slice(1); showView(['home','recent','balance','settings'].includes(name)?name:'home'); }
window.addEventListener('hashchange', route);
function toggleLog(){ const l=$('verLog'); l.style.display = l.style.display==='block'?'none':'block'; }

/* ğŸ§  Cascade Logic */
function renderCategories() {
  const catSel = $('category'); const rCat = $('rCategory');
  const cats = Object.keys(MENU_DATA);
  const opts = `<option value="">é¸æ“‡åˆ†é¡</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  catSel.innerHTML = opts; rCat.innerHTML = `<option value="">å…¨éƒ¨åˆ†é¡</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
}
function renderItems() {
  const cat = $('category').value;
  const itemSel = $('itemSelect');
  itemSel.innerHTML = `<option value="">é¸æ“‡é …ç›®</option>`;
  $('itemInput').style.display = 'none'; $('subSelect').innerHTML = `<option value="">é¸æ“‡æ¬¡é …ç›®</option>`; $('subInput').style.display = 'none';
  if (cat && MENU_DATA[cat]) {
    const items = Object.keys(MENU_DATA[cat]);
    itemSel.innerHTML += items.map(i=>`<option value="${i}">${i}</option>`).join('') + `<option value="å…¶ä»–">å…¶ä»–...</option>`;
  }
}
function renderSubItems() {
  const cat = $('category').value; const item = $('itemSelect').value; const subSel = $('subSelect');
  subSel.innerHTML = `<option value="">é¸æ“‡æ¬¡é …ç›®</option>`; $('subInput').style.display = 'none';
  if (item === 'å…¶ä»–') {
    $('itemInput').style.display = 'block';
    subSel.innerHTML += `<option value="å…¶ä»–">å…¶ä»–...</option>`;
  } else {
    $('itemInput').style.display = 'none';
    if (cat && MENU_DATA[cat] && MENU_DATA[cat][item]) {
      const subs = MENU_DATA[cat][item];
      subSel.innerHTML += subs.map(s=>`<option value="${s}">${s}</option>`).join('') + `<option value="å…¶ä»–">å…¶ä»–...</option>`;
    }
  }
}
function checkCustomInput(type) {
  const sel = $(type + 'Select'); const inp = $(type + 'Input');
  inp.style.display = sel.value === 'å…¶ä»–' ? 'block' : 'none';
}
function getFinalValues() {
  const cat = $('category').value;
  const itemSel = $('itemSelect').value; const item = itemSel === 'å…¶ä»–' ? $('itemInput').value : itemSel;
  const subSel = $('subSelect').value; const sub = subSel === 'å…¶ä»–' ? $('subInput').value : subSel;
  return { cat, item, sub };
}

/* Image */
$('imgInput').onchange = async function(e) {
  const files = e.target.files; if (!files || files.length===0) return;
  for (let i=0; i<files.length; i++) selectedImages.push(await compressImage(files[i]));
  renderImgPreview(); this.value='';
};
function renderImgPreview() {
  const div=$('imgPreview'); div.style.display = selectedImages.length?'flex':'none';
  div.innerHTML = selectedImages.map((s,i)=>`<div class="img-thumb-wrap"><img src="${s}" class="img-thumb"><div class="img-del" onclick="removeImg(${i})">Ã—</div></div>`).join('');
}
window.removeImg=(i)=>{selectedImages.splice(i,1);renderImgPreview();};
window.attachSplitImg = (idx) => { activeSplitIdx = idx; $('splitImgInput').click(); };
$('splitImgInput').onchange = async function(e) {
  if (activeSplitIdx<0 || !currentSplits[activeSplitIdx]) return;
  const files=e.target.files; if(!files.length) return;
  if(!currentSplits[activeSplitIdx].images) currentSplits[activeSplitIdx].images=[];
  for(let i=0; i<files.length; i++) currentSplits[activeSplitIdx].images.push(await compressImage(files[i]));
  renderSplits(); this.value=''; activeSplitIdx=-1;
};
function compressImage(file){
  return new Promise((r)=>{ const reader=new FileReader(); reader.readAsDataURL(file); reader.onload=(e)=>{ const img=new Image(); img.src=e.target.result; img.onload=()=>{ const cvs=document.createElement('canvas'); const scale=800/img.width; cvs.width=800; cvs.height=img.height*scale; cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height); r(cvs.toDataURL('image/jpeg',0.6)); } } });
}

/* Core - No Draft Saving on Input */
function resetForm() {
  localStorage.removeItem(DRAFT_KEY); 
  currentSplits = []; selectedImages = []; renderImgPreview();
  $('splitList').innerHTML = ''; $('splitSection').style.display = 'none'; $('btnSubmit').textContent = 'ç¢ºèªé€å‡º';
  
  $('date').disabled = false; $('account').disabled = false;
  $('amount').value = ''; 
  $('category').value = ''; renderItems(); // Reset cascading
  $('account').value = ''; 
  $('note').value = ''; 
  $('subSelect').value = '';
  $('subInput').value = '';
  
  if($('isTransfer').checked) { $('isTransfer').checked = false; $('transferFields').style.display='none'; $('category').disabled = false; }
}

function setDirection(val) { $('direction').value = val; document.querySelectorAll('.seg-item').forEach(el => el.classList.toggle('active', el.dataset.val === val)); }
$('isTransfer').onchange = ()=>{
  const on = $('isTransfer').checked; $('transferFields').style.display = on ? 'flex' : 'none';
  if (on){ $('category').value='å¹³è¡¡'; $('category').disabled=true; renderItems(); $('itemSelect').value='å…§æ§äº’è½‰'; renderSubItems(); $('subSelect').value='å…§æ§äº’è½‰'; $('direction').value='æ”¯å‡º'; if(currentSplits.length>0){toast('äº’è½‰å·²æ¸…é™¤');currentSplits=[];renderSplits();} } 
  else { $('category').disabled=false; }
};
function renderSplits() {
  const btnSubmit = $('btnSubmit'); const listDiv = $('splitList'); const section = $('splitSection');
  if (currentSplits.length === 0) { section.style.display = 'none'; listDiv.innerHTML = ''; btnSubmit.textContent = 'ç¢ºèªé€å‡º'; $('date').disabled = false; $('account').disabled = false; return; }
  section.style.display = 'block'; let html = ''; let total = 0;
  currentSplits.forEach((s, i) => { 
    const isOut = s.direction === 'æ”¯å‡º'; total += (isOut?1:-1)*s.amount; 
    const hasImg = s.images && s.images.length > 0;
    html += `<div class="record-item"><div class="rec-left"><div class="rec-title">${s.category} - ${s.item}</div><div class="rec-meta">${s.subItem||''}</div></div><div class="rec-right"><span class="rec-amt ${isOut?'neg':'pos'}">${s.amount}</span><span class="split-cam ${hasImg?'has-img':''}" onclick="attachSplitImg(${i})">${hasImg?'ğŸ–¼ï¸':'ğŸ“·'}</span><span style="color:var(--danger);font-size:18px;margin-left:10px;cursor:pointer" onclick="delSplit(${i})">âœ•</span></div></div>`; 
  });
  listDiv.innerHTML = html; btnSubmit.textContent = `é€å‡º ${currentSplits.length} ç­†åˆ†å¸³`; $('date').disabled = true; $('account').disabled = true;
}
window.delSplit = (i) => { currentSplits.splice(i, 1); renderSplits(); };
$('btnAddSplit').onclick = () => {
  const { cat, item, sub } = getFinalValues();
  const amt = Number($('amount').value || 0); 
  if (!cat || !item) return toast('è«‹å¡«å¯«åˆ†é¡èˆ‡é …ç›®');
  if (!amt) return toast('è«‹è¼¸é‡‘é¡');
  currentSplits.push({ amount: amt, category: cat, item: item, subItem: sub, note: $('note').value.trim(), direction: $('direction').value, images: [] });
  renderSplits(); $('amount').value = ''; $('note').value = ''; $('subItem').value = ''; $('amount').focus();
};

$('form').onsubmit = (e) => {
  e.preventDefault(); if (isSubmitting) return;
  const { cat, item, sub } = getFinalValues();
  const amt = Number($('amount').value); const isXfer = $('isTransfer').checked;
  if (!$('account').value) return toast('è«‹é¸æ“‡å¸³æˆ¶');
  if (isXfer && !$('accountIn').value) return toast('è«‹é¸æ“‡è½‰å…¥å¸³æˆ¶');
  if (currentSplits.length === 0) {
    if (!amt) return toast('è«‹è¼¸å…¥é‡‘é¡');
    if (!isXfer && (!cat || !item)) return toast('è«‹å®Œæ•´å¡«å¯«åˆ†é¡/é …ç›®');
  }
  
  isSubmitting = true; const btn = $('btnSubmit'); const ot = btn.textContent; btn.textContent = 'è™•ç†ä¸­...'; btn.disabled = true;
  const norm = s => s.replace(/^åˆä½œ$/,'åˆä½œé‡‘åº«').replace(/^è•­è³´$/,'è•­LINE');
  
  const payload = { 
    date: $('date').value, account: norm($('account').value), apiKey: $('apiKey').value.trim(), device: getDeviceType(), images: selectedImages,
    category: cat, item: item, subItem: sub, amount: amt, note: $('note').value, direction: $('direction').value
  };
  if(isXfer) { payload.isTransfer = 'true'; payload.accountIn = norm($('accountIn').value); }
  if(currentSplits.length > 0) { payload.action = 'split_add'; payload.splits_json = JSON.stringify(currentSplits); }
  
  const ts = new Date().toLocaleString('sv').replace(' ','T');
  if(currentSplits.length) currentSplits.forEach(s=>addSent({ts, ...s, account:payload.account}));
  else addSent({ts, ...payload});

  fetch($('endpoint').value, { method: 'POST', body: JSON.stringify(payload) })
  .then(r=>r.json()).then(d=>{
    if(d.ok) { toast('âœ… å®Œæˆ'); renderLog(); setTimeout(resetForm, 300); }
    else toast('å¤±æ•—:'+d.error);
  }).finally(()=>{ isSubmitting=false; btn.disabled=false; btn.textContent=ot; });
};

function addSent(rec){ const l=JSON.parse(localStorage.getItem(SENT_KEY)||'[]'); l.push(rec); localStorage.setItem(SENT_KEY, JSON.stringify(l.slice(-50))); }
function renderLog(){ const l=JSON.parse(localStorage.getItem(SENT_KEY)||'[]').reverse(); $('log').innerHTML = l.length ? l.map(r=>`<div class="record-item"><div class="rec-left"><div class="rec-title">${r.item} <small>${r.subItem||''}</small></div></div><div class="rec-right">${r.amount}</div></div>`).join('') : '<div style="text-align:center;padding:10px;color:#ccc">ç„¡è³‡æ–™</div>'; }
$('btnClear').onclick=()=>{ localStorage.removeItem(SENT_KEY); renderLog(); };
function loadCfg(){ if(localStorage.getItem('spend.endpoint')) $('endpoint').value=localStorage.getItem('spend.endpoint'); if(localStorage.getItem('spend.apiKey')) $('apiKey').value=localStorage.getItem('spend.apiKey'); }
$('btnSaveCfg').onclick=()=>{ localStorage.setItem('spend.endpoint',$('endpoint').value); localStorage.setItem('spend.apiKey',$('apiKey').value); toast('å„²å­˜'); };
$('btnTest').onclick=()=>{ fetch($('endpoint').value+'?ping=1').then(r=>toast(r.ok?'âœ… é€šè¡Œ':'âŒ å¤±æ•—')).catch(()=>toast('âŒ å¤±æ•—')); };
$('btnImport').onclick=async()=>{
  const ep=$('endpoint').value.trim();
  $('importHint').textContent='ç³»çµ±è™•ç†ä¸­...';
  try {
    const res = await fetch(ep, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:`action=ingest_gmail&days=${$('importDays').value}&force=${$('importForce').checked}&apiKey=${$('apiKey').value}`});
    const d = await res.json();
    if(d.ok) { toast(`æ–°å¢ ${d.added} ç­†`); $('importHint').textContent=`âœ… æˆåŠŸæ–°å¢ ${d.added} ç­†`; } else throw d;
  } catch(e) { $('importHint').textContent='âŒ å¤±æ•—'; }
};

/* Populate */
const ACCOUNTS=['é»ƒç¾é‡‘','è•­ç¾é‡‘','åˆä½œé‡‘åº«','è•­éƒµå±€','è¯å—éŠ€è¡Œ','é»ƒéƒµå±€','è•­LINE','å½°åŒ–éŠ€è¡Œ','é»ƒä¸­ä¿¡','é»ƒLINE','åœ‹æ³°ä¸–è¯','è¯å—å¡','åœ‹æ³°å¡','è¯é‚¦å¡'];
const CATEGORIES=Object.keys(MENU_DATA);
function populateModalSelects() {
  const fill = (id, list) => { const el=$(id); if(!el)return; el.innerHTML=''; list.forEach(v=>{const op=document.createElement('option');op.value=v;op.textContent=v;el.appendChild(op)}); };
  fill('modal-cat', CATEGORIES); fill('modal-acc', ACCOUNTS); 
}
</script>
</body>
</html>
