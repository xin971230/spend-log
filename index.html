<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#F5F7F9">
  <title>æ”¶æ”¯å¿«è¨˜</title>
  
  <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=ğŸ’°&background=5D7B9D&color=fff&size=192&font-size=0.5&rounded=true">

  <style>
    /* --- 1. è­·çœ¼é…è‰² (Eye Comfort Palette) --- */
    :root {
      --bg: #F5F7F9; 
      --card: #FFFFFF;
      --text: #334155; 
      --text-light: #64748B;
      --primary: #5D7B9D; 
      --primary-light: #E2E8F0;
      --danger: #EF4444; 
      --success: #059669;
      --radius: 16px;
      --border: #E2E8F0;
      --shadow: 0 2px 12px rgba(0,0,0,0.03);
    }

    /* --- 2. åŸºç¤é‡ç½® --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: "PingFang TC", "Noto Sans TC", -apple-system, BlinkMacSystemFont, sans-serif;
      height: 100vh; display: flex; flex-direction: column;
      padding-bottom: 90px; /* åº•éƒ¨å°èˆªç•™ç™½ */
      /* ç€æµ·å±é©é… */
      padding-top: env(safe-area-inset-top);
      padding-bottom: calc(90px + env(safe-area-inset-bottom));
    }

    /* --- 3. æ‡¸æµ®å°èˆª --- */
    .nav {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.95); backdrop-filter: blur(12px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      border: 1px solid rgba(255,255,255,0.5);
      border-radius: 30px; padding: 6px;
      display: flex; gap: 8px; z-index: 100;
      width: 90%; max-width: 380px;
    }
    .nav-item {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 10px 0; color: var(--text-light); text-decoration: none;
      font-size: 11px; font-weight: 500; border-radius: 24px;
      transition: all 0.3s ease;
    }
    .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(93,123,157,0.3); }
    .nav-icon { font-size: 18px; margin-bottom: 2px; }

    /* --- 4. å®¹å™¨èˆ‡å¡ç‰‡ --- */
    .container { max-width: 600px; margin: 0 auto; padding: 20px 16px; width: 100%; flex: 1; overflow-y: auto; }
    section[hidden] { display: none; }
    
    .group-title { font-size: 13px; color: var(--text-light); margin: 24px 0 8px 4px; font-weight: 500; }
    .card { 
      background: var(--card); border-radius: var(--radius); overflow: hidden; 
      box-shadow: var(--shadow); margin-bottom: 16px; border: 1px solid var(--border);
    }
    
    /* --- 5. è¨˜å¸³æ ¸å¿ƒå€ --- */
    .seg-control { display: flex; background: var(--bg); border-radius: 12px; padding: 4px; margin: 0 16px 20px; }
    .seg-item { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; border-radius: 10px; color: var(--text-light); cursor: pointer; transition: 0.3s; }
    .seg-item.active { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); color: var(--text); }
    .seg-item[data-val="æ”¯å‡º"].active { color: var(--danger); }
    .seg-item[data-val="æ”¶å…¥"].active { color: var(--success); }
    
    .big-input-wrapper { display: flex; justify-content: center; padding: 0 0 24px; }
    .currency-symbol { font-size: 24px; font-weight: 500; color: var(--text-light); margin-top: 12px; margin-right: 6px; }
    .big-input {
      border: none; background: transparent; text-align: center;
      font-size: 52px; font-weight: 600; color: var(--text);
      width: 240px; padding: 0; margin: 0; font-family: monospace;
    }
    .big-input::placeholder { color: #E2E8F0; }

    .input-row {
      display: flex; align-items: center; padding: 14px 20px;
      border-bottom: 1px solid var(--border); min-height: 54px;
    }
    .input-row:last-child { border-bottom: none; }
    .row-label { width: 80px; font-size: 14px; color: var(--text-light); font-weight: 500; }
    .row-input {
      flex: 1; border: none; background: transparent;
      font-size: 15px; color: var(--text); text-align: right;
      appearance: none; padding: 0; margin: 0; font-weight: 500;
    }
    .row-input:focus { color: var(--primary); }
    select.row-input { direction: rtl; color: var(--text); }

    /* --- 6. æŒ‰éˆ• --- */
    .btn-main {
      background: var(--primary); color: #fff; width: 100%; padding: 16px;
      border: none; border-radius: var(--radius); font-size: 16px; font-weight: 600;
      margin-top: 20px; cursor: pointer; box-shadow: 0 8px 20px rgba(93,123,157,0.2);
      transition: transform 0.1s, box-shadow 0.2s; letter-spacing: 1px;
    }
    .btn-main:active { transform: scale(0.98); box-shadow: 0 4px 10px rgba(93,123,157,0.2); }
    
    .switch { position: relative; display: inline-block; width: 48px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #CBD5E1; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(20px); }

    .split-row {
      display: flex; justify-content: space-between; padding: 14px 20px;
      border-bottom: 1px solid var(--border); background: #fff; font-size: 14px;
    }
    .split-del { color: var(--text-light); font-weight: bold; margin-left: 16px; cursor: pointer; opacity: 0.5; }
    .split-del:hover { color: var(--danger); opacity: 1; }

    .record-item { 
      padding: 16px 20px; border-bottom: 1px solid var(--border); 
      display: flex; justify-content: space-between; align-items: flex-start; 
    }
    .rec-left { display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .rec-title { font-size: 15px; font-weight: 600; color: var(--text); }
    .rec-meta { font-size: 12px; color: var(--text-light); display: flex; align-items: center; gap: 8px; flex-wrap: wrap;}
    .rec-tag { background: var(--bg); padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    .rec-dates { font-size: 11px; color: #94A3B8; margin-top: 2px; font-family: monospace; }
    .rec-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .rec-amt { font-size: 17px; font-weight: 600; font-family: monospace; }
    .rec-amt.neg { color: var(--text); }
    .rec-amt.pos { color: var(--success); }

    .toast {
      position: fixed; top: 24px; left: 50%; transform: translateX(-50%) translateY(-60px);
      background: rgba(51, 65, 85, 0.95); color: white; padding: 12px 24px; border-radius: 30px;
      font-size: 14px; font-weight: 500; opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 2000; pointer-events: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

  <nav class="nav">
    <a href="#home" class="nav-item active" onclick="routeClick('home')"><span class="nav-icon">âœï¸</span>è¨˜å¸³</a>
    <a href="#recent" class="nav-item" onclick="routeClick('recent')"><span class="nav-icon">ğŸ“‹</span>æ˜ç´°</a>
    <a href="#balance" class="nav-item" onclick="routeClick('balance')"><span class="nav-icon">ğŸ’</span>è³‡ç”¢</a>
    <a href="#settings" class="nav-item" onclick="routeClick('settings')"><span class="nav-icon">âš™ï¸</span>è¨­å®š</a>
  </nav>

  <section data-view="home" class="container">
    <form id="form" autocomplete="off">
      <select id="direction" style="display:none"><option>æ”¯å‡º</option><option>æ”¶å…¥</option></select>
      
      <div class="card" style="padding-top: 24px;">
        <div class="seg-control">
          <div class="seg-item active" data-val="æ”¯å‡º" onclick="setDirection('æ”¯å‡º')">æ”¯å‡º</div>
          <div class="seg-item" data-val="æ”¶å…¥" onclick="setDirection('æ”¶å…¥')">æ”¶å…¥</div>
        </div>

        <div class="big-input-wrapper">
          <span class="currency-symbol">$</span>
          <input type="number" id="amount" class="big-input" placeholder="0" step="0.01" inputmode="decimal" oninput="saveDraft()">
        </div>

        <div class="input-row">
          <span class="row-label">æ—¥æœŸ</span>
          <input type="date" id="date" class="row-input" required onchange="saveDraft()">
        </div>

        <div class="input-row">
          <span class="row-label">ç™»è¨˜äºº</span>
          <select id="owner" class="row-input" onchange="saveDraft()"><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
        </div>
        
        <div class="input-row">
          <span class="row-label">åˆ†é¡</span>
          <select id="category" class="row-input" onchange="saveDraft()">
            <option value="">é¸æ“‡åˆ†é¡</option>
            <option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option>
            <option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option>
          </select>
        </div>

        <div class="input-row">
          <span class="row-label">å¸³æˆ¶</span>
          <select id="account" class="row-input" onchange="saveDraft()">
            <option value="">é¸æ“‡å¸³æˆ¶</option>
            <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
            <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
            <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
          </select>
        </div>

        <div class="input-row">
          <span class="row-label">é …ç›®</span>
          <div style="flex:1; display:flex; justify-content:flex-end; gap:8px;">
            <input id="itemOther" class="row-input" placeholder="è¼¸å…¥é …ç›®" style="display:none; border-bottom:1px dashed #94A3B8;" oninput="saveDraft()">
            <select id="itemSelect" class="row-input" onchange="saveDraft()">
              <option value="">é¸æ“‡é …ç›®</option>
              <option value="é£Ÿç‰©">é£Ÿç‰©</option><option value="å…¬å¸ä»£å¢Š">å…¬å¸ä»£å¢Š</option>
              <option value="ç©æ¨‚">ç©æ¨‚</option><option value="äº¤é€š">äº¤é€š</option>
              <option value="å…¶ä»–">æ‰‹å‹•è¼¸å…¥...</option>
            </select>
          </div>
        </div>

        <div class="input-row">
          <span class="row-label">å‚™è¨»</span>
          <input id="note" class="row-input" placeholder="é¸å¡«" oninput="saveDraft()">
        </div>
        
        <div class="input-row" style="justify-content: space-between;">
          <span class="row-label">å¸³æˆ¶äº’è½‰</span>
          <label class="switch">
            <input type="checkbox" id="isTransfer" onchange="saveDraft()">
            <span class="slider"></span>
          </label>
        </div>
        
        <div id="transferFields" class="input-row" style="display:none; background:#F1F5F9;">
          <span class="row-label" style="color:var(--primary)">è½‰å…¥è‡³</span>
          <select id="accountIn" class="row-input" onchange="saveDraft()">
            <option value="">é¸æ“‡è½‰å…¥å¸³æˆ¶</option>
            <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
            <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
            <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
          </select>
        </div>
      </div>

      <div id="splitSection" style="display:none">
        <div class="group-title">åˆ†å¸³é è¦½</div>
        <div class="card">
          <div id="splitList"></div>
        </div>
      </div>

      <div style="display:flex; gap:12px;">
        <button class="btn-main" type="button" id="btnAddSplit" style="background:var(--bg); color:var(--text); box-shadow:none;">
          ï¼‹ åŠ å…¥åˆ†é …
        </button>
        <button class="btn-main" type="submit" id="btnSubmit">
          ç¢ºèªé€å‡º
        </button>
      </div>
      
      <div class="group-title">æœ€è¿‘æœ¬æ©Ÿç´€éŒ„</div>
      <div class="card">
        <div class="log" id="log" style="max-height:200px; overflow:auto;"></div>
        <div style="padding:12px; text-align:center; border-top:1px solid var(--border); display:flex; justify-content:center; gap:20px;">
           <span id="btnClear" style="color:var(--danger); font-size:12px; cursor:pointer">æ¸…é™¤ç´€éŒ„</span>
           <span id="btnExport" style="color:var(--primary); font-size:12px; cursor:pointer">åŒ¯å‡º CSV</span>
        </div>
      </div>

    </form>
  </section>

  <section data-view="recent" class="container" hidden>
    <div class="card" style="padding:16px; margin-bottom:16px;">
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input type="number" id="rLimit" value="10" class="row-input" style="background:var(--bg); border-radius:8px; padding:8px; text-align:center;" placeholder="ç­†æ•¸">
        <select id="rCategory" class="row-input" style="background:var(--bg); border-radius:8px; padding:8px;"><option value="">å…¨éƒ¨åˆ†é¡</option><option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option><option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option></select>
      </div>
      <button class="btn-main" id="btnRecent" type="button" style="margin:0; padding:12px; font-size:14px;">âŸ³ åˆ·æ–°åˆ—è¡¨</button>
      <div id="recentHint" style="text-align:center; font-size:12px; color:var(--text-light); margin-top:12px;">â€”</div>
    </div>
    
    <div id="recentList" style="padding-bottom:20px;"></div>
    <div style="display:none"><select id="rAccount"><option value="">å…¨éƒ¨</option></select><select id="rOwner"><option value="">å…¨éƒ¨</option></select></div>
  </section>

  <section data-view="balance" class="container" hidden>
    <div class="card" style="padding:16px;">
       <h2 style="margin:0 0 16px; font-size:16px; color:var(--text);">ç•¶ä¸‹è³‡ç”¢ç¸½è¦½</h2>
       <button class="btn-main" id="btnBalance" type="button" style="margin-top:0; padding:12px;">æŸ¥è©¢æ‰€æœ‰é¤˜é¡</button>
    </div>
    
    <div class="card" id="balanceArea" style="display:none; padding:20px;">
       <div style="text-align:center; margin-bottom:24px;">
          <div style="font-size:12px; color:var(--text-light); margin-bottom:4px;">ç¸½è³‡ç”¢</div>
          <div id="balanceTotal" style="font-size:36px; font-weight:700; color:var(--primary);">0.00</div>
       </div>
       <div id="balanceListContainer"></div>
       <div id="balanceResult" style="font-size:10px; color:#CBD5E1; padding:8px; text-align:center; margin-top:12px;">â€”</div>
    </div>
    <select id="qOwner" style="display:none"><option value="">å…¨éƒ¨</option></select>
  </section>

  <section data-view="settings" class="container" hidden>
    <div class="group-title">é€£ç·šè¨­å®š</div>
    <div class="card">
      <div class="input-row">
        <span class="row-label">API URL</span>
        <input id="endpoint" class="row-input" value="https://script.google.com/macros/s/AKfycbzjpwoEGtRpX9FnQ0i-rSjvgaUB40gG44tBAcd_tI30R1X9HydICtdlSiooJXViatJZ/exec">
      </div>
      <div class="input-row">
        <span class="row-label">API Key</span>
        <input id="apiKey" class="row-input" placeholder="é¸å¡«">
      </div>
      <div style="display:flex; padding:16px; gap:12px;">
         <button id="btnTest" style="flex:1; padding:12px; background:var(--bg); border:none; border-radius:10px; color:var(--text);">æ¸¬è©¦</button>
         <button id="btnSaveCfg" style="flex:1; padding:12px; background:var(--text); color:#fff; border:none; border-radius:10px;">å„²å­˜</button>
      </div>
      <div id="cfgHint" style="text-align:center; font-size:12px; color:var(--text-light); padding-bottom:12px;"></div>
    </div>

    <div class="group-title">Gmail åŒ¯å…¥</div>
    <div class="card" style="padding:16px;">
      <div style="display:flex; gap:8px; margin-bottom:16px; align-items:center;">
        <input id="importDays" type="number" value="10" class="row-input" style="background:var(--bg); border-radius:8px; padding:8px; text-align:center; width:80px;" placeholder="å¤©æ•¸">
        <div style="flex:1; display:flex; align-items:center; justify-content:flex-end; gap:8px;">
           <span style="font-size:13px; color:var(--text);">å¼·åˆ¶é‡æŠ“</span>
           <label class="switch" style="transform:scale(0.8);">
             <input type="checkbox" id="importForce">
             <span class="slider"></span>
           </label>
        </div>
      </div>
      <button class="btn-main" id="btnImport" type="button" style="margin:0;">é–‹å§‹æŠ“å–å¸³å–®</button>
      <div id="importHint" style="text-align:center; font-size:12px; color:var(--text-light); margin-top:12px;">â€”</div>
      <select id="importPlatform" style="display:none"><option value="">All</option></select>
    </div>
  </section>

  <div id="toast" class="toast">è¨Šæ¯</div>

<script>
/* --- è‡ªå‹•æš«å­˜æ©Ÿåˆ¶ (Auto-Save) --- */
const DRAFT_KEY = 'spend.draft.v1';

function saveDraft() {
  const draft = {
    amount: $('amount').value,
    date: $('date').value,
    owner: $('owner').value,
    category: $('category').value,
    account: $('account').value,
    itemSelect: $('itemSelect').value,
    itemOther: $('itemOther').value,
    note: $('note').value,
    direction: $('direction').value,
    isTransfer: $('isTransfer').checked,
    accountIn: $('accountIn').value,
    splits: currentSplits
  };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
}

function restoreDraft() {
  const saved = localStorage.getItem(DRAFT_KEY);
  if (!saved) return;
  try {
    const d = JSON.parse(saved);
    // åªæœ‰ç•¶æ—¥æœŸæ˜¯ä»Šå¤©æˆ–ç©ºå€¼æ™‚æ‰é‚„åŸæ—¥æœŸï¼Œé¿å…é‚„åŸåˆ°èˆŠæ—¥æœŸï¼Œæˆ–è€…æ‚¨å¸Œæœ›æ°¸é é‚„åŸï¼Ÿ
    // é€™è£¡é¸æ“‡ï¼šå¦‚æœè‰ç¨¿æœ‰å€¼å°±é‚„åŸ
    if (d.date) $('date').value = d.date;
    if (d.amount) $('amount').value = d.amount;
    if (d.owner) $('owner').value = d.owner;
    if (d.category) $('category').value = d.category;
    if (d.account) $('account').value = d.account;
    if (d.note) $('note').value = d.note;
    if (d.direction) setDirection(d.direction);
    
    // é …ç›®è™•ç†
    $('itemSelect').value = d.itemSelect || '';
    $('itemOther').value = d.itemOther || '';
    if ($('itemSelect').value === 'å…¶ä»–') {
      $('itemOther').style.display = 'block';
    }

    // äº’è½‰è™•ç†
    $('isTransfer').checked = !!d.isTransfer;
    $('transferFields').style.display = d.isTransfer ? 'flex' : 'none';
    if (d.accountIn) $('accountIn').value = d.accountIn;
    if (d.isTransfer) {
       $('category').disabled = true;
    }

    // åˆ†å¸³è™•ç†
    if (d.splits && Array.isArray(d.splits) && d.splits.length > 0) {
      currentSplits = d.splits;
      renderSplits();
      toast('å·²é‚„åŸæœªé€å‡ºçš„è‰ç¨¿');
    }
  } catch (e) { console.log('é‚„åŸè‰ç¨¿å¤±æ•—', e); }
}

function clearDraft() {
  localStorage.removeItem(DRAFT_KEY);
  // æ¸…ç©º currentSplits (è¡¨å–®å·²åœ¨ submit æˆåŠŸå¾Œæ¸…ç©º)
  currentSplits = [];
  // é‡ç½®åˆ†å¸³ä»‹é¢
  $('splitList').innerHTML = '';
  $('splitSection').style.display = 'none';
  $('btnSubmit').textContent = 'ç¢ºèªé€å‡º';
  $('date').disabled = false; $('owner').disabled = false; $('account').disabled = false;
}

/* --- æ ¸å¿ƒ UI é‚è¼¯ --- */
function setDirection(val) {
  $('direction').value = val;
  document.querySelectorAll('.seg-item').forEach(el => el.classList.toggle('active', el.dataset.val === val));
  saveDraft(); // åˆ‡æ›æ–¹å‘ä¹Ÿå­˜
}

function routeClick(name) { location.hash = '#' + name; }
const $ = id => document.getElementById(id);
const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };
function cssEscape(s){ return String(s).replace(/[^a-zA-Z0-9_\-:.]/g,'_'); }
function showView(name){
  document.querySelectorAll('section[data-view]').forEach(sec=>sec.hidden = sec.dataset.view !== name);
  document.querySelectorAll('.nav-item').forEach(a => a.classList.toggle('active', a.getAttribute('href') === '#' + name));
}
function route(){ const name=(location.hash||'#home').slice(1); showView(['home','recent','balance','settings'].includes(name)?name:'home'); }
window.addEventListener('hashchange', route);

let isSubmitting = false; let currentSplits = [];
const ACCOUNTS = ['é»ƒç¾é‡‘','åˆ·å¡','è•­ç¾é‡‘','åˆä½œé‡‘åº«','è•­éƒµå±€','è¯å—éŠ€è¡Œ','é»ƒéƒµå±€','è•­LINE','å½°åŒ–éŠ€è¡Œ','é»ƒä¸­ä¿¡','é»ƒLINE','åœ‹æ³°ä¸–è¯'];
const CATEGORIES = ['å…±ç”¨','é»ƒæ”¯å‡º','è•­æ”¯å‡º','æ´‹æ”¯å‡º','ä¿¡ç”¨å¡','æ”¶å…¥','è² å‚µ','å¹³è¡¡','å…¬å¸ä»£å¢Š','å…¶ä»–'];
const ITEM_OPTIONS = ['é£Ÿç‰©','å…¬å¸ä»£å¢Š','ç©æ¨‚','äº¤é€š','å…¶ä»–'];
const OWNERS = ['æ¬£å®œ','å–¬çŒ·'];

(function init(){
  // é è¨­æ—¥æœŸç‚ºä»Šæ—¥
  $('date').value = new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
  
  loadCfg(); 
  restoreDraft(); // âœ… å•Ÿå‹•æ™‚å˜—è©¦é‚„åŸ
  renderLog(); 
  route();
  
  const ep = $('endpoint').value.trim(); if(ep) fetch(ep + '?ping=1').catch(()=>{});
})();

const itemSelect = $('itemSelect'), itemOther = $('itemOther');
itemSelect.onchange = ()=>{ 
  if(itemSelect.value==='å…¶ä»–'){ itemOther.style.display='block'; itemOther.focus(); } else { itemOther.style.display='none'; itemOther.value=''; } 
  saveDraft();
};

$('isTransfer').onchange = ()=>{
  const on = $('isTransfer').checked;
  $('transferFields').style.display = on ? 'flex' : 'none';
  if (on){
    $('category').value='å¹³è¡¡'; $('category').disabled=true; itemSelect.value='å…¶ä»–'; itemOther.style.display='block'; itemOther.value='å…§æ§äº’è½‰';
    setDirection('æ”¯å‡º');
    if (currentSplits.length > 0) { toast('äº’è½‰æ¨¡å¼å·²æ¸…é™¤åˆ†å¸³æš«å­˜'); currentSplits = []; renderSplits(); }
  } else { 
    $('category').disabled=false; 
    if(itemOther.value==='å…§æ§äº’è½‰'){ itemOther.value=''; itemSelect.value=''; itemOther.style.display='none'; } 
  }
  saveDraft();
};

function renderSplits() {
  const btnSubmit = $('btnSubmit');
  const listDiv = $('splitList');
  const section = $('splitSection');
  
  if (currentSplits.length === 0) {
    section.style.display = 'none'; listDiv.innerHTML = ''; btnSubmit.textContent = 'ç¢ºèªé€å‡º';
    $('date').disabled = false; $('owner').disabled = false; $('account').disabled = false;
    saveDraft(); // å­˜
    return;
  }
  
  section.style.display = 'block';
  let html = ''; let total = 0;
  currentSplits.forEach((s, i) => {
    const isOut = s.direction === 'æ”¯å‡º';
    const signed = isOut ? s.amount : -s.amount;
    total += signed;
    html += `<div class="split-row">
       <div>${s.category} - ${s.item} <span style="color:#999;font-size:12px">(${s.note||'-'})</span></div>
       <div>
         <span style="font-family:monospace; font-weight:600; color:${isOut?'var(--text)':'var(--success)'}">${isOut?'-':''}${s.amount}</span>
         <span class="split-del" data-idx="${i}">âœ•</span>
       </div>
    </div>`;
  });
  html += `<div style="padding:10px; text-align:right; font-weight:600; color:var(--primary)">æš«å­˜ç¸½è¨ˆ: ${total.toFixed(2)}</div>`;
  listDiv.innerHTML = html;
  btnSubmit.textContent = `é€å‡º ${currentSplits.length} ç­†åˆ†å¸³`;
  $('date').disabled = true; $('owner').disabled = true; $('account').disabled = true;
  saveDraft(); // å­˜
}

$('btnAddSplit').onclick = () => {
  if (currentSplits.length === 0) {
    if (!$('date').value) { toast('è«‹å¡«æ—¥æœŸ'); $('date').focus(); return; }
    if (!$('account').value) { toast('è«‹é¸å¸³æˆ¶'); $('account').focus(); return; }
  }
  const amount = Number($('amount').value || 0);
  const category = $('category').value;
  const item = (itemSelect.value==='å…¶ä»–') ? itemOther.value.trim() : itemSelect.value;
  const note = $('note').value.trim();
  const direction = $('direction').value;

  if ($('isTransfer').checked) { toast('äº’è½‰ç„¡æ³•åˆ†å¸³'); return; }
  if (!amount || amount <= 0) { toast('è«‹è¼¸é‡‘é¡'); return; }
  if (!category) { toast('è«‹é¸åˆ†é¡'); return; }
  if (!item) { toast('è«‹è¼¸é …ç›®'); return; }

  currentSplits.push({ amount, category, item, note, direction });
  renderSplits();
  $('amount').value = ''; $('note').value = ''; $('amount').focus();
};

$('splitList').onclick = (e) => {
  if (e.target.classList.contains('split-del')) {
    const idx = Number(e.target.dataset.idx);
    currentSplits.splice(idx, 1); renderSplits();
  }
};

$('form').onsubmit = (e) => {
  e.preventDefault();
  if (isSubmitting) return;
  
  const amountVal = $('amount').value;
  const amount = Number(amountVal);
  const isXfer = $('isTransfer').checked;
  
  if (currentSplits.length === 0) {
    if (!amountVal || amount <= 0) { toast('è«‹è¼¸å…¥é‡‘é¡'); return; }
    if (!isXfer && !$('category').value) { toast('è«‹é¸æ“‡åˆ†é¡'); return; }
    const it = (itemSelect.value==='å…¶ä»–') ? itemOther.value.trim() : itemSelect.value;
    if (!it) { toast('è«‹è¼¸å…¥é …ç›®'); return; }
    if (isXfer && !$('accountIn').value) { toast('è«‹é¸æ“‡è½‰å…¥å¸³æˆ¶'); return; }
  }

  isSubmitting = true;
  const btn = $('btnSubmit');
  btn.textContent = 'å‚³é€ä¸­...'; btn.disabled = true;

  const ep = $('endpoint').value.trim();
  const date = $('date').value;
  const owner = $('owner').value;
  const account = $('account').value;
  const note = $('note').value.trim();
  const norm = s => s.replace(/^åˆä½œ$/,'åˆä½œé‡‘åº«').replace(/^è•­è³´$/,'è•­LINE');
  
  let payload = { date, owner, account: norm(account), apiKey: $('apiKey').value.trim() };
  let localLogs = [];
  const d=new Date(); const pad=n=>String(n).padStart(2,'0');
  const ts=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;

  if (currentSplits.length > 0) {
    payload.action = 'split_add'; payload.splits_json = JSON.stringify(currentSplits);
    currentSplits.forEach(s => {
      localLogs.push({ ts, date, owner, direction: s.direction, amount: s.amount, category: s.category, account: norm(account), item: s.item, note: s.note });
    });
    toast(`å·²é€å‡º ${currentSplits.length} ç­†`);
    // æˆåŠŸé€å‡ºå¾Œï¼Œç¨å¾Œæœƒå‘¼å« clearDraft
    
  } else {
    const direction = $('direction').value;
    const category = isXfer ? 'å¹³è¡¡' : $('category').value;
    const item = isXfer ? 'å…§æ§äº’è½‰' : ((itemSelect.value==='å…¶ä»–')?itemOther.value.trim():itemSelect.value);
    const accountIn = $('accountIn').value;
    
    Object.assign(payload, { amount, category, item, note });
    if (isXfer) {
      payload.isTransfer = 'true'; payload.accountIn = norm(accountIn);
      addSent({ts,date,owner,direction:'æ”¯å‡º',amount,category,account:norm(account),item,note});
      addSent({ts,date,owner,direction:'æ”¶å…¥',amount,category,account:norm(accountIn),item,note});
    } else {
      payload.direction = direction;
      addSent({ts,date,owner,direction,amount,category,account:norm(account),item,note});
    }
    toast('è¨˜å¸³æˆåŠŸ');
  }

  localLogs.forEach(l => addSent(l)); renderLog();
  
  const body = new URLSearchParams(payload).toString();
  // ä½¿ç”¨ Beacon æˆ– Fetch é€å‡º
  if(navigator.sendBeacon) navigator.sendBeacon(ep, new Blob([body],{type:'application/x-www-form-urlencoded'}));
  else fetch(ep, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body, keepalive:true}).catch(()=>{});

  setTimeout(() => { 
    isSubmitting = false; 
    btn.disabled = false; 
    
    // âœ… æˆåŠŸå¾Œæ¸…é™¤è‰ç¨¿èˆ‡è¡¨å–®
    clearDraft();
    $('amount').value=''; $('note').value=''; 
    if(isXfer) { $('isTransfer').checked=false; $('transferFields').style.display='none'; $('category').disabled=false; }
    
  }, 1000);
};

const SENT_KEY='spend.sent.v19';
function loadSent(){ try{return JSON.parse(localStorage.getItem(SENT_KEY)||'[]');}catch{return[];} }
function saveSent(list){ localStorage.setItem(SENT_KEY, JSON.stringify(list.slice(-50))); }
function addSent(rec){ const list=loadSent(); list.push(rec); saveSent(list); }
function renderLog(){
  const list=loadSent().slice().reverse();
  const el=$('log');
  if(!list.length){ el.innerHTML='<div style="padding:20px;text-align:center;font-size:12px;color:#ccc">å°šç„¡ç´€éŒ„</div>'; return; }
  let h='';
  for(const r of list){
    const isOut = r.direction==='æ”¯å‡º';
    const amt = Math.abs(Number(r.amount)); 
    const sign = isOut ? '-' : '';
    h += `<div class="record-item">
       <div class="rec-left">
         <div class="rec-title">${r.item}</div>
         <div class="rec-meta">
           <span class="rec-tag">${r.category}</span>
           <span>${r.date.slice(5)}</span>
         </div>
       </div>
       <div class="rec-right">
         <span class="rec-amt ${isOut?'neg':'pos'}">${sign}${amt}</span>
       </div>
    </div>`;
  }
  el.innerHTML=h;
}
$('btnClear').onclick=()=>{ if(confirm('æ¸…é™¤?')) { localStorage.removeItem(SENT_KEY); renderLog(); }};
$('btnExport').onclick=()=>{
   const list=loadSent(); if(!list.length) return;
   const rows=[['æ—¥æœŸ','æ™‚é–“','æ–¹å‘','é‡‘é¡','åˆ†é¡','å¸³æˆ¶','é …ç›®','å‚™è¨»'].join(',')];
   list.forEach(r=>rows.push([r.date,r.ts,r.direction,r.amount,r.category,r.account,r.item,r.note].map(s=>`"${s||''}"`).join(',')));
   const blob=new Blob([rows.join('\n')],{type:'text/csv'});
   const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='log.csv'; a.click();
};

$('btnRecent').onclick=async()=>{
  const ep=$('endpoint').value.trim(); if(!ep) return;
  $('recentList').innerHTML='<div style="text-align:center;padding:20px">è¼‰å…¥ä¸­...</div>';
  try {
    const limit=$('rLimit').value; const cat=$('rCategory').value;
    const p = new URLSearchParams({recent:limit});
    if(cat) p.set('category',cat);
    const res = await fetch(ep+'?'+p);
    const data = await res.json();
    if(data.records) {
      let h='';
      data.records.forEach(r => {
         const isOut = r.direction==='æ”¯å‡º';
         const amt = Math.abs(Number(r.amount));
         const sign = isOut ? '-' : '';
         // âœ… ä¿®æ­£ï¼šåªé¡¯ç¤º MM-DD
         const dateDay = String(r.date).substring(0, 10).slice(5);
         let createdStr = '';
         if (r.createdAt) {
           const cDate = new Date(r.createdAt);
           if (!isNaN(cDate)) {
             const cM = String(cDate.getMonth()+1).padStart(2,'0');
             const cD = String(cDate.getDate()).padStart(2,'0');
             const cH = String(cDate.getHours()).padStart(2,'0');
             const cMin = String(cDate.getMinutes()).padStart(2,'0');
             createdStr = `${cM}-${cD} ${cH}:${cMin}`;
           } else {
             createdStr = r.createdAt.substring(5, 16).replace('T',' ');
           }
         }

         h += `<div class="card" style="padding:0; margin-bottom:12px;">
            <div class="record-item" style="border:none">
               <div class="rec-left">
                 <div class="rec-title">${r.item} <span style="font-weight:400;color:#94A3B8;font-size:12px">${r.note?`(${r.note})`:''}</span></div>
                 <div class="rec-meta">
                    <span class="rec-tag">${r.category}</span>
                    <span class="rec-tag">${r.account}</span>
                    <span>${r.owner}</span>
                 </div>
                 <div class="rec-dates">
                    æ¶ˆè²»: ${dateDay} | ç™»è¨˜: ${createdStr}
                 </div>
               </div>
               <div class="rec-right">
                 <span class="rec-amt ${isOut?'neg':'pos'}">${sign}${amt}</span>
                 <div style="margin-top:8px; display:flex; gap:8px;">
                    <span style="color:var(--primary); font-size:11px; cursor:pointer" onclick="toggleEdit('${cssEscape(r.createdAt||r.date)}')">ç·¨è¼¯</span>
                    <span style="color:var(--danger); font-size:11px; cursor:pointer" onclick="askDelete('${r.createdAt}')">åˆªé™¤</span>
                 </div>
               </div>
            </div>
            
            <form class="editbox" id="edit-${cssEscape(r.createdAt||r.date)}" style="display:none; padding:12px; border-top:1px dashed var(--border); background:#F8FAFC">
                <div style="display:flex; gap:8px; margin-bottom:8px">
                   <input id="amt-${cssEscape(r.createdAt)}" type="number" value="${amt}" class="row-input" style="background:#fff; border:1px solid #ddd; border-radius:6px; padding:6px; text-align:center" placeholder="é‡‘é¡">
                   <input id="note-${cssEscape(r.createdAt)}" value="${r.note||''}" class="row-input" style="background:#fff; border:1px solid #ddd; border-radius:6px; padding:6px; text-align:left" placeholder="å‚™è¨»">
                </div>
                <button class="btn-main" type="button" style="margin:0; padding:8px; font-size:12px;" onclick="submitEdit('${r.createdAt}', false, '${isOut?'æ”¯å‡º':'æ”¶å…¥'}')">å„²å­˜ä¿®æ”¹</button>
            </form>
         </div>`;
      });
      $('recentList').innerHTML = h || '<div style="text-align:center">ç„¡è³‡æ–™</div>';
      $('recentHint').textContent = `é¡¯ç¤º ${data.records.length} ç­†`;
    }
  } catch(e){ $('recentList').innerHTML='è¼‰å…¥å¤±æ•—'; }
};

function toggleEdit(k){ const el=$('edit-'+k); if(el) el.style.display = el.style.display==='none'?'block':'none'; }

async function submitEdit(rawKey, isTransfer, dir){
  const escKey = cssEscape(rawKey);
  const amt=Number(($('amt-'+escKey)?.value)||'0'); if(!(amt>0)){ toast('é‡‘é¡å¿…å¡«'); return; }
  const note=$('note-'+escKey)?.value ?? '';
  const apiKey=$('apiKey').value.trim();
  const payload={ action:'update', createdAt:rawKey, amount:String(amt), note, apiKey };
  if(!isTransfer) payload.direction=dir;
  try{
    const res=await fetch($('endpoint').value.trim(), { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams(payload).toString() });
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'æ›´æ–°å¤±æ•—');
    toast('å·²æ›´æ–°'); $('btnRecent').click();
  }catch(e){ toast('æ›´æ–°å¤±æ•—ï¼š'+e.message); }
}

async function askDelete(key){
  if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
  try{
    const body = new URLSearchParams({
        action: 'delete',
        createdAt: key,
        apiKey: $('apiKey').value
    });
    await fetch($('endpoint').value, {
        method: 'POST', 
        headers: {'Content-Type': 'application/x-www-form-urlencoded'}, 
        body: body.toString()
    });
    toast('å·²åˆªé™¤'); $('btnRecent').click();
  }catch{ toast('åˆªé™¤å¤±æ•—'); }
}

$('btnBalance').onclick=async()=>{
  const ep=$('endpoint').value.trim(); if(!ep) return;
  $('balanceResult').textContent='è¨ˆç®—ä¸­...'; 
  $('balanceListContainer').innerHTML='<div style="text-align:center; padding:10px">è¼‰å…¥ä¸­...</div>';
  $('balanceTotal').textContent='...';
  $('balanceArea').style.display = 'block';
  
  try {
     const p = new URLSearchParams({balance:'1', by:'account'});
     const res = await fetch(ep+'?'+p);
     const data = await res.json();
     
     let h='';
     if(data.breakdown) {
       data.breakdown.forEach(b => {
         h += `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee; font-size:15px;">
           <span style="color:var(--text)">${b.account}</span>
           <span style="font-family:monospace; font-weight:600;">${b.balance.toFixed(2)}</span>
         </div>`;
       });
       $('balanceListContainer').innerHTML = h;
       $('balanceTotal').textContent = data.total.toFixed(2);
       $('balanceResult').textContent = `çµ±è¨ˆç¯„åœ: å…¨éƒ¨æ™‚é–“`;
     } else {
       $('balanceListContainer').innerHTML = '<div style="text-align:center">ç„¡æ•¸æ“š</div>';
     }
  } catch { 
    $('balanceResult').textContent='å¤±æ•—'; 
    $('balanceListContainer').innerHTML = '';
  }
};

$('btnImport').onclick=async()=>{
  const ep=$('endpoint').value.trim();
  const days=$('importDays').value;
  const force=$('importForce').checked;
  $('importHint').textContent='ç³»çµ±è™•ç†ä¸­ (ç´„éœ€ 5-10 ç§’)...';
  try {
    const res = await fetch(ep, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:`action=ingest_gmail&days=${days}&force=${force}&apiKey=${$('apiKey').value}`});
    const d = await res.json();
    if(d.ok) { toast(`æ–°å¢ ${d.added} ç­†`); $('importHint').textContent=`âœ… æˆåŠŸæ–°å¢ ${d.added} ç­†`; }
    else throw d;
  } catch(e) { $('importHint').textContent='âŒ å¤±æ•—'; }
};

function loadCfg(){ 
  if(localStorage.getItem('spend.endpoint')) $('endpoint').value = localStorage.getItem('spend.endpoint');
  if(localStorage.getItem('spend.apiKey')) $('apiKey').value = localStorage.getItem('spend.apiKey');
}
$('btnSaveCfg').onclick=()=>{ localStorage.setItem('spend.endpoint',$('endpoint').value); localStorage.setItem('spend.apiKey',$('apiKey').value); toast('è¨­å®šå·²å„²å­˜'); };
$('btnTest').onclick=()=>{ fetch($('endpoint').value+'?ping=1').then(r=>toast(r.ok?'âœ… é€šè¡Œ':'âŒ å¤±æ•—')).catch(()=>toast('âŒ å¤±æ•—')); };

</script>
</body>
</html>
