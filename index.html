<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>æ”¶æ”¯å¿«è¨˜ï½œModern</title>
  <style>
    /* --- æ ¸å¿ƒè®Šæ•¸èˆ‡é‡ç½® --- */
    *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --bg: #f4f6f8; --card-bg: #ffffff;
      --primary: #2563eb; --primary-light: #eff6ff;
      --text-main: #1e293b; --text-sub: #64748b;
      --line: #e2e8f0;
      --danger: #ef4444; --success: #10b981;
      --radius: 16px; --input-radius: 12px;
      --shadow: 0 4px 20px rgba(0,0,0,0.04);
    }
    body {
      margin: 0; height: 100vh; display: flex; flex-direction: column;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text-main); font-size: 15px;
    }

    /* --- å°èˆªåˆ— (Tabs) --- */
    .nav {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
      border-top: 1px solid var(--line); position: fixed; bottom: 0; width: 100%; z-index: 100;
      display: grid; grid-template-columns: repeat(4, 1fr); padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 10px 0 8px; text-decoration: none; color: var(--text-sub); font-size: 11px; gap: 4px;
      transition: color 0.2s;
    }
    .nav-item.active { color: var(--primary); font-weight: 600; }
    .nav-icon { font-size: 20px; line-height: 1; }

    /* --- ä¸»å®¹å™¨ --- */
    .main-area {
      flex: 1; overflow-y: auto; padding: 16px 16px 100px; /* åº•éƒ¨ç•™ç™½çµ¦ Nav */
      max-width: 600px; margin: 0 auto; width: 100%;
    }
    section[hidden] { display: none; }

    /* --- å¡ç‰‡èˆ‡æ’ç‰ˆ --- */
    .card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); }
    h2 { font-size: 18px; font-weight: 700; margin: 0 0 16px; color: var(--text-main); }
    .subtitle { font-size: 13px; color: var(--text-sub); margin-bottom: 12px; }
    
    /* --- è¡¨å–®å…ƒä»¶å„ªåŒ– --- */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .full-width { grid-column: span 2; }
    
    label { display: block; font-size: 12px; color: var(--text-sub); margin-bottom: 6px; font-weight: 500; }
    
    input, select {
      width: 100%; padding: 12px; font-size: 16px;
      border: 1px solid var(--line); border-radius: var(--input-radius);
      background: #f8fafc; color: var(--text-main); transition: all 0.2s;
      appearance: none; /* ç§»é™¤åŸç”Ÿæ¨£å¼ */
    }
    input:focus, select:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px var(--primary-light); }
    
    /* é‡‘é¡è¼¸å…¥ç‰¹åŒ– */
    .amount-group { position: relative; margin-bottom: 20px; }
    .amount-input {
      font-size: 32px; font-weight: 700; text-align: center; padding: 20px;
      border: 2px solid var(--line); background: #fff; letter-spacing: 1px;
    }
    .amount-input:focus { border-color: var(--primary); }

    /* æ–¹å‘åˆ‡æ› (Segmented Control) */
    .direction-toggle {
      display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; margin-bottom: 20px;
    }
    .toggle-opt {
      flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: 600;
      border-radius: 8px; cursor: pointer; color: var(--text-sub); transition: all 0.2s;
      user-select: none;
    }
    /* éš±è—åŸå§‹ select */
    #direction { display: none; }
    
    /* ç‹€æ…‹æ¨£å¼ */
    .toggle-opt.active[data-val="æ”¯å‡º"] { background: #fff; color: var(--danger); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .toggle-opt.active[data-val="æ”¶å…¥"] { background: #fff; color: var(--success); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    /* æŒ‰éˆ• */
    .btn {
      width: 100%; padding: 14px; border: none; border-radius: var(--input-radius);
      font-size: 16px; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: transform 0.1s, opacity 0.2s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(37,99,235,0.2); }
    .btn-secondary { background: #e2e8f0; color: #475569; }
    .btn-ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--line); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* äº’è½‰å€å¡Š */
    .transfer-card {
      background: var(--primary-light); border: 1px solid #bfdbfe;
      padding: 12px; border-radius: 12px; margin-bottom: 16px;
    }
    .switch-row { display: flex; align-items: center; justify-content: space-between; }
    .switch-label { font-size: 14px; font-weight: 600; color: var(--primary); }
    /* Toggle Switch CSS */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #cbd5e1; transition: .4s; border-radius: 34px;
    }
    .slider:before {
      position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
      background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* åˆ—è¡¨èˆ‡åˆ†å¸³ */
    .split-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 0; border-bottom: 1px solid var(--line); font-size: 14px;
    }
    .split-amt { font-weight: 700; font-family: monospace; }
    .split-del { color: var(--danger); padding: 4px 8px; background: #fee2e2; border-radius: 6px; cursor: pointer; }

    /* Toast */
    .toast {
      position: fixed; top: 24px; left: 50%; transform: translateX(-50%) translateY(-20px);
      background: #1e293b; color: #fff; padding: 12px 20px; border-radius: 30px;
      font-size: 14px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 200;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 8px;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    
    /* åˆ—è¡¨é¡¯ç¤ºå„ªåŒ– */
    .list-item { padding: 16px; border-bottom: 1px solid var(--line); }
    .list-item:last-child { border-bottom: none; }
    .list-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .amt-text { font-size: 18px; font-weight: 700; font-family: monospace; }
    .date-text { font-size: 12px; color: var(--text-sub); }
    .main-text { font-size: 15px; font-weight: 500; }
    .sub-text { font-size: 13px; color: var(--text-sub); }
    
  </style>
</head>
<body>

  <div class="main-area">
    
    <section data-view="home">
      <form id="form" autocomplete="off">
        
        <div class="direction-toggle">
          <div class="toggle-opt active" data-val="æ”¯å‡º" onclick="setDirection('æ”¯å‡º')">ğŸ’¸ æ”¯å‡º</div>
          <div class="toggle-opt" data-val="æ”¶å…¥" onclick="setDirection('æ”¶å…¥')">ğŸ’° æ”¶å…¥</div>
        </div>
        <select id="direction" style="display:none"><option>æ”¯å‡º</option><option>æ”¶å…¥</option></select>

        <div class="amount-group">
          <input type="number" id="amount" class="amount-input" placeholder="0" min="0.01" step="0.01" inputmode="decimal" required>
        </div>

        <div class="card">
          <div class="form-grid">
            <div>
              <label>ğŸ“… æ—¥æœŸ</label>
              <input type="date" id="date" required>
            </div>
            <div>
              <label>ğŸ‘¤ ç™»è¨˜äºº</label>
              <select id="owner"><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
            </div>
          </div>

          <div class="form-grid">
            <div>
              <label>ğŸ·ï¸ åˆ†é¡</label>
              <select id="category">
                <option value="">è«‹é¸æ“‡</option>
                <option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option>
                <option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option>
              </select>
            </div>
            <div>
              <label>ğŸ’³ å¸³æˆ¶ (è½‰å‡º)</label>
              <select id="account">
                <option value="">è«‹é¸æ“‡</option>
                <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
                <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
                <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
              </select>
            </div>
          </div>

          <div style="margin-bottom: 12px;">
            <label>ğŸ“ é …ç›®</label>
            <div style="display:flex; gap:8px;">
              <select id="itemSelect" style="flex:1">
                <option value="">è«‹é¸æ“‡é …ç›®</option>
                <option value="é£Ÿç‰©">ğŸ± é£Ÿç‰©</option>
                <option value="å…¬å¸ä»£å¢Š">ğŸ¢ å…¬å¸ä»£å¢Š</option>
                <option value="ç©æ¨‚">ğŸ‰ ç©æ¨‚</option>
                <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                <option value="å…¶ä»–">ğŸ–Šï¸ å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option>
              </select>
              <input id="itemOther" placeholder="è¼¸å…¥é …ç›®..." style="display:none; flex:1;">
            </div>
          </div>

          <div style="margin-bottom: 12px;">
             <label>ğŸ’¬ å‚™è¨»</label>
             <input id="note" placeholder="é¸å¡«...">
          </div>

          <div class="transfer-card">
            <div class="switch-row">
              <span class="switch-label">ğŸ”„ å¸³æˆ¶äº’è½‰æ¨¡å¼</span>
              <label class="switch">
                <input type="checkbox" id="isTransfer">
                <span class="slider"></span>
              </label>
            </div>
            <div id="transferFields" style="display:none; margin-top:12px; border-top:1px dashed #93c5fd; padding-top:12px;">
              <label style="color:#1e40af">ğŸ¯ è½‰å…¥å¸³æˆ¶</label>
              <select id="accountIn">
                <option value="">è«‹é¸æ“‡è½‰å…¥å¸³æˆ¶</option>
                <option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option>
                <option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option>
                <option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
              </select>
            </div>
          </div>

          <div id="splitList" style="margin-bottom:12px"></div>
          <button class="btn btn-secondary" type="button" id="btnAddSplit" style="margin-bottom:16px">
            â• åŠ å…¥åˆ†é … (æš«å­˜)
          </button>

          <button class="btn btn-primary" type="submit" id="btnSubmit">
            ğŸš€ ç¢ºèªé€å‡º
          </button>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>æœ€è¿‘ç™¼é€ (æœ¬æ©Ÿ)</h2>
            <div style="display:flex; gap:8px">
               <button class="btn btn-ghost" id="btnExport" type="button" style="font-size:12px; padding:6px 12px;">åŒ¯å‡º</button>
               <button class="btn btn-ghost" id="btnClear" type="button" style="font-size:12px; padding:6px 12px; color:var(--danger); border-color:var(--danger)">æ¸…é™¤</button>
            </div>
          </div>
          <div class="log" id="log" style="font-size:13px; color:#64748b;"></div>
        </div>
      </form>
    </section>

    <section data-view="recent" hidden>
      <div class="card">
        <h2>â˜ï¸é›²ç«¯ç´€éŒ„æŸ¥è©¢</h2>
        <div class="form-grid">
           <input type="number" id="rLimit" value="10" placeholder="ç­†æ•¸">
           <select id="rOwner"><option value="">å…¨éƒ¨äºº</option><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
        </div>
        <div class="form-grid">
           <select id="rAccount"><option value="">å…¨éƒ¨å¸³æˆ¶</option><option>é»ƒç¾é‡‘</option><option>åˆ·å¡</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option><option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option><option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option></select>
           <select id="rCategory"><option value="">å…¨éƒ¨åˆ†é¡</option><option>å…±ç”¨</option><option>é»ƒæ”¯å‡º</option><option>è•­æ”¯å‡º</option><option>æ´‹æ”¯å‡º</option><option>ä¿¡ç”¨å¡</option><option>æ”¶å…¥</option><option>è² å‚µ</option><option>å¹³è¡¡</option><option>å…¬å¸ä»£å¢Š</option><option>å…¶ä»–</option></select>
        </div>
        <button class="btn btn-primary" id="btnRecent" type="button">ğŸ” æŸ¥è©¢</button>
        <p class="subtitle mono" id="recentHint" style="margin-top:10px; text-align:center">â€”</p>
      </div>
      <div id="recentList" style="display:none"></div>
    </section>

    <section data-view="balance" hidden>
      <div class="card">
        <h2>ğŸ’° å¸³æˆ¶é¤˜é¡</h2>
        <div class="form-grid">
          <input id="qMonth" placeholder="æœˆä»½ (2025-11)">
          <select id="qOwner"><option value="">æ‰€æœ‰äºº</option><option>æ¬£å®œ</option><option>å–¬çŒ·</option></select>
        </div>
        <button class="btn btn-primary" id="btnBalance" type="button">æŸ¥è©¢é¤˜é¡</button>
        
        <div id="balanceArea" style="margin-top:20px">
          <p class="subtitle mono" id="balanceResult" style="text-align:center">â€”</p>
          <table class="table" id="balanceTable" style="width:100%; display:none; border-collapse:collapse;">
            <thead><tr style="background:#f1f5f9; text-align:left;"><th style="padding:10px; border-radius:8px 0 0 8px;">å¸³æˆ¶</th><th style="padding:10px; text-align:right; border-radius:0 8px 8px 0;">é¤˜é¡</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><th style="padding:10px;">ç¸½è¨ˆ</th><th style="padding:10px; text-align:right; color:var(--primary);" id="balanceTotal">0.00</th></tr></tfoot>
          </table>
        </div>
      </div>
    </section>

    <section data-view="settings" hidden>
      <div class="card">
        <h2>âš™ï¸ é€£ç·šè¨­å®š</h2>
        <label>Endpoint URL</label>
        <input id="endpoint" value="https://script.google.com/macros/s/AKfycbzjpwoEGtRpX9FnQ0i-rSjvgaUB40gG44tBAcd_tI30R1X9HydICtdlSiooJXViatJZ/exec">
        <label>API Key</label>
        <input id="apiKey">
        <div class="form-grid" style="margin-top:12px">
          <button class="btn btn-secondary" id="btnTest" type="button">æ¸¬è©¦é€£ç·š</button>
          <button class="btn btn-primary" id="btnSaveCfg" type="button">å„²å­˜</button>
        </div>
        <p class="subtitle" id="cfgHint" style="margin-top:8px"></p>
      </div>

      <div class="card">
        <h2>ğŸ›µ å¤–é€åŒ¯å…¥ (Gmail)</h2>
        <div class="form-grid">
           <input id="importDays" type="number" value="10" placeholder="å¤©æ•¸">
           <select id="importPlatform"><option value="">å…¨éƒ¨å¹³å°</option><option value="foodpanda">Foodpanda</option><option value="uber">Uber Eats</option></select>
        </div>
        <div class="switch-row" style="margin:10px 0;">
           <span class="switch-label" style="font-weight:400; color:var(--text-main)">å¼·åˆ¶é‡æ–°åŒ¯å…¥</span>
           <label class="switch"><input type="checkbox" id="importForce"><span class="slider"></span></label>
        </div>
        <button class="btn btn-primary" id="btnImport" type="button">ğŸš€ æŠ“å–å¸³å–®</button>
        <p class="subtitle" id="importHint" style="margin-top:10px">â€”</p>
      </div>
    </section>
  </div>

  <nav class="nav">
    <a class="nav-item active" href="#home" onclick="routeByClick('home')">
      <span class="nav-icon">ğŸ“</span>
      <span>è¨˜å¸³</span>
    </a>
    <a class="nav-item" href="#recent" onclick="routeByClick('recent')">
      <span class="nav-icon">ğŸ•’</span>
      <span>æœ€æ–°</span>
    </a>
    <a class="nav-item" href="#balance" onclick="routeByClick('balance')">
      <span class="nav-icon">ğŸ“Š</span>
      <span>é¤˜é¡</span>
    </a>
    <a class="nav-item" href="#settings" onclick="routeByClick('settings')">
      <span class="nav-icon">âš™ï¸</span>
      <span>è¨­å®š</span>
    </a>
  </nav>

  <div id="toast" class="toast">âœ… è¨Šæ¯</div>

<script>
/* --- æ–°ç‰ˆ UI è¼”åŠ©å‡½å¼ --- */
function setDirection(val) {
  document.getElementById('direction').value = val;
  document.querySelectorAll('.toggle-opt').forEach(el => {
    el.classList.toggle('active', el.dataset.val === val);
  });
}
function routeByClick(name) {
  location.hash = '#' + name;
}

/* --- ä»¥ä¸‹ç‚ºåŸæœ‰é‚è¼¯ (å®Œå…¨ä¿ç•™ï¼Œç¢ºä¿åŠŸèƒ½æ­£å¸¸) --- */
function showView(name){
  document.querySelectorAll('section[data-view]').forEach(sec=>sec.hidden = sec.dataset.view !== name);
  document.querySelectorAll('.nav-item').forEach(a => {
    a.classList.toggle('active', a.getAttribute('href') === '#' + name);
  });
}
function route(){ const name=(location.hash||'#home').slice(1); showView(['home','recent','balance','settings'].includes(name)?name:'home'); }
window.addEventListener('hashchange', route);

const $ = id => document.getElementById(id);
const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };
function cssEscape(s){ return String(s).replace(/[^a-zA-Z0-9_\-:.]/g,'_'); }

let isSubmitting = false; let currentSplits = [];
const ACCOUNTS = ['é»ƒç¾é‡‘','åˆ·å¡','è•­ç¾é‡‘','åˆä½œé‡‘åº«','è•­éƒµå±€','è¯å—éŠ€è¡Œ','é»ƒéƒµå±€','è•­LINE','å½°åŒ–éŠ€è¡Œ','é»ƒä¸­ä¿¡','é»ƒLINE','åœ‹æ³°ä¸–è¯'];
const CATEGORIES = ['å…±ç”¨','é»ƒæ”¯å‡º','è•­æ”¯å‡º','æ´‹æ”¯å‡º','ä¿¡ç”¨å¡','æ”¶å…¥','è² å‚µ','å¹³è¡¡','å…¬å¸ä»£å¢Š','å…¶ä»–'];
const ITEM_OPTIONS = ['é£Ÿç‰©','å…¬å¸ä»£å¢Š','ç©æ¨‚','äº¤é€š','å…¶ä»–'];
const OWNERS = ['æ¬£å®œ','å–¬çŒ·'];

(function init(){
  $('date').value = new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
  // å˜—è©¦é€£ç·š (éé˜»å¡)
  const ep = $('endpoint').value.trim();
  if(ep) fetch(ep + '?ping=1').catch(()=>{});
  loadCfg(); renderLog(); route();
})();

/* é …ç›®å…¶ä»–é‚è¼¯ */
const itemSelect = $('itemSelect'), itemOther = $('itemOther');
itemSelect.onchange = ()=>{ if(itemSelect.value==='å…¶ä»–'){ itemOther.style.display='block'; itemOther.focus(); } else { itemOther.style.display='none'; itemOther.value=''; } };

/* äº’è½‰åˆ‡æ›é‚è¼¯ */
$('isTransfer').onchange = ()=>{
  const on = $('isTransfer').checked;
  $('transferFields').style.display = on ? 'block' : 'none';
  if (on){
    $('category').value='å¹³è¡¡'; $('category').disabled=true; itemSelect.value='å…¶ä»–'; itemOther.style.display='block'; itemOther.value='å…§æ§äº’è½‰';
    setDirection('æ”¯å‡º'); // äº’è½‰é è¨­ç‚ºæ”¯å‡ºæ–¹å‘é¡¯ç¤º
    if (currentSplits.length > 0) {
      toast('æ¸…é™¤åˆ†å¸³æš«å­˜ä»¥å•Ÿç”¨äº’è½‰');
      currentSplits = [];
      renderSplits();
    }
  }
  else { 
    $('category').disabled=false; 
    if(itemOther.value==='å…§æ§äº’è½‰'){ itemOther.value=''; itemSelect.value=''; itemOther.style.display='none'; } 
  }
};

/* åˆ†å¸³é‚è¼¯ */
function setSharedFieldsDisabled(disabled) {
  $('date').disabled = disabled;
  $('owner').disabled = disabled;
  $('account').disabled = disabled;
}
function renderSplits() {
  const btnSubmit = $('btnSubmit');
  if (currentSplits.length === 0) {
    $('splitList').innerHTML = '';
    btnSubmit.textContent = 'ğŸš€ ç¢ºèªé€å‡º';
    setSharedFieldsDisabled(false);
    return;
  }
  let html = '<div style="background:#f8fafc; padding:10px; border-radius:12px; border:1px solid var(--line);">';
  let totalSplit = 0;
  currentSplits.forEach((s, i) => {
    const signedAmt = s.direction === 'æ”¯å‡º' ? s.amount : -s.amount;
    totalSplit += signedAmt;
    const isOut = s.direction === 'æ”¯å‡º';
    html += `<div class="split-item">
      <div>
        <div style="font-weight:600">${s.category} Â· ${s.item}</div>
        <div style="color:#64748b; font-size:12px">${s.note || 'ç„¡å‚™è¨»'}</div>
      </div>
      <div style="display:flex; align-items:center; gap:10px">
        <span class="split-amt ${isOut?'neg':'pos'}" style="color:${isOut?'var(--danger)':'var(--success)'}">
          ${isOut?'-':''}${s.amount.toFixed(2)}
        </span>
        <span class="split-del" data-idx="${i}">âœ•</span>
      </div>
    </div>`;
  });
  html += `<div style="text-align:right; font-weight:700; margin-top:8px; color:var(--primary)">æš«å­˜ç¸½è¨ˆ: ${totalSplit.toFixed(2)}</div></div>`;
  $('splitList').innerHTML = html;
  btnSubmit.textContent = `ğŸš€ é€å‡º ${currentSplits.length} ç­†åˆ†å¸³`;
  setSharedFieldsDisabled(true);
}

$('btnAddSplit').onclick = () => {
  if (currentSplits.length === 0) {
    if (!$('date').value) { toast('è«‹å…ˆå¡«å¯«æ—¥æœŸ'); $('date').focus(); return; }
    if (!$('account').value) { toast('è«‹å…ˆé¸æ“‡è½‰å‡ºå¸³æˆ¶'); $('account').focus(); return; }
  }
  const amount = Number($('amount').value || 0);
  const category = $('category').value;
  const item = ($('itemSelect').value==='å…¶ä»–') ? $('itemOther').value.trim() : $('itemSelect').value;
  const note = $('note').value.trim();
  const direction = $('direction').value;
  if ($('isTransfer').checked) { toast('äº’è½‰æ¨¡å¼ä¸‹ç„¡æ³•æ–°å¢åˆ†é …'); return; }
  if (!amount || amount <= 0 || !category || !item) { toast('åˆ†é …çš„é‡‘é¡ã€åˆ†é¡ã€é …ç›®é ˆå¡«å¯«'); return; }

  currentSplits.push({ amount, category, item, note, direction });
  renderSplits();
  // é‡ç½®è¼¸å…¥
  $('amount').value = '';
  $('itemSelect').value = '';
  $('itemOther').value = '';
  $('itemOther').style.display = 'none';
  $('note').value = '';
  $('amount').focus();
};

$('splitList').onclick = (e) => {
  if (e.target.classList.contains('split-del')) {
    const idx = Number(e.target.dataset.idx);
    currentSplits.splice(idx, 1);
    renderSplits();
  }
};

/* æœ¬æ©Ÿç´€éŒ„ Log */
const SENT_KEY='spend.sent.v19';
function loadSent(){ try{return JSON.parse(localStorage.getItem(SENT_KEY)||'[]');}catch{return[];} }
function saveSent(list){ localStorage.setItem(SENT_KEY, JSON.stringify(list.slice(-50))); }
function addSent(rec){ const list=loadSent(); list.push(rec); saveSent(list); }
function renderLog(){
  const list=loadSent().slice().reverse();
  if(!list.length){ $('log').innerHTML='<div style="text-align:center; padding:20px">å°šç„¡æœ¬æ©Ÿç´€éŒ„</div>'; return; }
  let html='';
  for(const r of list){
    const isOut=r.direction==='æ”¯å‡º'; const amt=Math.abs(Number(r.amount||0));
    html+=`<div class="list-item" style="padding:10px 0; border-bottom:1px solid var(--line)">
      <div class="list-row">
        <span class="main-text">${r.item}</span>
        <span class="amt-text" style="color:${isOut?'var(--danger)':'var(--success)'}">${isOut?'-':''}${amt}</span>
      </div>
      <div class="list-row">
        <span class="sub-text">${r.category} Â· ${r.account} Â· ${r.owner}</span>
        <span class="date-text">${r.ts.split(' ')[1]||''}</span>
      </div>
    </div>`;
  }
  $('log').innerHTML=html;
}
$('btnExport').onclick=()=>{
  const list=loadSent(); 
  if(list.length===0){ toast('ç„¡ç´€éŒ„å¯åŒ¯å‡º'); return; }
  const header=['æ—¥æœŸ','æ™‚é–“æˆ³','æ–¹å‘','é‡‘é¡','åˆ†é¡','å¸³æˆ¶','é …ç›®','å‚™è¨»','ç™»è¨˜äºº'];
  const rows=[header.join(',')];
  const esc=s=>{if(s==null)return'';const t=String(s).replace(/"/g,'""');return /[",\n]/.test(t)?`"${t}"`:t;}
  for(const r of list){ rows.push([r.date||'',r.ts||'',r.direction||'',r.amount||'',r.category||'',r.account||'',r.item||'',r.note||'',r.owner||''].map(esc).join(',')); }
  const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'}),url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='spend-log.csv'; a.click(); URL.revokeObjectURL(url);
};
$('btnClear').onclick=()=>{ if(confirm('æ¸…é™¤æœ¬æ©Ÿç´€éŒ„ï¼Ÿ')){ localStorage.removeItem(SENT_KEY); renderLog(); } };

/* èƒŒæ™¯é€å‡º */
function backgroundSend(url, payloadObj){
  const body=new URLSearchParams(payloadObj).toString();
  const mime='application/x-www-form-urlencoded;charset=UTF-8';
  if(navigator.sendBeacon){ navigator.sendBeacon(url,new Blob([body],{type:mime})); }
  else{ fetch(url,{method:'POST',headers:{'Content-Type':mime},body,keepalive:true}).catch(()=>{}); }
}

/* æäº¤é‚è¼¯ */
$('form').onsubmit=(e)=>{
  e.preventDefault();
  if (isSubmitting) return;
  isSubmitting = true;
  const btnSubmit = $('btnSubmit');
  const originalBtnText = btnSubmit.textContent;
  btnSubmit.disabled = true; btnSubmit.textContent = 'â³ è™•ç†ä¸­...';

  const endpoint=$('endpoint').value.trim(); const apiKey=$('apiKey').value.trim();
  const date=$('date').value, owner=$('owner').value, account=$('account').value;
  const norm=s=>s.replace(/^åˆä½œ$/,'åˆä½œé‡‘åº«').replace(/^è•­è³´$/,'è•­LINE');

  if (!date) { toast('è«‹è¼¸å…¥æ—¥æœŸ'); isSubmitting = false; btnSubmit.disabled = false; btnSubmit.textContent=originalBtnText; return; }
  if (!account) { toast('è«‹é¸æ“‡å¸³æˆ¶'); isSubmitting = false; btnSubmit.disabled = false; btnSubmit.textContent=originalBtnText; return; }
  
  const d=new Date(); const pad=n=>String(n).padStart(2,'0'); const ts=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  let payload={ date, owner, account:norm(account), apiKey };
  let localLogs = [];

  if (currentSplits.length > 0) {
    payload.action = 'split_add';
    payload.splits_json = JSON.stringify(currentSplits);
    currentSplits.forEach(s => {
      localLogs.push({ ts, date, owner, direction: s.direction, amount: s.amount, category: s.category, account: norm(account), item: s.item, note: s.note });
    });
    toast(`å·²é€å‡º ${currentSplits.length} ç­†åˆ†å¸³`);
    currentSplits = []; renderSplits();
    // æ¸…ç©ºè¡¨å–®
    $('amount').value=''; $('itemSelect').value=''; $('itemOther').value=''; $('note').value='';
  } else {
    const direction=$('direction').value, amount=$('amount').value, isXfer=$('isTransfer').checked;
    const category=isXfer?'å¹³è¡¡':$('category').value;
    const item=isXfer?'å…§æ§äº’è½‰':((itemSelect.value==='å…¶ä»–')?$('itemOther').value.trim():itemSelect.value);
    const note=$('note').value.trim();
    const accountIn=$('accountIn').value;
    
    if(!amount||Number(amount)<=0){ toast('è«‹è¼¸å…¥é‡‘é¡'); isSubmitting=false; btnSubmit.disabled=false; btnSubmit.textContent=originalBtnText; return; }
    if(!isXfer && !category){ toast('è«‹é¸æ“‡åˆ†é¡'); isSubmitting=false; btnSubmit.disabled=false; btnSubmit.textContent=originalBtnText; return; }
    if(!item){ toast('è«‹å¡«å¯«é …ç›®'); isSubmitting=false; btnSubmit.disabled=false; btnSubmit.textContent=originalBtnText; return; }
    if(isXfer&&!accountIn){ toast('è«‹é¸æ“‡è½‰å…¥å¸³æˆ¶'); isSubmitting=false; btnSubmit.disabled=false; btnSubmit.textContent=originalBtnText; return; }

    if(isXfer){
      addSent({ts,date,owner,direction:'æ”¯å‡º',amount:Number(amount),category,account:norm(account),item,note});
      addSent({ts,date,owner,direction:'æ”¶å…¥',amount:Number(amount),category,account:norm(accountIn),item,note});
    } else {
      addSent({ts,date,owner,direction,amount:Number(amount),category,account:norm(account),item,note});
    }
    Object.assign(payload, { amount, category, item, note });
    if(isXfer){ payload.isTransfer='true'; payload.accountIn=norm(accountIn); } else { payload.direction=direction; }
    
    toast('âœ… è¨˜å¸³æˆåŠŸ');
    $('amount').value=''; $('itemOther').value=''; $('note').value='';
    if($('itemSelect').value !== 'å…¶ä»–') $('itemSelect').value = '';
    if(isXfer){ $('isTransfer').checked=false; $('transferFields').style.display='none'; $('category').disabled=false; }
  }
  
  localLogs.forEach(log => addSent(log));
  renderLog();
  backgroundSend(endpoint, payload);
  
  setTimeout(() => {
    isSubmitting = false;
    btnSubmit.disabled = false;
    btnSubmit.textContent = 'ğŸš€ ç¢ºèªé€å‡º';
  }, 1000);
};

/* æœ€æ–°ç´€éŒ„ (UIæ¸²æŸ“éƒ¨åˆ†å¾®èª¿) */
$('btnRecent').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆè¨­å®š Endpoint'); return; }
  const limit=Math.max(1,Math.min(50,Number($('rLimit').value)||10));
  const params=new URLSearchParams({recent:String(limit)});
  const acc=$('rAccount').value.trim(), cat=$('rCategory').value.trim(), own=$('rOwner').value.trim();
  if(acc)params.set('account',acc); if(cat)params.set('category',cat); if(own)params.set('owner',own);
  $('recentHint').textContent='æŸ¥è©¢ä¸­...'; $('recentList').style.display='none';
  try{
    const res=await fetch(`${endpoint}?${params.toString()}`); if(!res.ok) throw 0;
    const data=await res.json(); if(!data.ok||!Array.isArray(data.records)) throw 0;
    renderRecent(data.records); $('recentHint').textContent=`é¡¯ç¤ºæœ€è¿‘ ${Math.min(data.records.length,limit)} ç­†`; $('recentList').style.display='';
  }catch{ $('recentHint').textContent='æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Endpoint'; }
};

function makeOptions(list, selected, includeEmpty=true, emptyLabel='ä¸è®Š'){
  const opts=[]; if(includeEmpty)opts.push(`<option value="">${emptyLabel}</option>`);
  for(const v of list){ opts.push(`<option value="${v}"${v===selected?' selected':''}>${v}</option>`); }
  return opts.join('');
}

function renderRecent(records){
  const listEl=$('recentList');
  const frag = document.createDocumentFragment();
  listEl.innerHTML='';
  records.forEach((r)=>{
    const amtRaw=Number(r.amount||0), isOut=(r.direction==='æ”¯å‡º'); const amt=Math.abs(amtRaw);
    const rawKey = r.createdAt || r.date || '';
    const escKey = cssEscape(rawKey);
    const isTransferRow=(r.category==='å¹³è¡¡' && r.item==='å…§æ§äº’è½‰');
    
    const wrapper = document.createElement('div');
    wrapper.className='card'; // ä½¿ç”¨å¡ç‰‡æ¨£å¼
    wrapper.style.padding='16px'; wrapper.style.marginBottom='12px';
    
    wrapper.innerHTML = `
      <div style="display:flex; justify-content:space-between; margin-bottom:8px">
        <span class="amt-text" style="color:${isOut?'var(--danger)':'var(--success)'}">${isOut?'-':''}${amt}</span>
        <span class="date-text">${rawKey}</span>
      </div>
      <div style="font-size:15px; font-weight:600; margin-bottom:4px">${r.item} ${r.note?`<span style="color:#94a3b8;font-weight:400">(${r.note})</span>`:''}</div>
      <div class="sub-text">${r.category} Â· ${r.account} Â· ${r.owner}</div>
      <div style="margin-top:12px; display:flex; gap:8px">
        <button class="btn btn-secondary" style="flex:1; font-size:13px; padding:8px" onclick="toggleEdit('${rawKey}')">âœï¸ ç·¨è¼¯</button>
        <button class="btn btn-ghost" style="flex:1; font-size:13px; padding:8px; color:var(--danger); border-color:var(--line)" onclick="askDelete('${rawKey}')">ğŸ—‘ åˆªé™¤</button>
      </div>
      
      <form class="editbox" id="edit-${escKey}" style="display:none; margin-top:12px; padding-top:12px; border-top:1px dashed var(--line)">
        <div class="form-grid">
           <input id="amt-${escKey}" type="number" value="${amt}" placeholder="é‡‘é¡">
           <input id="note-${escKey}" value="${r.note||''}" placeholder="å‚™è¨»">
        </div>
        <div class="form-grid">
           <select id="acc-${escKey}">${makeOptions(ACCOUNTS, r.account, true, 'å¸³æˆ¶ä¸è®Š')}</select>
           <select id="cat-${escKey}">${makeOptions(CATEGORIES, r.category, true, 'åˆ†é¡ä¸è®Š')}</select>
        </div>
        <div class="form-grid">
           <select id="itemSel-${escKey}" onchange="editItemChanged('${rawKey}')">${makeOptions(ITEM_OPTIONS, ITEM_OPTIONS.includes(r.item)?r.item:'å…¶ä»–', true, 'é …ç›®ä¸è®Š')}</select>
           <select id="owner-${escKey}">${makeOptions(OWNERS, r.owner, true, 'ç™»è¨˜äººä¸è®Š')}</select>
        </div>
        <input id="itemOther-${escKey}" placeholder="è¼¸å…¥é …ç›®" style="margin-bottom:8px; ${!ITEM_OPTIONS.includes(r.item)?'':'display:none;'}" value="${!ITEM_OPTIONS.includes(r.item)?r.item:''}">
        ${ isTransferRow ? `<select id="accIn-${escKey}" style="margin-bottom:8px">${makeOptions(ACCOUNTS,'',true,'è½‰å…¥å¸³æˆ¶ä¸è®Š')}</select>` : '' }
        <button class="btn btn-primary" type="button" onclick="submitEdit('${rawKey}', ${isTransferRow}, '${isOut?'æ”¯å‡º':'æ”¶å…¥'}')">ğŸ’¾ å„²å­˜è®Šæ›´</button>
      </form>
    `;
    frag.appendChild(wrapper);
  });
  listEl.appendChild(frag);
  listEl.style.display='';
}

function toggleEdit(k){ const el=$('edit-'+cssEscape(k)); if(el) el.style.display = el.style.display==='none'?'block':'none'; }
function editItemChanged(k){ const s=$('itemSel-'+cssEscape(k)), o=$('itemOther-'+cssEscape(k)); if(s.value==='å…¶ä»–'){o.style.display='block';o.focus();}else{o.style.display='none';o.value='';} }

/* æ›´æ–°/åˆªé™¤/é¤˜é¡/è¨­å®š ç­‰ API å‘¼å«é‚è¼¯èˆ‡èˆŠç‰ˆå®Œå…¨ç›¸åŒ (åƒ… class/style å¾®èª¿å·²å…§åµŒæ–¼ renderRecent) */
async function submitEdit(rawKey, isTransfer, dir){
  const escKey = cssEscape(rawKey);
  const amt=Number(($('amt-'+escKey)?.value)||'0'); if(!(amt>0)){ toast('é‡‘é¡å¿…å¡«'); return; }
  const note=$('note-'+escKey)?.value ?? '';
  const account=$('acc-'+escKey)?.value ?? '';
  const category=$('cat-'+escKey)?.value ?? '';
  const owner=$('owner-'+escKey)?.value ?? '';
  const itemSel=$('itemSel-'+escKey)?.value ?? '';
  const itemOther=$('itemOther-'+escKey)?.value?.trim() ?? '';
  const item=(itemSel==='å…¶ä»–')?itemOther:itemSel;
  const apiKey=$('apiKey').value.trim();
  const payload={ action:'update', createdAt:rawKey, amount:String(amt), note, account, category, owner, item:item||'', apiKey };
  if(isTransfer){ const ain=$('accIn-'+escKey)?.value ?? ''; payload.isTransfer='true'; if(ain) payload.accountIn=ain; }
  else { payload.direction=dir; }
  try{
    const res=await fetch($('endpoint').value.trim(), { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body:new URLSearchParams(payload).toString() });
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'æ›´æ–°å¤±æ•—');
    toast('å·²æ›´æ–°'); $('btnRecent').click();
  }catch(e){ toast('æ›´æ–°å¤±æ•—ï¼š'+e.message); }
}
async function askDelete(rawKey){
  if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
  const apiKey=$('apiKey').value.trim();
  try{
    const res=await fetch($('endpoint').value.trim(), { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body:new URLSearchParams({action:'delete', createdAt:rawKey, apiKey}).toString() });
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'åˆªé™¤å¤±æ•—');
    toast('å·²åˆªé™¤'); $('btnRecent').click();
  }catch(e){ toast('åˆªé™¤å¤±æ•—ï¼š'+e.message); }
}
/* é¤˜é¡ã€è¨­å®šã€GmailåŒ¯å…¥é‚è¼¯ç¶­æŒä¸è®Š */
$('btnBalance').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆè¨­å®š Endpoint'); return; }
  const params=new URLSearchParams({balance:'1',by:'account'}); const m=$('qMonth').value.trim(), own=$('qOwner').value.trim();
  if(m)params.set('month',m); if(own)params.set('owner',own);
  $('balanceResult').textContent='æŸ¥è©¢ä¸­...'; $('balanceTable').style.display='none';
  try{
    const res=await fetch(`${endpoint}?${params.toString()}`); if(!res.ok) throw 0;
    const data=await res.json(); if(!data.ok||!Array.isArray(data.breakdown)) throw 0;
    const map=new Map(data.breakdown.map(x=>[x.account,Number(x.balance||0)]));
    const rows=ACCOUNTS.map(a=>({account:a,balance:map.has(a)?map.get(a):0}));
    const tbody=document.querySelector('#balanceTable tbody');
    tbody.innerHTML=rows.map(r=>`<tr><td style="padding:10px; border-bottom:1px solid #f1f5f9">${r.account}</td><td style="padding:10px; text-align:right; border-bottom:1px solid #f1f5f9">${r.balance.toFixed(2)}</td></tr>`).join('');
    const total=rows.reduce((s,r)=>s+r.balance,0);
    $('balanceTotal').textContent=total.toFixed(2);
    $('balanceResult').textContent=`ä¾†æºï¼š${data.source||'detail'}`;
    $('balanceTable').style.display='';
  }catch{ $('balanceResult').textContent='æŸ¥è©¢å¤±æ•—'; }
};
function loadCfg(){ $('endpoint').value = localStorage.getItem('spend.endpoint') || $('endpoint').value; $('apiKey').value = localStorage.getItem('spend.apiKey') || ''; $('cfgHint').textContent = $('endpoint').value ? 'âœ… å·²è®€å–è¨­å®š' : 'âš ï¸ å°šæœªè¨­å®š'; }
$('btnTest').onclick=async()=>{ try{ const r=await fetch($('endpoint').value.trim()+'?ping=1'); toast(r.ok?'âœ… é€£ç·šæ­£å¸¸':'âŒ é€£ç·šå¤±æ•—'); }catch{ toast('âŒ é€£ç·šå¤±æ•—'); } };
$('btnSaveCfg').onclick=()=>{ localStorage.setItem('spend.endpoint', $('endpoint').value.trim()); localStorage.setItem('spend.apiKey', $('apiKey').value.trim()); loadCfg(); toast('âœ… è¨­å®šå·²å„²å­˜'); };
$('btnImport').onclick=async()=>{
  const endpoint=$('endpoint').value.trim(); if(!endpoint){ toast('è«‹å…ˆè¨­å®š Endpoint'); return; }
  const days=Math.max(1,Math.min(90,Number($('importDays').value)||10));
  const force = $('importForce').checked ? 'true' : 'false';
  $('importHint').textContent='è™•ç†ä¸­...';
  try{
    const res=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'}, body:new URLSearchParams({action:'ingest_gmail',days:String(days),force,apiKey:$('apiKey').value.trim()}).toString()});
    const data=await res.json(); if(!data.ok) throw new Error(data.error||'å¤±æ•—');
    toast(`æ–°å¢ ${data.added||0} ç­†`); $('importHint').textContent=`âœ… æˆåŠŸæ–°å¢ ${data.added} ç­†`;
  }catch(e){ $('importHint').textContent='âŒ ' + e.message; }
};
</script>
</body>
</html>
