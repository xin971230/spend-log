<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>æ”¶æ”¯å¿«è¨˜ v6.2</title>
  <style>
    :root {
      --bg: #F5F5F7;
      --card: #FFFFFF;
      --text: #1C1C1E;
      --text-light: #8E8E93;
      --primary: #2C2C2E; /* æ·±ç°ä¸»è‰² */
      --primary-light: #E5E5EA;
      --border: #E5E5EA;
      --danger: #FF3B30;
      --success: #34C759;
      --radius: 14px;
      --input-bg: #F2F2F7;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; font-family: -apple-system, BlinkMacSystemFont, "PingFang TC", "Microsoft JhengHei", sans-serif; }
    
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding-top: env(safe-area-inset-top);
      padding-bottom: calc(90px + env(safe-area-inset-bottom));
    }

    /* SVG Icons */
    .icon { width: 22px; height: 22px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .icon-sm { width: 16px; height: 16px; }
    .icon-fill { fill: currentColor; stroke: none; }

    /* Navigation */
    .nav {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      border-radius: 40px;
      padding: 8px 12px;
      display: flex;
      gap: 4px;
      z-index: 100;
      width: auto;
      min-width: 300px;
      justify-content: space-between;
      border: 1px solid rgba(255,255,255,0.5);
    }
    
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 12px;
      color: var(--text-light);
      text-decoration: none;
      font-size: 10px;
      font-weight: 500;
      border-radius: 24px;
      transition: all 0.2s ease;
    }
    
    .nav-item.active {
      color: var(--card);
      background: var(--primary);
    }
    
    /* Layout */
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 24px 20px;
      width: 100%;
      flex: 1;
      overflow-y: auto;
    }
    
    section[hidden] { display: none; }
    
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.03);
      margin-bottom: 20px;
      border: 1px solid white;
    }

    .group-title {
      font-size: 13px;
      color: var(--text-light);
      margin: 24px 4px 8px;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    /* Form Elements */
    .big-input-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 30px 0;
      position: relative;
    }
    
    .currency-symbol {
      font-size: 24px;
      color: var(--text-light);
      margin-right: 8px;
      margin-top: 8px;
    }
    
    .big-input {
      border: none;
      background: transparent;
      text-align: center;
      font-size: 52px;
      font-weight: 300;
      color: var(--text);
      width: 200px;
      padding: 0;
      margin: 0;
      font-family: -apple-system, monospace;
      letter-spacing: -1px;
    }
    
    .input-row {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      background: var(--input-bg);
      border-radius: 12px;
      padding: 4px 16px;
      min-height: 56px;
      transition: background 0.2s;
    }
    
    .input-row:focus-within {
      background: #E5E5EA;
    }

    .row-label {
      width: 70px;
      font-size: 14px;
      color: var(--text-light);
      font-weight: 500;
      flex-shrink: 0;
    }
    
    .row-input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 16px;
      color: var(--text);
      text-align: right;
      width: 100%;
      padding: 12px 0;
      font-weight: 400;
    }
    
    select.row-input {
      appearance: none;
      /* Custom Arrow SVG */
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right center;
      padding-right: 20px;
    }

    /* Buttons */
    .btn-main {
      background: var(--primary);
      color: white;
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      margin-top: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: opacity 0.2s;
    }
    
    .btn-main:active { opacity: 0.8; }
    
    .btn-ghost {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .cam-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
    }

    /* Segment Control */
    .seg-control {
      display: flex;
      background: var(--input-bg);
      border-radius: 10px;
      padding: 3px;
      margin: 0 0 20px;
    }
    
    .seg-item {
      flex: 1;
      text-align: center;
      padding: 8px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 8px;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .seg-item.active {
      background: var(--card);
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      color: var(--text);
    }
    
    .seg-item[data-val="æ”¯å‡º"].active { color: var(--danger); font-weight: 600; }
    .seg-item[data-val="æ”¶å…¥"].active { color: var(--success); font-weight: 600; }

    /* Switch */
    .switch { position: relative; display: inline-block; width: 44px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E5E5EA; transition: .3s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input:checked + .slider { background-color: var(--primary); }
    input:checked + .slider:before { transform: translateX(18px); }

    /* Records */
    .record-item {
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .record-item:last-child { border-bottom: none; }
    
    .rec-left { display: flex; flex-direction: column; gap: 4px; }
    .rec-title { font-size: 15px; font-weight: 500; color: var(--text); display: flex; align-items: center; gap: 6px; }
    .rec-meta { font-size: 12px; color: var(--text-light); display: flex; gap: 8px; }
    .rec-tag { background: var(--input-bg); padding: 2px 6px; border-radius: 4px; }
    .rec-dates { font-size: 11px; color: #C7C7CC; margin-top: 2px; }
    
    .rec-amt { font-size: 16px; font-weight: 600; font-family: -apple-system, monospace; }
    .rec-amt.neg { color: var(--text); } 
    .rec-amt.pos { color: var(--success); }

    /* Image Preview */
    .img-preview-area { display: flex; gap: 12px; overflow-x: auto; padding: 12px 0; }
    .img-thumb { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; border: 1px solid var(--border); flex-shrink: 0; }
    .img-thumb-wrap { position: relative; }
    .img-del {
      position: absolute; top: -6px; right: -6px;
      background: var(--danger); color: white;
      width: 18px; height: 18px; border-radius: 50%;
      font-size: 12px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
      z-index: 999; display: none; justify-content: center; align-items: flex-end;
    }
    .modal-overlay.open { display: flex; }
    .modal-card {
      background: #F2F2F7;
      width: 100%; max-width: 600px;
      border-radius: 24px 24px 0 0;
      padding: 24px;
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      max-height: 90vh; overflow-y: auto;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* Utility */
    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-50px);
      background: rgba(44, 44, 46, 0.9); backdrop-filter: blur(8px);
      color: white; padding: 12px 24px; border-radius: 30px;
      font-size: 14px; font-weight: 500;
      opacity: 0; transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events: none; z-index: 2000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    
    .split-btn-icon { color: var(--text-light); cursor: pointer; padding: 4px; transition: 0.2s; }
    .split-btn-icon.active { color: var(--primary); }

    /* Version Log */
    #verLog {
      font-size: 13px; color: var(--text); background: white;
      padding: 20px; border-radius: 12px; line-height: 1.6;
      max-height: 200px; overflow-y: auto; margin-top: 12px;
      display: none; text-align: left; border: 1px solid var(--border);
    }
    #verLog ul { padding-left: 20px; margin: 0; }
    #verLog li { margin-bottom: 8px; }
    .ver-date { font-size: 11px; color: var(--text-light); margin-right: 8px; background: var(--input-bg); padding: 2px 6px; border-radius: 4px; font-family: monospace; }
    
    .footer { text-align: center; margin-top: 40px; padding-bottom: 20px; color: var(--text-light); font-size: 12px; }
    .ver-badge { background: #E5E5EA; padding: 2px 8px; border-radius: 6px; font-weight: 500; font-size: 10px; color: var(--text-light); }
  </style>
</head>
<body>

  <nav class="nav">
    <a href="#home" class="nav-item active" onclick="routeClick('home')">
      <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
      <span>è¨˜å¸³</span>
    </a>
    <a href="#recent" class="nav-item" onclick="routeClick('recent')">
      <svg class="icon" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
      <span>æ˜ç´°</span>
    </a>
    <a href="#balance" class="nav-item" onclick="routeClick('balance')">
      <svg class="icon" viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
      <span>è³‡ç”¢</span>
    </a>
    <a href="#settings" class="nav-item" onclick="routeClick('settings')">
      <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
      <span>è¨­å®š</span>
    </a>
  </nav>

  <section data-view="home" class="container">
    <form id="form" autocomplete="off">
      <select id="direction" style="display:none"><option>æ”¯å‡º</option><option>æ”¶å…¥</option></select>
      
      <div class="card" style="padding-top: 24px; border:none;">
        <div class="seg-control">
          <div class="seg-item active" data-val="æ”¯å‡º" onclick="setDirection('æ”¯å‡º')">æ”¯å‡º</div>
          <div class="seg-item" data-val="æ”¶å…¥" onclick="setDirection('æ”¶å…¥')">æ”¶å…¥</div>
        </div>

        <div class="big-input-wrapper">
          <span class="currency-symbol">$</span>
          <input type="number" id="amount" class="big-input" placeholder="0" step="0.01" inputmode="decimal" oninput="saveDraft()">
          <label class="cam-btn" style="position:absolute; right:10px;">
            <svg class="icon" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="12" r="4"></circle></svg>
            <input type="file" id="imgInput" accept="image/*" multiple style="display:none">
          </label>
        </div>

        <div class="input-row"><span class="row-label">æ—¥æœŸ</span><input type="date" id="date" class="row-input" required onchange="saveDraft()"></div>
        <div class="input-row"><span class="row-label">åˆ†é¡</span><select id="category" class="row-input" onchange="renderItems()"><option value="">é¸æ“‡åˆ†é¡</option></select></div>
        
        <div class="input-row"><span class="row-label">é …ç›®</span>
          <div style="flex:1; display:flex; flex-direction:column; align-items:flex-end;">
            <select id="itemSelect" class="row-input" onchange="renderSubItems()"><option value="">é¸æ“‡é …ç›®</option></select>
            <input id="itemInput" class="row-input" placeholder="è¼¸å…¥é …ç›®" style="display:none; border-bottom:1px dashed #ccc; margin-top:4px;" oninput="saveDraft()">
          </div>
        </div>
        
        <div class="input-row"><span class="row-label">ç´°é …</span>
          <div style="flex:1; display:flex; flex-direction:column; align-items:flex-end;">
            <select id="subSelect" class="row-input" onchange="checkCustomInput('sub')"><option value="">é¸æ“‡ç´°é …</option></select>
            <input id="subInput" class="row-input" placeholder="è¼¸å…¥ç´°é …" style="display:none; border-bottom:1px dashed #ccc; margin-top:4px;" oninput="saveDraft()">
          </div>
        </div>

        <div class="input-row"><span class="row-label">å¸³æˆ¶</span>
          <select id="account" class="row-input" onchange="saveDraft()">
            <option value="">é¸æ“‡å¸³æˆ¶</option>
            <option>é»ƒç¾é‡‘</option><option>è•­ç¾é‡‘</option>
            <option>åˆä½œé‡‘åº«</option><option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option>
            <option>é»ƒéƒµå±€</option><option>è•­LINE</option><option>å½°åŒ–éŠ€è¡Œ</option>
            <option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option>
            <option>è•­ä¸­ä¿¡</option><option>è¯å—å¡</option><option>åœ‹æ³°å¡</option><option>è¯é‚¦å¡</option>
          </select>
        </div>
        
        <div class="input-row"><span class="row-label">å‚™è¨»</span><input id="note" class="row-input" placeholder="é¸å¡«" oninput="saveDraft()"></div>
        
        <div class="input-row" style="justify-content:space-between;"><span class="row-label">å¸³æˆ¶äº’è½‰</span><label class="switch"><input type="checkbox" id="isTransfer" onchange="saveDraft()"><span class="slider"></span></label></div>
        <div id="transferFields" class="input-row" style="display:none;background:#F1F5F9;border:1px solid #E5E5EA;"><span class="row-label" style="color:var(--primary)">è½‰å…¥è‡³</span><select id="accountIn" class="row-input" onchange="saveDraft()"><option value="">é¸æ“‡è½‰å…¥å¸³æˆ¶</option><option>é»ƒç¾é‡‘</option><option>è•­ç¾é‡‘</option><option>åˆä½œé‡‘åº«</option><option>è•­éƒµå±€</option><option>è¯å—éŠ€è¡Œ</option><option>é»ƒéƒµå±€</option><option>è•­LINE</option><option>å½°åŒ–éŠ€è¡Œ</option><option>é»ƒä¸­ä¿¡</option><option>é»ƒLINE</option><option>åœ‹æ³°ä¸–è¯</option><option>è•­ä¸­ä¿¡</option><option>è¯å—å¡</option><option>åœ‹æ³°å¡</option><option>è¯é‚¦å¡</option></select></div>
        
        <div id="imgPreview" class="img-preview-area" style="display:none"></div>
      </div>

      <div id="splitSection" style="display:none"><div class="group-title">åˆ†å¸³é è¦½</div><div class="card" style="padding:10px;"><div id="splitList"></div></div></div>
      <div style="display:flex;gap:12px;">
        <button class="btn-main btn-ghost" type="button" id="btnAddSplit">
           <svg class="icon icon-sm" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
           åˆ†å¸³
        </button>
        <button class="btn-main" type="submit" id="btnSubmit">
           <svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
           ç¢ºèªå„²å­˜
        </button>
      </div>
      
      <div class="group-title">æœ¬æ©Ÿæš«å­˜ç´€éŒ„</div>
      <div class="card">
        <div class="log" id="log" style="max-height:200px;overflow:auto;"></div>
        <div style="padding:12px;text-align:center;border-top:1px solid var(--border);"><span id="btnClear" style="color:var(--text-light);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;"><svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> æ¸…é™¤ç´€éŒ„</span></div>
      </div>
      <div class="footer"><span class="ver-badge">v6.2</span><div style="margin-top:6px;">Minimalist Design</div></div>
    </form>
  </section>

  <input type="file" id="splitImgInput" accept="image/*" multiple style="display:none">
  <input type="file" id="modalImgInput" accept="image/*" multiple style="display:none">

  <section data-view="recent" class="container" hidden>
    <div class="card" style="padding:16px;">
      <div style="display:flex;gap:8px;margin-bottom:12px;">
         <input type="number" id="rLimit" value="10" class="row-input" style="background:var(--input-bg);border-radius:8px;padding:8px;text-align:center;font-size:14px;" placeholder="ç­†æ•¸">
         <select id="rCategory" class="row-input" style="background:var(--input-bg);border-radius:8px;padding:0 8px;font-size:14px;"><option value="">å…¨éƒ¨åˆ†é¡</option></select>
      </div>
      <button class="btn-main" id="btnRecent" type="button" style="margin:0;padding:12px;background:var(--card);color:var(--text);border:1px solid var(--border);">
         <svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> åˆ·æ–°åˆ—è¡¨
      </button>
    </div>
    <div id="recentList" style="padding-bottom:20px;"></div>
  </section>

  <section data-view="balance" class="container" hidden>
    <div class="card" style="padding:16px;">
       <h2 style="margin:0 0 16px;font-size:16px;color:var(--text);font-weight:600;">ç•¶ä¸‹è³‡ç”¢ç¸½è¦½</h2>
       <button class="btn-main" id="btnBalance" type="button" style="margin-top:0;padding:12px;background:var(--primary);">æŸ¥è©¢æ‰€æœ‰é¤˜é¡</button>
    </div>
    <div class="card" id="balanceArea" style="display:none;padding:24px;">
       <div style="text-align:center;margin-bottom:24px;">
         <div style="font-size:12px;color:var(--text-light);margin-bottom:4px;">æ·¨è³‡ç”¢ç¸½è¨ˆ</div>
         <div id="balanceTotal" style="font-size:40px;font-weight:300;color:var(--text);font-family:-apple-system, monospace;">0.00</div>
       </div>
       <div id="balanceListContainer"></div>
    </div>
  </section>

  <section data-view="settings" class="container" hidden>
    <div style="text-align:center; margin-top:30px;">
      <button onclick="toggleLog()" style="background:none; border:none; color:var(--text-light); font-size:13px; cursor:pointer; padding:10px; display:flex; align-items:center; justify-content:center; gap:6px; margin:0 auto;">
         <svg class="icon icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> ç‰ˆæœ¬ç´€éŒ„
      </button>
      <div id="verLog">
        <ul>
          <li><span class="ver-date">2026-02-05</span><strong>v6.2:</strong> ä»‹é¢æ¥µç°¡åŒ–èˆ‡å» Emoji å„ªåŒ–ã€‚</li>
          <li><span class="ver-date">2026-02-02</span><strong>v6.2:</strong> æ–°å¢ã€Œè•­ä¸­ä¿¡ã€å¸³æˆ¶ã€‚</li>
          <li><span class="ver-date">2026-02-02</span><strong>v6.1:</strong> ç·¨è¼¯è¦–çª—æ”¯æ´ä¸‹æ‹‰é¸å–®èˆ‡ç…§ç‰‡ä¸Šå‚³ï¼Œæ˜ç´°æ—¥æœŸé¡¯ç¤ºå„ªåŒ–ã€‚</li>
        </ul>
      </div>
    </div>
    <div class="group-title">é€£ç·šè¨­å®š</div>
    <div class="card">
      <div class="input-row"><span class="row-label">API URL</span><input id="endpoint" class="row-input" value="https://script.google.com/macros/s/AKfycbzjpwoEGtRpX9FnQ0i-rSjvgaUB40gG44tBAcd_tI30R1X9HydICtdlSiooJXViatJZ/exec"></div>
      <div class="input-row"><span class="row-label">API Key</span><input id="apiKey" class="row-input" placeholder="é¸å¡«"></div>
      <div style="display:flex;padding:16px 0 0;gap:12px;"><button id="btnTest" style="flex:1;padding:12px;background:var(--input-bg);border:none;border-radius:10px;color:var(--text);font-weight:500;">æ¸¬è©¦é€£ç·š</button><button id="btnSaveCfg" style="flex:1;padding:12px;background:var(--primary);color:#fff;border:none;border-radius:10px;font-weight:500;">å„²å­˜è¨­å®š</button></div>
    </div>
    <div class="group-title">Gmail åŒ¯å…¥</div>
    <div class="card" style="padding:16px;">
      <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center;"><input id="importDays" type="number" value="10" class="row-input" style="background:var(--input-bg);border-radius:8px;padding:8px;text-align:center;width:80px;" placeholder="å¤©æ•¸"><div style="flex:1;display:flex;align-items:center;justify-content:flex-end;gap:8px;"><span style="font-size:13px;color:var(--text);">å¼·åˆ¶é‡æŠ“</span><label class="switch" style="transform:scale(0.8);"><input type="checkbox" id="importForce"><span class="slider"></span></label></div></div>
      <button class="btn-main" id="btnImport" type="button" style="margin:0;">é–‹å§‹æŠ“å–å¸³å–®</button>
      <div id="importHint" style="text-align:center;font-size:12px;color:var(--text-light);margin-top:12px;">â€”</div>
    </div>
  </section>

  <div id="editModal" class="modal-overlay"><div class="modal-card"><div style="display:flex;justify-content:space-between;margin-bottom:20px;align-items:center;"><h3 style="margin:0;font-size:18px;">ç·¨è¼¯ç´€éŒ„</h3><span onclick="closeEditModal()" style="font-size:24px;cursor:pointer;color:var(--text-light);">&times;</span></div><div id="modalContent"></div></div></div>
  <div id="toast" class="toast">è¨Šæ¯</div>

<script>
const MENU_DATA = {
  "å…±ç”¨": { 
    "æ°´é›»è²»": ["é›»è²»","æ°´è²»","ç“¦æ–¯è²»"], 
    "äº¤é€š": ["æ±½è»Šæ²¹è³‡","æ±½è»Šä¿é¤Š","ä¿éšª","æ´—è»Š","åœè»Šè²»","ç½°å–®","æ©Ÿè»Šæ²¹è³‡","æ©Ÿè»Šä¿é¤Š"], 
    "æˆ¿ç§Ÿ": ["æˆ¿ç§Ÿ"], 
    "ç©æ¨‚": ["è¡Œç¨‹","ä½å®¿"], 
    "é£Ÿç‰©": ["å‡æ—¥æ—©é¤","å‡æ—¥åˆé¤","å‡æ—¥æ™šé¤","å¹³æ—¥æ—©é¤","å¹³æ—¥åˆé¤","å¹³æ—¥æ™šé¤","æ°´æœ","é£²æ–™","é»å¿ƒ"], 
    "å®¶ç”¨å“": ["æ¶ˆè€—å“","éæ¶ˆè€—å“"], 
    "é›»è©±è²»": ["å°é¡æ”¯ä»˜","æœƒå“¡è²»","é›»è©±è²»"] 
  },
  "é»ƒæ”¯å‡º": { 
    "ç©æ¨‚": ["ç”¨å“","æœé£¾","ç©å…·","å­¸è²»"], 
    "é£Ÿç‰©": ["äººæƒ…å¾€ä¾†","å€‹äººåˆé¤","å€‹äººæ™šé¤","é£²æ–™","é»å¿ƒ"], 
    "å¥åº·": ["ä¿å¥å“","çœ‹è¨º","è—¥è²»"] 
  },
  "è•­æ”¯å‡º": { 
    "ç©æ¨‚": ["äººæƒ…å¾€ä¾†","ç”¨å“","æœé£¾","ç©å…·","ä¿é¤Šå“","æ›¸ç±"], 
    "é£Ÿç‰©": ["äººæƒ…å¾€ä¾†","å€‹äººæ™šé¤","å€‹äººåˆé¤","å€‹äººæ—©é¤","é£²æ–™"], 
    "å¥åº·": ["ä¿å¥å“","æ¸›é‡è—¥å“","çœ‹è¨º","è—¥è²»"] 
  },
  "æ´‹æ”¯å‡º": { 
    "é£Ÿç‰©": ["é›¶é£Ÿ","é£¼æ–™"],
    "ç©æ¨‚": ["ç©å…·","è¡£æœ","æ´—æ¾¡"]
  },
  "å…¬å¸ä»£å¢Š": { 
    "å…¬å¸ä»£å¢Š": ["å…¬å¸ä»£å¢Š"], 
    "é£Ÿç‰©": ["å…¬å¸åˆé¤"] 
  },
  "ä¿¡ç”¨å¡": { 
    "åœ‹æ³°ä¸–è¯": ["åœ‹æ³°ä¸–è¯"], 
    "è¯å—éŠ€è¡Œ": ["è¯å—éŠ€è¡Œ"], 
    "è¯é‚¦éŠ€è¡Œ": ["è¯é‚¦éŠ€è¡Œ"] 
  },
  "è² å‚µ": { 
    "ä¸­åœ‹ä¿¡è¨—": ["ä¸­åœ‹ä¿¡è¨—"], 
    "åœ‹æ³°ä¸–è¯": ["åœ‹æ³°ä¸–è¯"], 
    "åŒ¯è±": ["åŒ¯è±"], 
    "è£•è": ["è£•è"] 
  },
  "æ”¶å…¥": { 
    "æ¬£å®œçé‡‘": ["æ¬£å®œçé‡‘"], 
    "æ¬£å®œè–ªè³‡": ["æ¬£å®œè–ªè³‡"], 
    "ç§Ÿé‡‘è£œè²¼": ["ç§Ÿé‡‘è£œè²¼"], 
    "å–¬çŒ·è–ªè³‡": ["å–¬çŒ·è–ªè³‡"] 
  },
  "å¹³è¡¡": { 
    "å…§æ§äº’è½‰": ["å…§æ§äº’è½‰"] 
  },
  "å…¶ä»–": { 
    "åœ‹æ³°è­‰åˆ¸": ["åœ‹æ³°è­‰åˆ¸"] 
  }
};

let isSubmitting=false; let currentSplits=[]; let selectedImages=[]; let activeSplitIdx = -1; let modalSelectedImages = [];
const DRAFT_KEY='spend.draft.v6.0'; const SENT_KEY='spend.sent.v19'; 

/* Icons SVG Strings for JS Injection */
const ICONS = {
  cam: `<svg class="icon" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="12" r="4"></circle></svg>`,
  img: `<svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>`,
  del: `<svg class="icon icon-sm" viewBox="0 0 24 24" style="color:#FF3B30"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
  check: `<svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>`
};

function saveDraft(){
  const data = {
    amount: $('amount').value,
    date: $('date').value,
    category: $('category').value,
    itemIdx: $('itemSelect').selectedIndex,
    itemCustom: $('itemInput').value,
    subIdx: $('subSelect').selectedIndex,
    subCustom: $('subInput').value,
    account: $('account').value,
    note: $('note').value,
    isTransfer: $('isTransfer').checked,
    accountIn: $('accountIn').value,
    direction: $('direction').value
  };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
}

function loadDraft(){
  const d = JSON.parse(localStorage.getItem(DRAFT_KEY));
  if(!d) return;
  $('amount').value = d.amount;
  $('date').value = d.date || new Date().toISOString().slice(0,10);
  if(d.category){ $('category').value=d.category; renderItems(); }
  if(d.itemIdx>0){ $('itemSelect').selectedIndex=d.itemIdx; renderSubItems(); }
  if(d.itemCustom) $('itemInput').value=d.itemCustom;
  if(d.subIdx>0) $('subSelect').selectedIndex=d.subIdx;
  if(d.subCustom) $('subInput').value=d.subCustom;
  $('account').value = d.account;
  $('note').value = d.note;
  if(d.direction) setDirection(d.direction);
  if(d.isTransfer){ 
    $('isTransfer').checked=true; 
    $('transferFields').style.display='flex'; 
    $('accountIn').value = d.accountIn;
    // è§¸ç™¼ä¸€æ¬¡äº’è½‰çš„é–å®šé‚è¼¯
    $('category').value='å¹³è¡¡'; $('category').disabled=true; 
  }
  checkCustomInput('item'); checkCustomInput('sub');
}

window.addEventListener('DOMContentLoaded', () => {
  $('date').value=new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
  loadCfg(); renderCategories(); 
  loadDraft();
  renderLog(); route();
});

const $ = id => document.getElementById(id);
const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };
function getDeviceType() {
  let id = localStorage.getItem('spend.deviceId');
  if(!id) { id = Math.random().toString(36).substring(2,6).toUpperCase(); localStorage.setItem('spend.deviceId', id); }
  const ua = navigator.userAgent; let os='Web'; if(/iPhone|iPad/.test(ua)) os='iOS'; else if(/Android/.test(ua)) os='Android';
  return `${os} #${id}`;
}
function routeClick(name) { location.hash = '#' + name; }
function showView(name){ document.querySelectorAll('section[data-view]').forEach(sec=>sec.hidden = sec.dataset.view !== name); document.querySelectorAll('.nav-item').forEach(a => a.classList.toggle('active', a.getAttribute('href') === '#' + name)); }
function route(){ const name=(location.hash||'#home').slice(1); showView(['home','recent','balance','settings'].includes(name)?name:'home'); }
window.addEventListener('hashchange', route);
function toggleLog(){ const l=$('verLog'); l.style.display = l.style.display==='block'?'none':'block'; }

/* ğŸ§  Cascade Logic */
function renderCategories() {
  const catSel = $('category'); const rCat = $('rCategory');
  const cats = Object.keys(MENU_DATA);
  const opts = `<option value="">é¸æ“‡åˆ†é¡</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  catSel.innerHTML = opts; rCat.innerHTML = `<option value="">å…¨éƒ¨åˆ†é¡</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
}
function renderItems() {
  const cat = $('category').value;
  const itemSel = $('itemSelect');
  itemSel.innerHTML = `<option value="">é¸æ“‡é …ç›®</option>`;
  $('itemInput').style.display = 'none'; $('subSelect').innerHTML = `<option value="">é¸æ“‡ç´°é …</option>`; $('subInput').style.display = 'none';
  if (cat && MENU_DATA[cat]) {
    const items = Object.keys(MENU_DATA[cat]);
    itemSel.innerHTML += items.map(i=>`<option value="${i}">${i}</option>`).join('') + `<option value="å…¶ä»–">å…¶ä»–...</option>`;
  }
}
function renderSubItems() {
  const cat = $('category').value; const item = $('itemSelect').value; const subSel = $('subSelect');
  subSel.innerHTML = `<option value="">é¸æ“‡ç´°é …</option>`; $('subInput').style.display = 'none';
  if (item === 'å…¶ä»–') {
    $('itemInput').style.display = 'block';
    subSel.innerHTML += `<option value="å…¶ä»–">å…¶ä»–...</option>`;
  } else {
    $('itemInput').style.display = 'none';
    if (cat && MENU_DATA[cat] && MENU_DATA[cat][item]) {
      const subs = MENU_DATA[cat][item];
      subSel.innerHTML += subs.map(s=>`<option value="${s}">${s}</option>`).join('') + `<option value="å…¶ä»–">å…¶ä»–...</option>`;
    }
  }
}
function checkCustomInput(type) {
  const sel = $(type + 'Select'); const inp = $(type + 'Input');
  inp.style.display = sel.value === 'å…¶ä»–' ? 'block' : 'none';
}
function getFinalValues() {
  const cat = $('category').value;
  const itemSel = $('itemSelect').value; const item = itemSel === 'å…¶ä»–' ? $('itemInput').value : itemSel;
  const subSel = $('subSelect').value; const sub = subSel === 'å…¶ä»–' ? $('subInput').value : subSel;
  return { cat, item, sub };
}

/* Image */
$('imgInput').onchange = async function(e) { handleImg(e, selectedImages, renderImgPreview); };
$('modalImgInput').onchange = async function(e) { handleImg(e, modalSelectedImages, renderModalImgPreview); };
async function handleImg(e, arr, renderFn){
  const files = e.target.files; if (!files || files.length===0) return;
  for (let i=0; i<files.length; i++) arr.push(await compressImage(files[i]));
  renderFn(); e.target.value='';
}

function renderImgPreview() {
  const div=$('imgPreview'); div.style.display = selectedImages.length?'flex':'none';
  div.innerHTML = selectedImages.map((s,i)=>`<div class="img-thumb-wrap"><img src="${s}" class="img-thumb"><div class="img-del" onclick="removeImg(${i})">Ã—</div></div>`).join('');
}
function renderModalImgPreview() {
  const div=$('m-imgPreview'); if(!div) return; div.style.display = modalSelectedImages.length?'flex':'none';
  div.innerHTML = modalSelectedImages.map((s,i)=>`<div class="img-thumb-wrap"><img src="${s}" class="img-thumb"><div class="img-del" onclick="removeModalImg(${i})">Ã—</div></div>`).join('');
}

window.removeImg=(i)=>{selectedImages.splice(i,1);renderImgPreview();};
window.removeModalImg=(i)=>{modalSelectedImages.splice(i,1);renderModalImgPreview();};

window.attachSplitImg = (idx) => { activeSplitIdx = idx; $('splitImgInput').click(); };
$('splitImgInput').onchange = async function(e) {
  if (activeSplitIdx<0 || !currentSplits[activeSplitIdx]) return;
  const files=e.target.files; if(!files.length) return;
  if(!currentSplits[activeSplitIdx].images) currentSplits[activeSplitIdx].images=[];
  for(let i=0; i<files.length; i++) currentSplits[activeSplitIdx].images.push(await compressImage(files[i]));
  renderSplits(); this.value=''; activeSplitIdx=-1;
};
function compressImage(file){
  return new Promise((r)=>{ const reader=new FileReader(); reader.readAsDataURL(file); reader.onload=(e)=>{ const img=new Image(); img.src=e.target.result; img.onload=()=>{ const cvs=document.createElement('canvas'); const scale=800/img.width; cvs.width=800; cvs.height=img.height*scale; cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height); r(cvs.toDataURL('image/jpeg',0.6)); } } });
}

/* Core */
function resetForm() {
  localStorage.removeItem(DRAFT_KEY); 
  currentSplits = []; selectedImages = []; renderImgPreview();
  $('splitList').innerHTML = ''; $('splitSection').style.display = 'none'; $('btnSubmit').innerHTML = `${ICONS.check} ç¢ºèªå„²å­˜`;
  $('date').disabled = false; $('account').disabled = false;
  $('amount').value = ''; $('category').value = ''; renderItems(); 
  $('account').value = ''; $('note').value = ''; $('subSelect').value = ''; $('subInput').value = '';
  if($('isTransfer').checked) { $('isTransfer').checked = false; $('transferFields').style.display='none'; $('category').disabled = false; }
}

function setDirection(val) { $('direction').value = val; document.querySelectorAll('.seg-item').forEach(el => el.classList.toggle('active', el.dataset.val === val)); }
$('isTransfer').onchange = ()=>{
  const on = $('isTransfer').checked; $('transferFields').style.display = on ? 'flex' : 'none';
  if (on){ $('category').value='å¹³è¡¡'; $('category').disabled=true; renderItems(); $('itemSelect').value='å…§æ§äº’è½‰'; renderSubItems(); $('subSelect').value='å…§æ§äº’è½‰'; $('direction').value='æ”¯å‡º'; if(currentSplits.length>0){toast('äº’è½‰å·²æ¸…é™¤');currentSplits=[];renderSplits();} } 
  else { $('category').disabled=false; }
};
function renderSplits() {
  const btnSubmit = $('btnSubmit'); const listDiv = $('splitList'); const section = $('splitSection');
  if (currentSplits.length === 0) { section.style.display = 'none'; listDiv.innerHTML = ''; btnSubmit.innerHTML = `${ICONS.check} ç¢ºèªå„²å­˜`; $('date').disabled = false; $('account').disabled = false; return; }
  section.style.display = 'block'; let html = ''; let total = 0;
  currentSplits.forEach((s, i) => { 
    const isOut = s.direction === 'æ”¯å‡º'; total += (isOut?1:-1)*s.amount; 
    const hasImg = s.images && s.images.length > 0;
    html += `<div class="record-item"><div class="rec-left"><div class="rec-title">${s.category} - ${s.item}</div><div class="rec-meta">${s.subItem||''}</div></div><div class="rec-right"><span class="rec-amt ${isOut?'neg':'pos'}">${s.amount}</span><span class="split-btn-icon ${hasImg?'active':''}" onclick="attachSplitImg(${i})">${hasImg?ICONS.img:ICONS.cam}</span><span style="margin-left:8px;cursor:pointer" onclick="delSplit(${i})">${ICONS.del}</span></div></div>`; 
  });
  listDiv.innerHTML = html; btnSubmit.textContent = `é€å‡º ${currentSplits.length} ç­†åˆ†å¸³`; $('date').disabled = true; $('account').disabled = true;
}
window.delSplit = (i) => { currentSplits.splice(i, 1); renderSplits(); };
$('btnAddSplit').onclick = () => {
  const { cat, item, sub } = getFinalValues();
  const amt = Number($('amount').value || 0); 
  if (!cat || !item) return toast('è«‹å¡«å¯«åˆ†é¡èˆ‡é …ç›®');
  if (!amt) return toast('è«‹è¼¸é‡‘é¡');
  currentSplits.push({ amount: amt, category: cat, item: item, subItem: sub, note: $('note').value.trim(), direction: $('direction').value, images: [] });
  renderSplits(); $('amount').value = ''; $('note').value = ''; $('subItem').value = ''; $('amount').focus();
};

$('form').onsubmit = (e) => {
  e.preventDefault(); if (isSubmitting) return;
  const { cat, item, sub } = getFinalValues();
  const amt = Number($('amount').value); const isXfer = $('isTransfer').checked;
  if (!$('account').value) return toast('è«‹é¸æ“‡å¸³æˆ¶');
  if (isXfer && !$('accountIn').value) return toast('è«‹é¸æ“‡è½‰å…¥å¸³æˆ¶');
  if (currentSplits.length === 0) {
    if (!amt) return toast('è«‹è¼¸å…¥é‡‘é¡');
    if (!isXfer && (!cat || !item)) return toast('è«‹å®Œæ•´å¡«å¯«åˆ†é¡/é …ç›®');
  }
  
  isSubmitting = true; const btn = $('btnSubmit'); const ot = btn.innerHTML; btn.textContent = 'è™•ç†ä¸­...'; btn.disabled = true;
  const norm = s => s.replace(/^åˆä½œ$/,'åˆä½œé‡‘åº«').replace(/^è•­è³´$/,'è•­LINE');
  
  const payload = { 
    date: $('date').value, account: norm($('account').value), apiKey: $('apiKey').value.trim(), device: getDeviceType(), images: selectedImages,
    category: cat, item: item, subItem: sub, amount: amt, note: $('note').value, direction: $('direction').value
  };
  if(isXfer) { payload.isTransfer = 'true'; payload.accountIn = norm($('accountIn').value); }
  if(currentSplits.length > 0) { payload.action = 'split_add'; payload.splits_json = JSON.stringify(currentSplits); }
  
  const ts = new Date().toLocaleString('sv').replace(' ','T');
  if(currentSplits.length) currentSplits.forEach(s=>addSent({ts, ...s, account:payload.account}));
  else addSent({ts, ...payload});

  fetch($('endpoint').value, { method: 'POST', body: JSON.stringify(payload) })
  .then(r=>r.json()).then(d=>{
    if(d.ok) { toast('âœ… å®Œæˆ'); renderLog(); setTimeout(resetForm, 300); }
    else toast('å¤±æ•—:'+d.error);
  }).finally(()=>{ isSubmitting=false; btn.disabled=false; btn.innerHTML=ot; });
};

function addSent(rec){ const l=JSON.parse(localStorage.getItem(SENT_KEY)||'[]'); l.push(rec); localStorage.setItem(SENT_KEY, JSON.stringify(l.slice(-50))); }
function renderLog(){ const l=JSON.parse(localStorage.getItem(SENT_KEY)||'[]').reverse(); $('log').innerHTML = l.length ? l.map(r=>{ const isOut=r.direction==='æ”¯å‡º'; return `<div class="record-item"><div class="rec-left"><div class="rec-title">${r.item} <small>${r.subItem||''}</small></div></div><div class="rec-right"><span class="rec-amt ${isOut?'neg':'pos'}">${r.amount}</span></div></div>`}).join('') : '<div style="text-align:center;padding:10px;color:#ccc;font-size:12px">ç„¡è³‡æ–™</div>'; }
$('btnClear').onclick=()=>{ localStorage.removeItem(SENT_KEY); renderLog(); };
function loadCfg(){ if(localStorage.getItem('spend.endpoint')) $('endpoint').value=localStorage.getItem('spend.endpoint'); if(localStorage.getItem('spend.apiKey')) $('apiKey').value=localStorage.getItem('spend.apiKey'); }
$('btnSaveCfg').onclick=()=>{ localStorage.setItem('spend.endpoint',$('endpoint').value); localStorage.setItem('spend.apiKey',$('apiKey').value); toast('è¨­å®šå·²å„²å­˜'); };
$('btnTest').onclick=()=>{ fetch($('endpoint').value+'?ping=1').then(r=>toast(r.ok?'âœ… é€£ç·šæˆåŠŸ':'âŒ é€£ç·šå¤±æ•—')).catch(()=>toast('âŒ é€£ç·šå¤±æ•—')); };
$('btnImport').onclick=async()=>{
  const ep=$('endpoint').value.trim();
  $('importHint').textContent='ç³»çµ±è™•ç†ä¸­...';
  try {
    const res = await fetch(ep, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:`action=ingest_gmail&days=${$('importDays').value}&force=${$('importForce').checked}&apiKey=${$('apiKey').value}`});
    const d = await res.json();
    if(d.ok) { toast(`æ–°å¢ ${d.added} ç­†`); $('importHint').textContent=`âœ… æˆåŠŸæ–°å¢ ${d.added} ç­†`; } else throw d;
  } catch(e) { $('importHint').textContent='âŒ è™•ç†å¤±æ•—'; }
};

/* æ˜ç´°èˆ‡è³‡ç”¢ */
$('btnBalance').onclick=async()=>{
  const ep=$('endpoint').value.trim(); if(!ep) return;
  const btn=$('btnBalance'); btn.textContent='è¨ˆç®—ä¸­...'; btn.disabled=true;
  $('balanceListContainer').innerHTML=''; $('balanceTotal').textContent='...'; $('balanceArea').style.display='block';
  try {
     const res=await fetch(ep+'?balance=1'); const d=await res.json();
     if(!d.ok) throw new Error(d.error||'Unknown Error');
     let h='';
     if(d.breakdown){
       d.breakdown.forEach(b=>{ h+=`<div style="display:flex;justify-content:space-between;padding:12px;border-bottom:1px solid #eee;font-size:15px;"><span style="color:var(--text)">${b.account}</span><span style="font-family:-apple-system, monospace;font-weight:600;">${b.balance.toFixed(2)}</span></div>`; });
       $('balanceListContainer').innerHTML=h; $('balanceTotal').textContent=d.total.toFixed(2);
     }
  } catch(e){ alert('æŸ¥è©¢å¤±æ•—: '+e.message); $('balanceListContainer').innerHTML='<div style="color:red;text-align:center">è¼‰å…¥å¤±æ•—</div>'; }
  btn.textContent='æŸ¥è©¢æ‰€æœ‰é¤˜é¡'; btn.disabled=false;
};

$('btnRecent').onclick=async()=>{
  const ep=$('endpoint').value.trim(); if(!ep) return;
  $('recentList').innerHTML='<div style="text-align:center;padding:20px;color:#999">è¼‰å…¥ä¸­...</div>';
  try {
    const p=new URLSearchParams({recent:$('rLimit').value});
    if($('rCategory').value) p.set('category',$('rCategory').value);
    const res=await fetch(ep+'?'+p); const d=await res.json();
    if(d.ok && d.records){
      let h='';
      d.records.forEach(r=>{
         const isOut=r.direction==='æ”¯å‡º';
         const photo=r.photos?`<a href="${r.photos.split('\n')[0]}" target="_blank" style="text-decoration:none;margin-left:4px;color:var(--text-light)">${ICONS.img}</a>`:'';
         h+=`<div class="card" style="padding:0;margin-bottom:12px;" onclick='openEditModal(${JSON.stringify(r)})'><div class="record-item" style="border:none;cursor:pointer;padding:16px;"><div class="rec-left"><div class="rec-title">${r.item} <small style="color:#999">${r.subItem||''}</small> ${photo}</div><div class="rec-meta"><span class="rec-tag">${r.category}</span><span class="rec-tag">${r.account}</span></div><div class="rec-dates">${r.date}</div></div><div class="rec-right"><span class="rec-amt ${isOut?'neg':'pos'}">${isOut?'-':''}${Math.abs(r.amount)}</span></div></div></div>`;
      });
      $('recentList').innerHTML=h||'<div style="text-align:center;color:#999">ç„¡è³‡æ–™</div>';
    } else { throw new Error(d.error || 'Server Error'); }
  } catch(e){ alert('è¼‰å…¥å¤±æ•—: '+e.message); $('recentList').innerHTML='è¼‰å…¥å¤±æ•—'; }
};

/* Edit Modal */
function openEditModal(r){
  const amt=Math.abs(Number(r.amount)); const isOut=r.direction==='æ”¯å‡º'; const isTransfer=(r.category==='å¹³è¡¡'&&r.item==='å…§æ§äº’è½‰');
  modalSelectedImages = [];
  
  let html=`<div class="big-input-wrapper"><span class="currency-symbol">$</span><input id="m-amt" type="number" class="big-input" value="${amt}">
     <label class="cam-btn" style="margin-left:8px;position:absolute;right:0;bottom:10px;">${ICONS.cam}</label>
     </div>
    <div class="input-row"><span class="row-label">åˆ†é¡</span><select id="m-cat" class="row-input" onchange="updateModalItems()">${makeOpts(CATEGORIES,r.category)}</select></div>
    <div class="input-row"><span class="row-label">é …ç›®</span><select id="m-item" class="row-input" onchange="updateModalSubItems()"></select></div>
    <div class="input-row"><span class="row-label">ç´°é …</span><select id="m-subItem" class="row-input"></select></div>
    <div class="input-row"><span class="row-label">å‚™è¨»</span><input id="m-note" class="row-input" value="${r.note||''}"></div>
    <div class="input-row"><span class="row-label">å¸³æˆ¶</span><select id="m-acc" class="row-input">${makeOpts(ACCOUNTS,r.account)}</select></div>
    <div id="m-imgPreview" class="img-preview-area" style="display:none;margin-top:10px;"></div>
    <div style="display:flex;gap:12px;margin-top:20px;"><button class="btn-main" onclick="saveModal('${r.createdAt}',${isTransfer},'${isOut?'æ”¯å‡º':'æ”¶å…¥'}')">å„²å­˜è®Šæ›´</button><button class="btn-main" style="background:#FFE5E5;color:var(--danger);box-shadow:none" onclick="delModal('${r.createdAt}')">åˆªé™¤ç´€éŒ„</button></div>`;
  $('modalContent').innerHTML=html; $('editModal').classList.add('open');
  
  // Init Cascading dropdowns
  updateModalItems(r.item);
  updateModalSubItems(r.subItem);
  
  // Bind camera
  $('modalContent').querySelector('.cam-btn').onclick = () => $('modalImgInput').click();
}

function updateModalItems(selectedItem) {
    const cat = $('m-cat').value; const itemSel = $('m-item');
    let opts = '';
    if(cat && MENU_DATA[cat]){
       opts = Object.keys(MENU_DATA[cat]).map(i=>`<option value="${i}">${i}</option>`).join('');
    }
    // If original item is not in list (e.g. custom text), add it temporarily
    if(selectedItem && (!cat || !MENU_DATA[cat] || !MENU_DATA[cat][selectedItem])){
       opts = `<option value="${selectedItem}">${selectedItem}</option>` + opts;
    }
    itemSel.innerHTML = `<option value="">é¸æ“‡</option>` + opts;
    if(selectedItem) itemSel.value = selectedItem;
}

function updateModalSubItems(selectedSub) {
    const cat = $('m-cat').value; const item = $('m-item').value; const subSel = $('m-subItem');
    let opts = '';
    if(cat && MENU_DATA[cat] && MENU_DATA[cat][item]){
       opts = MENU_DATA[cat][item].map(s=>`<option value="${s}">${s}</option>`).join('');
    }
    if(selectedSub && (!cat || !MENU_DATA[cat] || !MENU_DATA[cat][item] || !MENU_DATA[cat][item].includes(selectedSub))){
       opts = `<option value="${selectedSub}">${selectedSub}</option>` + opts;
    }
    subSel.innerHTML = `<option value="">é¸æ“‡</option>` + opts;
    if(selectedSub) subSel.value = selectedSub;
}

function closeEditModal(){ $('editModal').classList.remove('open'); }
function makeOpts(l,s){ return l.map(v=>`<option value="${v}" ${v===s?'selected':''}>${v}</option>`).join(''); }

async function saveModal(key,isTransfer,dir){
  const amt=$('m-amt').value; if(!amt) return toast('è«‹è¼¸é‡‘é¡');
  const payload={
    action:'update', createdAt:key, amount:amt,
    note:$('m-note').value, account:$('m-acc').value,
    category:$('m-cat').value, item:$('m-item').value, subItem:$('m-subItem').value,
    apiKey:$('apiKey').value.trim(), images: modalSelectedImages
  };
  if(!isTransfer) payload.direction=dir;
  closeEditModal(); toast('æ›´æ–°ä¸­...');
  try{ await fetch($('endpoint').value.trim(),{method:'POST',body:JSON.stringify(payload)}); toast('å·²æ›´æ–°'); $('btnRecent').click(); }catch(e){ toast('æ›´æ–°å¤±æ•—'); }
}
function delModal(key){ if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—?')){ closeEditModal(); fetch($('endpoint').value,{method:'POST',body:`action=delete&createdAt=${key}&apiKey=${$('apiKey').value}`}).then(()=>{toast('å·²åˆªé™¤');$('btnRecent').click();}); } }

const ACCOUNTS=['é»ƒç¾é‡‘','è•­ç¾é‡‘','åˆä½œé‡‘åº«','è•­éƒµå±€','è¯å—éŠ€è¡Œ','é»ƒéƒµå±€','è•­LINE','å½°åŒ–éŠ€è¡Œ','é»ƒä¸­ä¿¡','é»ƒLINE','åœ‹æ³°ä¸–è¯','è•­ä¸­ä¿¡','è¯å—å¡','åœ‹æ³°å¡','è¯é‚¦å¡'];
const CATEGORIES=['å…±ç”¨','é»ƒæ”¯å‡º','è•­æ”¯å‡º','æ´‹æ”¯å‡º','å…¬å¸ä»£å¢Š','ä¿¡ç”¨å¡','è² å‚µ','æ”¶å…¥','å¹³è¡¡','å…¶ä»–'];
</script>
</body>
</html>
